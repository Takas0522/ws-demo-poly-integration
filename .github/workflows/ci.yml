name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # ========================================
  # Frontend CI (Next.js)
  # ========================================
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./src/front
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ./src/front/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run TypeScript check
        run: npx tsc --noEmit
      
      - name: Build Next.js application
        run: npm run build
        env:
          NEXT_PUBLIC_AUTH_SERVICE_URL: http://localhost:8001
          NEXT_PUBLIC_TENANT_SERVICE_URL: http://localhost:8002
          NEXT_PUBLIC_SERVICE_SETTING_URL: http://localhost:8003
          JWT_SECRET: ci-test-secret-key-do-not-use-in-production
  
  # ========================================
  # Backend Services CI (Python/FastAPI)
  # ========================================
  backend-auth-service-ci:
    name: Auth Service CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./src/auth-service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ./src/auth-service/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov flake8 black
      
      - name: Run Black (Code Formatter Check)
        run: black --check .
        continue-on-error: true
      
      - name: Run Flake8 (Linter)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true
      
      - name: Run Tests
        run: pytest tests/ -v --cov=app --cov-report=term-missing
        if: always()
        continue-on-error: true
      
      - name: Python syntax check
        run: python -m py_compile app/**/*.py
  
  backend-tenant-service-ci:
    name: Tenant Service CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./src/tenant-management-service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ./src/tenant-management-service/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov flake8 black
      
      - name: Run Black (Code Formatter Check)
        run: black --check .
        continue-on-error: true
      
      - name: Run Flake8 (Linter)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true
      
      - name: Run Tests
        run: pytest tests/ -v --cov=app --cov-report=term-missing
        if: always()
        continue-on-error: true
      
      - name: Python syntax check
        run: python -m py_compile app/**/*.py
  
  backend-service-setting-ci:
    name: Service Setting CI
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./src/service-setting-service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ./src/service-setting-service/requirements.txt
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov flake8 black
      
      - name: Run Black (Code Formatter Check)
        run: black --check .
        continue-on-error: true
      
      - name: Run Flake8 (Linter)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true
      
      - name: Run Tests
        run: pytest tests/ -v --cov=app --cov-report=term-missing
        if: always()
        continue-on-error: true
      
      - name: Python syntax check
        run: python -m py_compile app/**/*.py
  
  # ========================================
  # Infrastructure CI (Bicep)
  # ========================================
  infrastructure-ci:
    name: Infrastructure CI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        continue-on-error: true
      
      - name: Install Bicep CLI
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep
          bicep --version
      
      - name: Validate Bicep templates
        run: |
          bicep build infra/main.bicep
          echo "✅ main.bicep validation passed"
          
          for module in infra/modules/*.bicep; do
            bicep build "$module"
            echo "✅ $(basename $module) validation passed"
          done
      
      - name: Bicep Linter
        run: |
          bicep lint infra/main.bicep
        continue-on-error: true
  
  # ========================================
  # CI Summary
  # ========================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: 
      - frontend-ci
      - backend-auth-service-ci
      - backend-tenant-service-ci
      - backend-service-setting-ci
      - infrastructure-ci
    if: always()
    
    steps:
      - name: Check CI Results
        run: |
          echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend CI | ${{ needs.frontend-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth Service CI | ${{ needs.backend-auth-service-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tenant Service CI | ${{ needs.backend-tenant-service-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Service Setting CI | ${{ needs.backend-service-setting-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure CI | ${{ needs.infrastructure-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.frontend-ci.result }}" == "success" ]] && \
             [[ "${{ needs.backend-auth-service-ci.result }}" == "success" ]] && \
             [[ "${{ needs.backend-tenant-service-ci.result }}" == "success" ]] && \
             [[ "${{ needs.backend-service-setting-ci.result }}" == "success" ]] && \
             [[ "${{ needs.infrastructure-ci.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ All CI checks passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Some CI checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
