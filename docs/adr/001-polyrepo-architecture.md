# 001. Gitサブモジュールを使用したPolyrepoアーキテクチャの採用

**日付**: 2026-01-07  
**ステータス**: 承認  
**決定者**: 開発チーム、アーキテクチャチーム

## コンテキスト

複数の独立したサービス（フロントエンド、認証サービス、ユーザー管理サービス、サービス設定サービス）を持つマルチサービスSaaS管理プラットフォームを構築しています。以下を可能にするリポジトリ戦略が必要です：

- サービスの独立した開発とデプロイ
- 明確なサービス境界の維持
- 必要に応じた調整されたリリース
- 異なるチームが異なるサービスに取り組むことのサポート
- システム全体の統一されたビューの提供

主な選択肢：
1. モノレポ：すべてのサービスを含む単一のリポジトリ
2. Polyrepo：統合リポジトリを持つサービスごとの個別リポジトリ
3. マルチレポ：統合レイヤーのない完全に独立したリポジトリ

## 決定

**Gitサブモジュールで実装されたpolyrepoアーキテクチャ**を使用します：

- 各サービス（frontend、auth-service、user-management-service、service-setting-service）は独自のリポジトリを持つ
- 統合リポジトリ（`ws-demo-poly-integration`）は、すべてのサービスリポジトリをGitサブモジュールとして参照
- 各サービスは独立して開発、テスト、デプロイ可能
- 統合リポジトリは以下を提供：
  - 統一されたドキュメント
  - 全体的なアーキテクチャドキュメント
  - クロスサービス統合テスト
  - 調整されたリリース管理
  - 開発環境セットアップ（DevContainer）

リポジトリ構造：
```
ws-demo-poly-integration/          # 統合リポジトリ
├── src/
│   ├── front/                     # サブモジュール: ws-demo-poly1
│   ├── auth-service/              # サブモジュール: ws-demo-poly3
│   ├── user-management-service/   # サブモジュール: ws-demo-poly2
│   └── service-setting-service/   # サブモジュール: ws-demo-poly4
├── docs/                          # 共有ドキュメント
└── CONTRIBUTING.md                # 開発ガイドライン
```

## 結果

### ポジティブな結果

- **サービスの独立性**: 各サービスを独立して開発、バージョン管理、デプロイ可能
- **明確な境界**: 物理的なリポジトリ分離がサービス境界を強制し、結合を減らす
- **チームの自律性**: 異なるチームが独自のCI/CDパイプラインで異なるサービスを所有可能
- **選択的クローン**: 開発者は作業に必要なサービスのみクローン可能
- **個別のサービス履歴**: 各サービスは独自のGit履歴を維持し、変更の追跡が容易
- **技術の柔軟性**: サービスは異なる技術、フレームワーク、言語を使用可能
- **高速なCI/CD**: サービス固有のパイプラインはモノレポパイプラインより高速に実行

### ネガティブな結果

- **調整オーバーヘッド**: クロスサービス変更には複数のリポジトリにわたる調整が必要
- **サブモジュールの複雑性**: チームメンバーはGitサブモジュールを理解する必要
- **依存関係管理**: 共有型またはライブラリには慎重なバージョン管理が必要
- **統合テスト**: クロスサービステストは統合リポジトリで維持する必要
- **初期セットアップ**: モノレポと比較して初期セットアップが複雑

### 中立的な結果

- 統合リポジトリはサービスを密結合せずに調整ポイントを提供
- サブモジュールの操作に関する明確なドキュメントとガイドラインが必要

## 検討した代替案

### 代替案1: モノレポ

**説明**: ディレクトリ内のすべてのサービスを含む単一のリポジトリ。

**長所**:
- 依存関係管理の簡素化
- アトミックなクロスサービス変更
- 単一のCI/CDパイプライン
- コード共有とリファクタリングが容易
- サブモジュールの複雑性なし

**短所**:
- リポジトリサイズが大きい
- CI/CDが遅い（すべてのサービスをテスト）
- サービス境界の強制が難しい
- すべての開発者がすべてのコードにアクセス必要
- より複雑なビルド設定
- 密結合の可能性

**却下理由**: 小規模チームには簡単ですが、私たちのアーキテクチャはサービスの独立性を重視し、独立したデプロイサイクルをサポートしたいです。モノレポではサービス境界の違反が容易になります。

### 代替案2: 完全に独立したリポジトリ（マルチレポ）

**説明**: 統合レイヤーのない個別のリポジトリ。

**長所**:
- 最大限のサービス独立性
- サブモジュールの複雑性なし
- 完全なチームの自律性

**短所**:
- システムの統一されたビューがない
- リリースの調整が困難
- 新しい開発者のオンボーディングが難しい
- 共有ドキュメントや標準がない
- 複雑な統合テストセットアップ

**却下理由**: 分離が多すぎてシステム全体の管理が困難。ドキュメント、標準、統合テストの調整ポイントが必要です。

## 実装ノート

### サブモジュールの操作

**初期クローン**:
```bash
git clone --recursive https://github.com/Takas0522/ws-demo-poly-integration.git
```

**サブモジュールの更新**:
```bash
git submodule update --remote --recursive
```

**サブモジュール内での変更**:
```bash
cd src/service-name
git checkout -b feature/my-feature
# 変更を行う
git commit -m "feat: add feature"
git push origin feature/my-feature
```

**新しいサブモジュールコミットを参照するようにメインリポジトリを更新**:
```bash
cd ../..
git add src/service-name
git commit -m "Update service-name submodule"
git push
```

### ガイドライン

1. サービスリポジトリは独立してデプロイ可能に保つ
2. 共有型はnpmパッケージとして公開
3. 統合テストは統合リポジトリに配置
4. ドキュメント標準は統合リポジトリで維持
5. DevContainer設定は統合リポジトリに配置

## 検証

以下によってこの決定を検証します：
- **デプロイの独立性**: サービスを他を壊さずに独立してデプロイできること
- **チームの速度**: チームが互いにブロックせずに作業できるかを測定
- **オンボーディング時間**: 新しい開発者のオンボーディング体験を追跡
- **コード品質**: サービス境界がクリーンに保たれているかを監視
- **レビュータイムライン**: 実装後6か月

成功メトリクス：
- サービスは他を壊さずに独立してデプロイ可能
- チームは最小限のクロスサービス調整オーバーヘッドを報告
- 新しい開発者は1週間以内に貢献可能
- サービス依存関係は疎結合のまま

## 参考資料

- [Git Submodulesドキュメント](https://git-scm.com/book/en/v2/Git-Tools-Submodules)
- [Monorepo vs Polyrepo](https://medium.com/@mattklein123/monorepos-please-dont-e9a279be011b)
- [Microservices and Repository Strategy](https://martinfowler.com/articles/microservices.html)
- このリポジトリのDEVELOPMENT_PLAN.md

---

**最終更新**: 2026-01-07
