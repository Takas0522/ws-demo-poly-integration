# サンプルデータ

## 概要

このドキュメントでは、マルチテナントSaaS PoC環境におけるサンプルデータの内容と投入方法について説明します。

サンプルデータは、システムのデモンストレーションや動作確認を目的として作成されており、実際の運用データを模したリアルなデータ構成となっています。

---

## ドキュメント情報

- **バージョン**: 1.0.0
- **最終更新日**: 2024年
- **ステータス**: Active

---

## 目次

1. [サンプルデータの構成](#1-サンプルデータの構成)
2. [データ投入方法](#2-データ投入方法)
3. [テストアカウント一覧](#3-テストアカウント一覧)
4. [利用シナリオ例](#4-利用シナリオ例)
5. [データのクリーンアップ](#5-データのクリーンアップ)

---

## 1. サンプルデータの構成

### 1.1 データ概要

| データ種別 | 件数 | 説明 |
|----------|------|------|
| テナント | 10件 | 様々な業種・規模の企業を想定 |
| ユーザー | 40件程度 | 各テナントに3-5名のユーザーを配置 |
| ロール割り当て | 80-120件 | ユーザーごとに1-3個のロールを割り当て |
| サービス割り当て | 30-40件 | テナントごとに2-5個のサービスを割り当て |

### 1.2 サンプルテナント

以下の10社のテナントデータを用意しています：

| # | テナント名 | ドメイン | 想定業種 |
|---|----------|---------|---------|
| 1 | 株式会社サンプルコーポレーション | sample-corp.co.jp, sample-corp.com | 総合商社 |
| 2 | テックイノベーション株式会社 | tech-innovation.jp | IT企業 |
| 3 | グローバルソリューションズ | global-solutions.com, gs-japan.co.jp | コンサルティング |
| 4 | デジタルマーケティングパートナーズ | dmp.co.jp | マーケティング |
| 5 | クラウドシステムズ株式会社 | cloud-systems.jp, cloudsys.com | クラウドサービス |
| 6 | エンタープライズソリューション | enterprise-sol.co.jp | システムインテグレーター |
| 7 | スマートデータ株式会社 | smart-data.jp | データ分析 |
| 8 | ビジネスアクセラレータ | biz-accel.com | スタートアップ支援 |
| 9 | フューチャーテクノロジーズ | future-tech.co.jp, ft-japan.jp | 技術開発 |
| 10 | インテグレーションワークス | integration-works.com | システム開発 |

### 1.3 ユーザーロール構成

ユーザーには以下のパターンでロールが割り当てられています：

#### パターン1: 管理者系（全体の20%）
- テナント管理サービス: 管理者
- 認証認可サービス: 閲覧者
- 利用サービス設定サービス: 閲覧者

**想定利用者**: テナント管理者、システム管理担当者

#### パターン2: ファイル管理中心（全体の30%）
- ファイル管理サービス: 管理者
- メッセージングサービス: ユーザー

**想定利用者**: ドキュメント管理者、プロジェクトリーダー

#### パターン3: 一般ユーザー（全体の30%）
- ファイル管理サービス: ユーザー
- メッセージングサービス: ユーザー
- API利用サービス: ユーザー

**想定利用者**: 一般社員

#### パターン4: 閲覧者（全体の20%）
- テナント管理サービス: 閲覧者
- 認証認可サービス: 閲覧者
- 利用サービス設定サービス: 閲覧者
- バックアップサービス: 閲覧者

**想定利用者**: 監査担当者、経営層

### 1.4 サービス割り当てパターン

テナントには以下のサービスパッケージが割り当てられています：

#### 基本パッケージ
- ファイル管理サービス
- メッセージングサービス

#### ビジネスパッケージ
- ファイル管理サービス
- メッセージングサービス
- API利用サービス

#### エンタープライズパッケージ
- ファイル管理サービス
- メッセージングサービス
- API利用サービス
- バックアップサービス

---

## 2. データ投入方法

### 2.1 前提条件

- CosmosDBが作成済みであること
- 初期データ（特権テナント、管理者）が投入済みであること
- 環境変数が設定されていること

### 2.2 環境変数の設定

```bash
export COSMOS_ENDPOINT="https://your-cosmos-account.documents.azure.com:443/"
export COSMOS_KEY="your-cosmos-primary-key"
```

または `.env` ファイルに記載：

```bash
COSMOS_ENDPOINT=https://your-cosmos-account.documents.azure.com:443/
COSMOS_KEY=your-cosmos-primary-key
```

### 2.3 初期データの投入（未実施の場合）

```bash
# データベースとコンテナの作成
python scripts/create_database.py

# 初期データ（特権テナント、管理者、サービス、ロール）の投入
python scripts/seed_database.py
```

### 2.4 サンプルデータの投入

```bash
# プロジェクトルートディレクトリで実行
python scripts/seed_sample_data.py
```

実行結果：

```
============================================================
サンプルデータ投入スクリプト
============================================================

このスクリプトはデモンストレーション用のサンプルデータを投入します。
既存の初期データ（特権テナント、管理者）は保持されます。

============================================================
テナントデータ投入
============================================================
✓ テナント作成: 株式会社サンプルコーポレーション
✓ テナント作成: テックイノベーション株式会社
...

============================================================
ユーザーデータ投入
============================================================
✓ ユーザー作成: taro.yamada1@sample-corp.co.jp (山田太郎（株式会社サンプルコーポレーション）)
...

============================================================
サンプルデータ投入完了
============================================================

投入結果:
  tenants             : 10 件作成, 0 件スキップ
  users               : 40 件作成, 0 件スキップ
  tenant_users        : 40 件作成, 0 件スキップ
  user_roles          : 85 件作成, 0 件スキップ
  tenant_services     : 35 件作成, 0 件スキップ

✓ すべてのサンプルデータ投入が完了しました！
```

### 2.5 投入の確認

CosmosDBのData Explorerで以下を確認：

```sql
-- テナント数の確認
SELECT COUNT(1) as count FROM c WHERE c.type = 'tenant'
-- 結果: 11件（特権テナント1件 + サンプル10件）

-- ユーザー数の確認
SELECT COUNT(1) as count FROM c WHERE c.type = 'user'
-- 結果: 41件程度（管理者1件 + サンプル40件）
```

---

## 3. テストアカウント一覧

### 3.1 システム管理者（初期データ）

| 項目 | 値 |
|-----|-----|
| **テナント** | 特権テナント |
| **メールアドレス** | admin@system.local |
| **パスワード** | Admin@12345 |
| **ロール** | 全体管理者（全サービス） |
| **権限** | すべての操作が可能 |

**利用シナリオ**:
- テナントの追加・削除・編集
- 全ユーザーの管理
- サービスの割り当て・解除
- システム全体の設定

### 3.2 テナント管理者アカウント

| 項目 | 値 |
|-----|-----|
| **テナント** | 株式会社サンプルコーポレーション |
| **メールアドレス** | taro.yamada1@sample-corp.co.jp |
| **パスワード** | Password@123 |
| **ロール** | テナント管理者 |
| **権限** | テナント内の管理操作が可能 |

**利用シナリオ**:
- 自テナントの設定変更
- テナント内ユーザーの管理
- ロールの割り当て

### 3.3 一般ユーザーアカウント

| 項目 | 値 |
|-----|-----|
| **テナント** | テックイノベーション株式会社 |
| **メールアドレス** | hanako.sato2@tech-innovation.jp |
| **パスワード** | Password@123 |
| **ロール** | ファイル管理ユーザー、メッセージングユーザー |
| **権限** | ファイル閲覧・アップロード、メッセージ閲覧 |

**利用シナリオ**:
- ファイルのアップロード・ダウンロード
- メッセージの閲覧
- 自分のプロファイル管理

### 3.4 閲覧者アカウント

| 項目 | 値 |
|-----|-----|
| **テナント** | グローバルソリューションズ |
| **メールアドレス** | ichiro.suzuki3@global-solutions.com |
| **パスワード** | Password@123 |
| **ロール** | 閲覧者 |
| **権限** | 情報の参照のみ可能 |

**利用シナリオ**:
- テナント情報の閲覧
- ユーザー一覧の閲覧
- サービス設定の閲覧
- バックアップ状況の確認

### 3.5 共通パスワードについて

**注意**: すべてのサンプルユーザーは共通パスワード `Password@123` を使用しています。

本番環境では：
- 初回ログイン時にパスワード変更を強制
- パスワードポリシーの適用
- 多要素認証の導入

を推奨します。

---

## 4. 利用シナリオ例

### 4.1 シナリオ1: マルチテナント機能の確認

**目的**: 異なるテナント間でデータが分離されていることを確認

**手順**:

1. テナント1のユーザーでログイン
   ```
   メール: taro.yamada1@sample-corp.co.jp
   パスワード: Password@123
   ```

2. テナント一覧を確認
   - 自テナントのみ表示されることを確認

3. ログアウトして、テナント2のユーザーでログイン
   ```
   メール: hanako.sato2@tech-innovation.jp
   パスワード: Password@123
   ```

4. テナント一覧を確認
   - 異なるテナントが表示されることを確認

**期待結果**: 各テナントは自分のテナント情報のみアクセス可能

### 4.2 シナリオ2: ロールベースアクセス制御の確認

**目的**: ロールに応じて操作可能な機能が制限されることを確認

**手順**:

1. 管理者ユーザーでログイン
   ```
   メール: taro.yamada1@sample-corp.co.jp
   ```
   - テナント作成ボタンが表示される
   - ユーザー追加ボタンが表示される

2. 一般ユーザーでログイン
   ```
   メール: hanako.sato2@tech-innovation.jp
   ```
   - テナント作成ボタンが非表示
   - ファイル操作のみ可能

3. 閲覧者ユーザーでログイン
   ```
   メール: ichiro.suzuki3@global-solutions.com
   ```
   - すべての変更操作が非表示
   - 情報の閲覧のみ可能

**期待結果**: ロールに応じた権限制御が機能している

### 4.3 シナリオ3: サービス割り当ての確認

**目的**: テナントに割り当てられたサービスのみ利用可能であることを確認

**手順**:

1. エンタープライズパッケージのテナントユーザーでログイン
   - 利用可能サービス一覧を確認
   - ファイル管理、メッセージング、API利用、バックアップが表示

2. 基本パッケージのテナントユーザーでログイン
   - 利用可能サービス一覧を確認
   - ファイル管理、メッセージングのみ表示

**期待結果**: テナントに割り当てられたサービスのみ表示・利用可能

### 4.4 シナリオ4: システム管理者による全体管理

**目的**: 特権テナントの管理者が全テナントを管理できることを確認

**手順**:

1. システム管理者でログイン
   ```
   メール: admin@system.local
   パスワード: Admin@12345
   ```

2. テナント一覧を確認
   - すべてのテナント（特権テナント含む）が表示される

3. 任意のテナントを選択
   - テナント情報の編集が可能
   - ユーザー一覧の確認が可能
   - サービス割り当ての変更が可能

**期待結果**: システム管理者は全テナントを管理可能

---

## 5. データのクリーンアップ

### 5.1 サンプルデータのみ削除

特定のテナントやユーザーを個別に削除する場合：

```python
# 例: 特定テナントの削除スクリプト
from shared.cosmos_client import CosmosDBClient

client = CosmosDBClient(database_name="tenant_management")
container = client.get_container("tenants")

# テナントID指定で削除
tenant_id = "tenant-xxxxxxxx"
container.delete_item(item=tenant_id, partition_key=tenant_id)
```

### 5.2 すべてのデータをリセット

データベース全体を再作成する場合：

```bash
# データベースの削除と再作成
python scripts/create_database.py --reset

# 初期データの再投入
python scripts/seed_database.py

# サンプルデータの再投入（必要に応じて）
python scripts/seed_sample_data.py
```

### 5.3 初期データのみに戻す

サンプルデータのみ削除し、初期データ（特権テナント、管理者）のみ残す場合：

1. Azure Portal のData Explorerを使用
2. 以下のクエリで対象データを確認：

```sql
-- 初期データ以外のテナント
SELECT * FROM c 
WHERE c.type = 'tenant' 
AND c.id != 'privileged-tenant-001'

-- 初期データ以外のユーザー
SELECT * FROM c 
WHERE c.type = 'user' 
AND c.id != 'admin-user-001'
```

3. 該当データを手動で削除

---

## 6. トラブルシューティング

### 6.1 データ投入エラー

**エラー**: `Conflict - The resource already exists`

**原因**: 既にデータが投入されている

**対応**: 
- スキップされたデータは無視して続行
- 完全にやり直す場合はクリーンアップを実行

### 6.2 認証エラー

**エラー**: `Unauthorized - Invalid credentials`

**原因**: 環境変数の設定誤り

**対応**:
```bash
# 環境変数の確認
echo $COSMOS_ENDPOINT
echo $COSMOS_KEY

# 再設定
export COSMOS_ENDPOINT="正しいエンドポイント"
export COSMOS_KEY="正しいキー"
```

### 6.3 ログインできない

**症状**: サンプルユーザーでログインできない

**確認事項**:
1. メールアドレスが正しいか
2. パスワードが `Password@123` か
3. ユーザーが `isActive: true` か

**対応**:
```sql
-- ユーザーの確認
SELECT * FROM c 
WHERE c.type = 'user' 
AND c.userId = 'taro.yamada1@sample-corp.co.jp'
```

---

## 7. 関連ドキュメント

- [データモデル設計](./arch/data/data-model.md)
- [初期データ仕様](../scripts/seed_data/initial_data.py)
- [サンプルデータ定義](../scripts/seed_data/sample_data.py)

---

## 8. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|-------|
| 1.0.0 | 2024 | 初版作成 | Sample Data Creation Agent |
