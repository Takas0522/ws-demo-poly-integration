# CosmosDB データベースドキュメント

このディレクトリには、SaaS管理アプリケーションのCosmosDBデータベース設計と実装に関する包括的なドキュメントが含まれています。

## 📚 ドキュメントインデックス

### [SCHEMA.md](./SCHEMA.md)
完全なデータベーススキーマドキュメント：
- コンテナ定義（Tenants、Users、Permissions、AuditLogs）
- フィールド仕様とデータ型
- インデックスポリシー
- ドキュメント例
- 一般的なクエリ例
- パフォーマンス最適化ガイドライン
- セキュリティ考慮事項

### [DATA_ACCESS_PATTERNS.md](./DATA_ACCESS_PATTERNS.md)
データアクセスパターンの詳細ガイド：
- 7つの包括的なパターンと例
- リクエストユニット（RU）コスト分析
- パフォーマンス比較表
- 避けるべきアンチパターン
- 監視と最適化のヒント

## 🏗️ アーキテクチャ

### データベース設計哲学

データベース設計は以下の核心原則に従います：

1. **マルチテナンシー優先**: テナントIDパーティショニングによりデータ分離とスケーラビリティを保証
2. **パフォーマンス最適化**: 戦略的なインデックスによりRUコストを最小化
3. **セキュリティ重視**: 組み込みのデータ分離と監査ログ
4. **開発者フレンドリー**: 明確なパターンとTypeScript型

### パーティション戦略

すべてのコンテナは`/tenantId`をパーティションキーとして使用：

```json
{
  "id": "document-id",
  "tenantId": "tenant-123",  // パーティションキー
  // その他のフィールド...
}
```

**利点**:
- テナントごとの効率的なデータ分離
- テナント内での最適なクエリパフォーマンス
- 自動的な水平スケーリング
- セキュリティのための物理的なデータ分離

### コンテナ概要

| コンテナ | 目的 | パーティションキー | TTL | スループット |
|---------|------|------------------|-----|------------|
| **Tenants** | 組織情報 | `/tenantId` | なし | 400 RU/s |
| **Users** | ユーザーアカウントとプロファイル | `/tenantId` | なし | 400 RU/s |
| **Permissions** | 権限定義 | `/tenantId` | なし | 400 RU/s |
| **AuditLogs** | アクティビティ監査証跡 | `/tenantId` | 90日 | 400 RU/s |

## 🚀 クイックスタート

### 1. データベースの初期化

```bash
cd scripts/cosmosdb
npm install
npm run init
```

これにより以下が作成されます：
- データベース: `saas-management-dev`
- 適切な設定を持つすべての4つのコンテナ
- インデックスポリシー
- TTL設定

### 2. 開発データのシード

```bash
npm run seed
```

これにより以下が投入されます：
- 1つの開発テナント
- 2人のユーザー（管理者と一般）
- 13の権限定義
- サンプル監査ログ

**デフォルト認証情報**:
- 管理者: `admin@example.com` / `Admin@123`
- ユーザー: `user@example.com` / `User@123`

### 3. アプリケーションから接続

```typescript
import { CosmosClient } from '@azure/cosmos';

const client = new CosmosClient({
  endpoint: process.env.COSMOSDB_ENDPOINT,
  key: process.env.COSMOSDB_KEY
});

const database = client.database(process.env.COSMOSDB_DATABASE);
const usersContainer = database.container('Users');

// ポイント読み取り - 最も効率的（1 RU）
const { resource: user } = await usersContainer
  .item('user-123', 'tenant-456')
  .read();
```

## 📊 データモデル図

```
┌─────────────────────────────────────────────────────────────┐
│                         Tenants                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ id: tenant-123                                       │  │
│  │ tenantId: tenant-123 (パーティションキー)           │  │
│  │ name: "Acme Corp"                                   │  │
│  │ status: "active"                                    │  │
│  │ subscription: { plan, dates, maxUsers }            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                          Users                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ id: user-456                                         │  │
│  │ tenantId: tenant-123 (パーティションキー)           │  │
│  │ email: "user@example.com"                           │  │
│  │ roles: ["admin", "user"]                            │  │
│  │ permissions: ["users.create", ...]                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ N:M
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Permissions                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ id: permission-789                                   │  │
│  │ tenantId: tenant-123 (パーティションキー)           │  │
│  │ name: "users.create"                                │  │
│  │ category: "users"                                   │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       AuditLogs                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ id: log-101112                                       │  │
│  │ tenantId: tenant-123 (パーティションキー)           │  │
│  │ timestamp: "2026-01-09T12:00:00Z"                   │  │
│  │ action: "user.update"                               │  │
│  │ ttl: 7776000 (90日)                                 │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 🔑 主要機能

### 1. テナント分離

パーティショニングによる物理的なデータ分離：
- 各テナントのデータは別々のパーティションに
- デフォルトで単一テナントにスコープされたクエリ
- テナント間のデータアクセスの誤りを防止

### 2. パフォーマンス最適化

コスト削減のための戦略的なインデックス：
- 一般的なクエリ用の複合インデックス
- 未使用フィールドの除外パス
- 単一ドキュメントアクセスのためのポイント読み取り

### 3. 監査ログ

包括的なアクティビティ追跡：
- すべてのデータ変更を自動的にログ記録
- 自動クリーンアップ付き90日保持
- コンプライアンス対応の監査証跡

### 4. 型安全性

すべてのモデルのTypeScript定義：
- 強力な型付けによりエラーを防止
- IntelliSenseサポート
- ランタイム検証ヘルパー

## 📈 パフォーマンスガイドライン

### クエリコスト比較

| 操作 | RUコスト | ユースケース |
|------|---------|-------------|
| ポイント読み取り | 1 RU | IDでドキュメントを取得 |
| 単一パーティションクエリ | 2-10 RU | テナント内でリスト |
| クロスパーティションクエリ | 10-1000+ RU | 管理のみ |
| 挿入 | 5-15 RU | ドキュメントを作成 |
| 更新 | 5-15 RU | ドキュメントを変更 |
| 削除 | 5-10 RU | ドキュメントを削除 |

### ベストプラクティス

✅ **実施すべきこと**:
- すべてのクエリに`tenantId`を含める
- 可能な限りポイント読み取りを使用
- 大規模な結果にはページネーションを実装
- RU消費を監視
- クエリ対象のフィールドのみにインデックスを付ける

❌ **避けるべきこと**:
- パーティションキーなしのクエリ
- 不要な`SELECT *`の使用
- すべての結果を一度に取得
- フィールドの過剰インデックス
- ユーザーフローでクロスパーティションクエリを実行

## 🔒 セキュリティ考慮事項

### データ保護

1. **パーティションレベルの分離**: テナントデータの物理的な分離
2. **パスワードセキュリティ**: 10回以上のソルトラウンドでBcrypt
3. **シークレット暗号化**: 保存時に二要素認証シークレットを暗号化
4. **監査ログ**: すべてのアクセスと変更をログ記録
5. **ログにシークレットなし**: パスワードを決してログに記録しない

### アクセス制御

1. **アプリケーションレベル**: 認証トークンからテナントコンテキストを検証
2. **クライアントを信頼しない**: サーバー側で常にテナントIDを検証
3. **最小権限**: ユーザーに必要最小限の権限を付与
4. **定期的な監査**: アクセスパターンと権限を定期的にレビュー

## 📚 追加リソース

- [ADR 003: CosmosDBスキーマ設計](../adr/003-cosmosdb-schema-tenant-partitioning.md)
- [データベーススクリプトREADME](../../scripts/cosmosdb/README.md)
- [Azure CosmosDB ドキュメント](https://docs.microsoft.com/azure/cosmos-db/)
- [SQLクエリリファレンス](https://docs.microsoft.com/azure/cosmos-db/sql-query-getting-started)
- [パーティショニングのベストプラクティス](https://docs.microsoft.com/azure/cosmos-db/partitioning-overview)

## 📝 変更履歴

### 2026-01-09 - 初期スキーマ設計
- パーティション戦略を持つすべての4つのコンテナを定義
- 最適化のためのインデックスポリシーを作成
- 監査ログのTTLを実装
- TypeScript型定義を追加
- 初期化とシードスクリプトを作成

---

**最終更新**: 2026-01-09

**管理者**: 開発チーム

**質問?**: ヘルプを得る方法については[CONTRIBUTING.md](../../CONTRIBUTING.md)を参照してください
