# タスク: インフラ基盤構築

## 概要
Azure環境におけるシステム全体のインフラストラクチャをBicepで構築します。Cosmos DB、App Service、Application Insightsなどの必要なリソースを定義し、デプロイ可能な状態にします。

## 対象コンポーネント
- インフラストラクチャ全体 (`/infra`)
- Cosmos DB (全コンテナ)
- App Service Plan & App Services (全サービス)
- Application Insights

## 前提条件
- Azureサブスクリプションへのアクセス権限
- Azure CLIまたはGitHub Actions実行環境
- Bicepの基本的な理解

## 実装内容

### 1. Bicepテンプレート作成

#### 1.1 ディレクトリ構成
```
infra/
├── main.bicep                     # エントリポイント
├── parameters/
│   ├── dev.bicepparam            # Dev環境パラメータ
│   ├── staging.bicepparam        # Staging環境パラメータ
│   └── production.bicepparam     # Production環境パラメータ
├── modules/
│   ├── app-service-plan.bicep    # App Service Planモジュール
│   ├── app-service.bicep         # App Serviceモジュール
│   ├── cosmos-db.bicep           # Cosmos DBモジュール
│   ├── app-insights.bicep        # Application Insightsモジュール
│   └── networking.bicep          # 仮想ネットワーク（Phase 2）
└── scripts/
    ├── deploy.sh                 # デプロイスクリプト
    ├── destroy.sh                # リソース削除スクリプト
    └── validate.sh               # テンプレート検証スクリプト
```

#### 1.2 main.bicep
- サブスクリプションスコープでのデプロイ
- リソースグループの作成
- 各モジュールの呼び出し
- 出力値の定義 (接続文字列、URL等)

#### 1.3 Cosmos DB モジュール
- アカウント作成 (NoSQL API)
- データベース作成 (management-app)
- コンテナ作成:
  - auth (パーティションキー: /tenantId)
  - tenant (パーティションキー: /tenantId)
  - service-setting (パーティションキー: /tenantId)
  - file-service (パーティションキー: /tenantId)
  - messaging-service (パーティションキー: /tenantId)
  - api-service (パーティションキー: /tenantId, TTL付き)
  - backup-service (パーティションキー: /tenantId)
- 自動スケール設定 (最小400RU/s、最大4000RU/s)
- 継続的バックアップ設定 (30日保持)

#### 1.4 App Service モジュール
- App Service Plan作成 (B1プラン、Linux)
- Frontend App Service (Node.js 20)
- Backend App Services (Python 3.11):
  - auth-service
  - tenant-management-service
  - service-setting-service
  - file-service
  - messaging-service
  - api-service
  - backup-service
- デプロイメントスロット設定 (staging)
- HTTPS強制、AlwaysOn有効化

#### 1.5 Application Insights モジュール
- Application Insights作成
- 全App Serviceとの紐付け
- 基本アラート設定

### 2. パラメータファイル作成

各環境 (dev, staging, production) のパラメータを定義:
- リソース名プレフィックス
- SKU/プラン設定
- タグ情報
- 環境固有設定

### 3. デプロイスクリプト作成

#### 3.1 deploy.sh
```bash
#!/bin/bash
# 環境選択、検証、デプロイ実行
# 出力値の取得とファイル保存
```

#### 3.2 validate.sh
```bash
#!/bin/bash
# Bicepテンプレートの構文チェック
# What-If実行
```

### 4. ローカル開発環境設定

#### 4.1 Cosmos DB Emulator設定
DevContainer内でCosmos DB Emulatorを起動し、ローカル開発で利用できるようにする。

#### 4.2 環境変数テンプレート
各サービスの `.env.example` ファイルを作成し、必要な環境変数を明示。

## 完了条件

- [ ] Bicepテンプレートが正常に検証される (`az deployment sub validate`)
- [ ] Staging環境へのデプロイが成功する
- [ ] 全てのリソースが正しく作成される:
  - [ ] Cosmos DBアカウント、データベース、7つのコンテナ
  - [ ] App Service Plan (B1)
  - [ ] 8つのApp Service (Frontend + 7 Backend)
  - [ ] Application Insights
- [ ] 接続文字列などの出力値が取得できる
- [ ] ローカル開発環境でCosmos DB Emulatorが動作する
- [ ] 各サービスの `.env.example` が作成される
- [ ] デプロイ・削除スクリプトが動作する

## 依存タスク
なし（最初のタスク）

## 後続タスク
- 02. 共通ライブラリ実装
- 03. 認証認可サービス - コアAPI
- 21. CI/CDパイプライン構築

## 技術的考慮事項

### コスト最適化
- B1プランを使用 (最小コスト構成)
- Cosmos DBは自動スケールで未使用時は最小RU
- 開発環境では共有App Service Planを使用

### セキュリティ
- HTTPS必須設定
- TLS 1.2以上
- パブリックアクセスは必要最小限
- 秘密情報は環境変数またはKey Vault (Phase 2)

### 可用性
- 継続的バックアップ有効化
- デプロイメントスロット使用でゼロダウンタイムデプロイ

## 参照ドキュメント
- [デプロイメント設計](../../arch/deployment/README.md)
- [データモデル設計](../../arch/data/README.md)
- [Azure Bicep Documentation](https://docs.microsoft.com/azure/azure-resource-manager/bicep/)
- [Cosmos DB Bicep Reference](https://docs.microsoft.com/azure/templates/microsoft.documentdb/)

## 見積もり工数
- 作業時間: 2日
- レビュー: 0.5日
- **合計**: 2.5日

## 備考
- Production環境へのデプロイは全機能実装後に実施
- インフラコストは月額約$94を想定 (Phase 1構成)
- スケーラビリティを考慮した設計だが、Phase 1ではコスト優先
