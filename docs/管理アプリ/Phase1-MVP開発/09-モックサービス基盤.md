# タスク: モックサービス基盤

## 概要
4つの管理対象サービス（ファイル管理、メッセージング、API利用、バックアップ）で共通利用する基盤パターンを実装します。各サービスの実装を効率化するためのテンプレートとガイドラインを提供します。

## 対象コンポーネント
- 全モックサービス (`/src/*-service`)
- サービステンプレート

## 前提条件
- タスク02 (共通ライブラリ実装) が完了
- タスク08 (サービス設定サービス - ロール統合) が完了

## 実装内容

### 1. 共通パターン定義

#### 1.1 標準ディレクトリ構造
```
src/{service-name}/
├── app/
│   ├── __init__.py
│   ├── main.py                    # FastAPIアプリ
│   ├── config.py
│   ├── api/
│   │   ├── __init__.py
│   │   ├── features.py            # サービス固有機能
│   │   └── roles.py               # ロール情報提供API
│   ├── models/
│   │   ├── __init__.py
│   │   ├── entities.py            # サービス固有エンティティ
│   │   └── role.py
│   ├── services/
│   │   ├── __init__.py
│   │   └── feature_service.py
│   ├── repositories/
│   │   ├── __init__.py
│   │   └── feature_repository.py
│   └── schemas/
│       ├── __init__.py
│       └── feature.py
├── tests/
├── .env.example
├── requirements.txt
└── README.md
```

### 2. ロール情報提供API（必須）

#### 2.1 ロールモデル (`app/models/role.py`)
```python
class ServiceRole(BaseModel):
    name: str
    description: str
    permissions: List[str] = []
```

#### 2.2 ロールAPI (`app/api/roles.py`)
```python
@router.get("/roles", response_model=List[ServiceRole])
async def get_service_roles():
    """
    このサービスで定義されているロール一覧を返却
    認証不要（サービス間通信用）
    """
    return [
        ServiceRole(
            name="管理者",
            description="全機能へのアクセス",
            permissions=["*:*"]
        ),
        ServiceRole(
            name="編集者",
            description="データの作成・編集",
            permissions=["resource:create", "resource:update", "resource:read"]
        ),
        ServiceRole(
            name="閲覧者",
            description="データの参照のみ",
            permissions=["resource:read"]
        ),
    ]
```

**重要**: 
- このエンドポイントは全モックサービスで必須
- サービス設定サービスがロール情報を収集するために使用
- 認証不要（または共有秘密鍵での認証）

### 3. ヘルスチェックエンドポイント（必須）

```python
@app.get("/health")
async def health_check():
    """
    サービスの健全性チェック
    """
    # Cosmos DB接続チェック
    try:
        await container.read_item("health_check", "_system")
        db_status = "healthy"
    except:
        db_status = "unhealthy"
    
    return {
        "status": "healthy" if db_status == "healthy" else "degraded",
        "service": "{service-name}",
        "version": "1.0.0",
        "timestamp": datetime.utcnow().isoformat(),
        "checks": {
            "database": db_status
        }
    }
```

### 4. 共通ロールベース認可デコレータ

```python
from functools import wraps
from common.auth import get_current_user

def require_service_role(role: str):
    """
    サービス固有のロールチェック
    
    使用例:
    @require_service_role("管理者")
    async def delete_resource(...):
        pass
    """
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, current_user = Depends(get_current_user), **kwargs):
            # ユーザーのロールをチェック
            service_id = "{service-id}"  # 例: "file-service"
            user_roles = [r for r in current_user.roles if r["service_id"] == service_id]
            
            # ロール階層チェック
            role_hierarchy = {
                "管理者": ["管理者", "編集者", "閲覧者"],
                "編集者": ["編集者", "閲覧者"],
                "閲覧者": ["閲覧者"]
            }
            
            allowed_roles = role_hierarchy.get(role, [role])
            if not any(r["role_name"] in allowed_roles for r in user_roles):
                raise HTTPException(
                    status_code=403,
                    detail=f"Role '{role}' required for {service_id}"
                )
            
            return await func(*args, current_user=current_user, **kwargs)
        return wrapper
    return decorator
```

### 5. 共通エンティティベースモデル

```python
class ServiceEntity(BaseModel):
    """全モックサービスのエンティティ基底クラス"""
    id: str = Field(default_factory=lambda: f"{prefix}_{uuid.uuid4()}")
    tenant_id: str
    type: str
    created_by: str
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
```

### 6. テンプレートサービスの作成

完全に動作するテンプレートサービス (`template-service`) を作成:
- 全必須コンポーネントを含む
- 参照ドキュメントとして機能
- 新サービス作成時にコピーして使用

#### 6.1 テンプレートの機能
- シンプルなResource CRUD
- ロール情報提供API
- ヘルスチェック
- 監査ログ
- エラーハンドリング
- テスト例

### 7. サービス作成ガイド作成

#### 7.1 新規サービス作成手順
1. テンプレートをコピー
2. サービス名を置換
3. ロール定義をカスタマイズ
4. 固有エンティティを追加
5. 固有ビジネスロジックを実装
6. テストを追加

#### 7.2 チェックリスト
```markdown
# 新規モックサービスチェックリスト

## 必須実装
- [ ] GET /roles エンドポイント
- [ ] GET /health エンドポイント
- [ ] ロールベース認可の実装
- [ ] テナント分離の実装
- [ ] 監査ログの記録

## 推奨実装
- [ ] OpenAPI仕様書の生成
- [ ] README.md の作成
- [ ] 単体テストのカバレッジ70%以上
- [ ] 統合テスト

## Cosmos DB
- [ ] コンテナが作成済み
- [ ] パーティションキーが /tenantId
- [ ] 必要に応じてTTL設定
```

### 8. 共通設定

#### 8.1 requirements.txt
```
fastapi>=0.100.0
uvicorn[standard]>=0.23.0
pydantic[email]>=2.0.0
azure-cosmos>=4.5.0
python-jose[cryptography]>=3.3.0
-e ../../common
```

#### 8.2 .env.example
```
# Cosmos DB
COSMOS_DB_CONNECTION_STRING=xxx
COSMOS_DB_DATABASE_NAME=management-app
COSMOS_DB_CONTAINER_NAME={service-name}

# Service Info
SERVICE_ID={service-id}
SERVICE_NAME={Service Name}
SERVICE_VERSION=1.0.0

# Authentication
SERVICE_SHARED_SECRET=xxx

# Application Insights
APPINSIGHTS_INSTRUMENTATIONKEY=xxx

# Environment
ENVIRONMENT=development
LOG_LEVEL=INFO
```

### 9. ドキュメント作成

#### 9.1 モックサービス開発ガイド
- 標準パターンの説明
- コード生成方法
- ベストプラクティス
- トラブルシューティング

#### 9.2 README テンプレート
各サービスのREADMEに含める内容:
- サービス概要
- ロール定義
- API仕様
- 環境設定
- ローカル実行方法
- テスト実行方法

## 完了条件

- [ ] 共通パターンが文書化される
- [ ] ロール情報提供APIの標準実装が完成
- [ ] ヘルスチェックの標準実装が完成
- [ ] ロールベース認可デコレータが実装される
- [ ] テンプレートサービスが動作する:
  - [ ] GET /roles
  - [ ] GET /health
  - [ ] Resource CRUD with RBAC
- [ ] サービス作成ガイドが作成される
- [ ] チェックリストが作成される
- [ ] 共通設定ファイルのテンプレートが作成される
- [ ] モックサービス開発ガイドが作成される
- [ ] README テンプレートが作成される

## 依存タスク
- 02. 共通ライブラリ実装
- 08. サービス設定サービス - ロール統合

## 後続タスク
- 10. ファイル管理サービス
- 11. メッセージングサービス
- 12. API利用サービス
- 13. バックアップサービス

## 技術的考慮事項

### 一貫性
- 全モックサービスで同じパターンを使用
- ロールAPIのレスポンス形式を統一
- エラーハンドリングを統一

### 保守性
- テンプレートをメンテナンス
- 共通パターンの変更は全サービスに反映

### 拡張性
- 新規サービス追加を容易に
- カスタマイズポイントを明確化

## 参照ドキュメント
- [コンポーネント設計 - 管理対象サービス](../../arch/components/README.md#6-管理対象サービスモックサービス)
- [API設計 - 管理対象サービスAPI](../../arch/api/README.md#6-管理対象サービスapi共通パターン)

## 見積もり工数
- テンプレート作成: 2日
- ドキュメント作成: 1日
- レビュー: 0.5日
- **合計**: 3.5日

## 備考
- このタスクは他のモックサービス実装の基盤となる
- テンプレートの品質が後続タスクの効率に直結
- Phase 2で共通機能を追加する可能性あり（キャッシング、イベント発行等）
