# タスク: サービス間連携テスト

## 概要
全てのサービスが連携して動作することを確認する統合テストとE2Eテストを実施します。実際のユースケースに基づいたシナリオテストを行い、システム全体の品質を保証します。

## 対象コンポーネント
- 全サービス（Frontend + 7 Backend services）
- テストスクリプト (`/tests`)

## 前提条件
- タスク01-19が全て完了
- 全サービスがローカルまたはステージング環境で起動可能

## 実装内容

### 1. テスト環境構築

#### 1.1 ディレクトリ構成
```
tests/
├── integration/                  # 統合テスト
│   ├── test_auth_flow.py
│   ├── test_tenant_management.py
│   ├── test_service_setting.py
│   └── test_service_integration.py
├── e2e/                          # E2Eテスト
│   ├── auth.spec.ts              # Playwright
│   ├── tenant-management.spec.ts
│   ├── user-management.spec.ts
│   └── dashboard.spec.ts
├── load/                         # 負荷テスト（Phase 2）
├── fixtures/                     # テストデータ
│   ├── users.json
│   ├── tenants.json
│   └── services.json
├── utils/
│   ├── test_helpers.py
│   └── setup.py
├── docker-compose.test.yml       # テスト環境
├── pytest.ini
├── playwright.config.ts
└── README.md
```

### 2. 統合テストシナリオ

#### 2.1 認証フローテスト (`test_auth_flow.py`)
```python
"""
シナリオ: ユーザーログインと認証
1. ログインリクエスト
2. JWT取得
3. JWT検証
4. 保護されたエンドポイントにアクセス
5. ログアウト
"""

@pytest.mark.integration
async def test_complete_auth_flow():
    # 1. ログイン
    response = await client.post(
        f"{AUTH_SERVICE_URL}/api/v1/auth/login",
        json={"username": "admin@example.com", "password": "password"}
    )
    assert response.status_code == 200
    token = response.json()["access_token"]
    
    # 2. JWT検証
    verify_response = await client.post(
        f"{AUTH_SERVICE_URL}/api/v1/auth/verify",
        headers={"Authorization": f"Bearer {token}"}
    )
    assert verify_response.status_code == 200
    
    # 3. 保護されたエンドポイントアクセス
    users_response = await client.get(
        f"{AUTH_SERVICE_URL}/api/v1/users",
        headers={"Authorization": f"Bearer {token}"},
        params={"tenant_id": "tenant_privileged"}
    )
    assert users_response.status_code == 200
    
    # 4. ログアウト
    logout_response = await client.post(
        f"{AUTH_SERVICE_URL}/api/v1/auth/logout",
        headers={"Authorization": f"Bearer {token}"}
    )
    assert logout_response.status_code == 204
```

#### 2.2 テナント管理フローテスト (`test_tenant_management.py`)
```python
"""
シナリオ: テナント作成とユーザー割り当て
1. ログイン（管理者）
2. 新規テナント作成
3. 新規ユーザー作成
4. ユーザーをテナントに割り当て
5. ロール割り当て
6. テナント情報確認
"""

@pytest.mark.integration
async def test_tenant_creation_flow(admin_token
):
    # 1. テナント作成
    tenant_data = {
        "name": "Test Company",
        "display_name": "Test Corp",
        "plan": "standard",
        "max_users": 50
    }
    tenant_response = await client.post(
        f"{TENANT_SERVICE_URL}/api/v1/tenants",
        headers={"Authorization": f"Bearer {admin_token}"},
        json=tenant_data
    )
    assert tenant_response.status_code == 201
    tenant = tenant_response.json()
    
    # 2. ユーザー作成
    user_data = {
        "username": "newuser@testcorp.com",
        "email": "newuser@testcorp.com",
        "password": "SecurePass123!",
        "display_name": "New User",
        "tenant_id": tenant["id"]
    }
    user_response = await client.post(
        f"{AUTH_SERVICE_URL}/api/v1/users",
        headers={"Authorization": f"Bearer {admin_token}"},
        json=user_data
    )
    assert user_response.status_code == 201
    user = user_response.json()
    
    # 3. テナントにユーザー割り当て
    assign_response = await client.post(
        f"{TENANT_SERVICE_URL}/api/v1/tenants/{tenant['id']}/users",
        headers={"Authorization": f"Bearer {admin_token}"},
        json={"user_id": user["id"]}
    )
    assert assign_response.status_code == 201
    
    # 4. ロール割り当て
    role_response = await client.post(
        f"{AUTH_SERVICE_URL}/api/v1/users/{user['id']}/roles",
        headers={"Authorization": f"Bearer {admin_token}"},
        json={
            "service_id": "tenant-management",
            "role_name": "閲覧者"
        }
    )
    assert role_response.status_code == 201
    
    # 5. テナント詳細確認
    detail_response = await client.get(
        f"{TENANT_SERVICE_URL}/api/v1/tenants/{tenant['id']}",
        headers={"Authorization": f"Bearer {admin_token}"}
    )
    assert detail_response.status_code == 200
    detail = detail_response.json()
    assert detail["user_count"] == 1
```

#### 2.3 サービス設定フローテスト (`test_service_setting.py`)
```python
"""
シナリオ: サービス割り当てとロール統合
1. テナントにサービスを割り当て
2. 利用可能ロール一覧取得
3. ユーザーにサービスロールを割り当て
4. サービスにアクセス
"""

@pytest.mark.integration
async def test_service_assignment_flow(admin_token, test_tenant_id, test_user_id):
    # 1. サービス割り当て
    assignment_data = {
        "service_id": "file-service",
        "config": {
            "max_storage": "100GB",
            "max_file_size": "10MB"
        }
    }
    assign_response = await client.post(
        f"{SERVICE_SETTING_URL}/api/v1/tenants/{test_tenant_id}/services",
        headers={"Authorization": f"Bearer {admin_token}"},
        json=assignment_data
    )
    assert assign_response.status_code == 201
    
    # 2. 利用可能ロール取得
    roles_response = await client.get(
        f"{SERVICE_SETTING_URL}/api/v1/tenants/{test_tenant_id}/available-roles",
        headers={"Authorization": f"Bearer {admin_token}"}
    )
    assert roles_response.status_code == 200
    roles = roles_response.json()
    assert "file-service" in roles["roles"]
    
    # 3. ユーザーにロール割り当て
    role_response = await client.post(
        f"{AUTH_SERVICE_URL}/api/v1/users/{test_user_id}/roles",
        headers={"Authorization": f"Bearer {admin_token}"},
        json={
            "service_id": "file-service",
            "role_name": "編集者"
        }
    )
    assert role_response.status_code == 201
```

### 3. E2Eテスト（Playwright）

#### 3.1 認証E2Eテスト (`e2e/auth.spec.ts`)
```typescript
import { test, expect } from '@playwright/test';

test.describe('Authentication Flow', () => {
  test('should login successfully', async ({ page }) => {
    await page.goto('http://localhost:3000/login');
    
    // ログインフォーム入力
    await page.fill('input[name="username"]', 'admin@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    
    // ダッシュボードへリダイレクト
    await expect(page).toHaveURL(/.*dashboard/);
    
    // ユーザー情報表示確認
    await expect(page.locator('text=管理者太郎')).toBeVisible();
  });

  test('should show error on invalid credentials', async ({ page }) => {
    await page.goto('http://localhost:3000/login');
    
    await page.fill('input[name="username"]', 'invalid@example.com');
    await page.fill('input[name="password"]', 'wrongpassword');
    await page.click('button[type="submit"]');
    
    // エラーメッセージ表示
    await expect(page.locator('text=Invalid credentials')).toBeVisible();
  });

  test('should logout successfully', async ({ page }) => {
    // ログイン
    await page.goto('http://localhost:3000/login');
    await page.fill('input[name="username"]', 'admin@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    await page.waitForURL(/.*dashboard/);
    
    // ログアウト
    await page.click('button:has-text("Logout")');
    
    // ログインページへリダイレクト
    await expect(page).toHaveURL(/.*login/);
  });
});
```

#### 3.2 テナント管理E2Eテスト (`e2e/tenant-management.spec.ts`)
```typescript
test.describe('Tenant Management', () => {
  test.beforeEach(async ({ page }) => {
    // ログイン
    await page.goto('http://localhost:3000/login');
    await page.fill('input[name="username"]', 'admin@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    await page.waitForURL(/.*dashboard/);
  });

  test('should create a new tenant', async ({ page }) => {
    // テナント一覧ページへ
    await page.goto('http://localhost:3000/dashboard/tenants');
    
    // 新規作成ボタンクリック
    await page.click('button:has-text("Create Tenant")');
    
    // フォーム入力
    await page.fill('input[name="name"]', 'E2E Test Company');
    await page.fill('input[name="display_name"]', 'E2E Test Corp');
    await page.selectOption('select[name="plan"]', 'standard');
    await page.fill('input[name="max_users"]', '50');
    
    // 送信
    await page.click('button[type="submit"]');
    
    // 成功メッセージ確認
    await expect(page.locator('text=Tenant created successfully')).toBeVisible();
    
    // 一覧に表示確認
    await expect(page.locator('text=E2E Test Company')).toBeVisible();
  });

  test('should not allow editing privileged tenant', async ({ page }) => {
    await page.goto('http://localhost:3000/dashboard/tenants/tenant_privileged');
    
    // 編集ボタンが無効または非表示
    const editButton = page.locator('button:has-text("Edit")');
    await expect(editButton).toBeDisabled()
      .or(expect(editButton).not.toBeVisible());
  });
});
```

### 4. テストデータ管理

#### 4.1 Fixtures (`fixtures/users.json`)
```json
{
  "admin_user": {
    "id": "user_admin_001",
    "username": "admin@example.com",
    "email": "admin@example.com",
    "password": "AdminPass123!",
    "display_name": "管理者太郎",
    "tenant_id": "tenant_privileged",
    "is_active": true
  },
  "test_user": {
    "username": "testuser@example.com",
    "email": "testuser@example.com",
    "password": "TestPass123!",
    "display_name": "テストユーザー",
    "tenant_id": "tenant_test",
    "is_active": true
  }
}
```

#### 4.2 テストデータセットアップスクリプト
```python
# tests/utils/setup.py
async def setup_test_data():
    """テストデータの初期化"""
    # 1. 特権テナント作成
    # 2. 管理者ユーザー作成
    # 3. テストテナント作成
    # 4. テストユーザー作成
    # 5. ロール割り当て
```

### 5. テスト自動化

#### 5.1 pytest.ini
```ini
[pytest]
testpaths = tests/integration
python_files = test_*.py
python_classes = Test*
python_functions = test_*
markers =
    integration: Integration tests
    e2e: End-to-end tests
    slow: Slow running tests
    smoke: Smoke tests
```

#### 5.2 playwright.config.ts
```typescript
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  timeout: 30 * 1000,
  retries: 2,
  workers: 4,
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { browserName: 'chromium' },
    },
  ],
});
```

### 6. CI統合

GitHub Actionsで自動実行:
```yaml
# .github/workflows/test.yml
name: Integration Tests

on: [pull_request]

jobs:
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start services
        run: docker-compose -f docker-compose.test.yml up -d
      - name: Run integration tests
        run: pytest tests/integration
      - name: Run E2E tests
        run: npx playwright test
```

## 完了条件

- [ ] テスト環境が構築される
- [ ] 統合テストが実装される:
  - [ ] 認証フローテスト
  - [ ] テナント管理フローテスト
  - [ ] サービス設定フローテスト
  - [ ] サービス横断テスト
- [ ] E2Eテストが実装される:
  - [ ] 認証画面テスト
  - [ ] テナント管理画面テスト
  - [ ] ユーザー管理画面テスト
  - [ ] ダッシュボードテスト
- [ ] テストデータFixturesが作成される
- [ ] テストセットアップスクリプトが動作する
- [ ] 全ての統合テストがパスする
- [ ] 全てのE2Eテストがパスする
- [ ] CIで自動実行される
- [ ] テストカバレッジレポートが生成される
- [ ] README.mdが作成される

## 依存タスク
- 全ての実装タスク (01-19)

## 後続タスク
- 21. CI/CDパイプライン構築
- 24. セキュリティ強化

## 技術的考慮事項

### テストの独立性
- 各テストは独立して実行可能
- テストデータのクリーンアップ
- トランザクションのロールバック

### テストの安定性
- リトライ機能の実装
- タイムアウトの適切な設定
- 非同期処理の待機

### パフォーマンス
- 並列実行の活用
- 必要最小限のテストデータ
- モックの活用（外部依存の削減）

## 参照ドキュメント
- [pytest Documentation](https://docs.pytest.org/)
- [Playwright Documentation](https://playwright.dev/)

## 見積もり工数
- 統合テスト実装: 2日
- E2Eテスト実装: 2日
- テスト環境構築: 1日
- **合計**: 5日

## 備考
- テストは継続的にメンテナンスが必要
- Phase 2で負荷テスト、セキュリティテストを追加
- テストカバレッジ目標: 統合テスト70%以上
