# タスク: 共通ライブラリ実装

## 概要
全てのバックエンドサービスで共通利用するライブラリを実装します。認証Middleware、ロガー、バリデーション、エラーハンドリングなどの基盤機能を提供し、各サービスでの重複実装を避けます。

## 対象コンポーネント
- 全バックエンドサービス (Python/FastAPI)
- 共通ライブラリパッケージ (`/src/common`)

## 前提条件
- タスク01 (インフラ基盤構築) が完了
- Python 3.11開発環境が利用可能
- Cosmos DB接続情報が取得済み

## 実装内容

### 1. 共通ライブラリパッケージ作成

#### 1.1 ディレクトリ構成
```
src/common/
├── common/
│   ├── __init__.py
│   ├── auth/
│   │   ├── __init__.py
│   │   ├── jwt.py              # JWT処理
│   │   ├── middleware.py       # 認証Middleware
│   │   └── dependencies.py     # FastAPI Depends
│   ├── database/
│   │   ├── __init__.py
│   │   ├── cosmos.py           # Cosmos DB接続
│   │   └── repository.py       # 基底Repositoryクラス
│   ├── logging/
│   │   ├── __init__.py
│   │   ├── formatter.py        # JSONフォーマッター
│   │   └── logger.py           # ロガー設定
│   ├── models/
│   │   ├── __init__.py
│   │   ├── base.py             # 基底Pydanticモデル
│   │   └── errors.py           # エラーモデル
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── validators.py       # 汎用バリデーター
│   │   └── helpers.py          # ヘルパー関数
│   └── middleware/
│       ├── __init__.py
│       ├── cors.py             # CORSミドルウェア
│       ├── error_handler.py    # エラーハンドリング
│       └── request_id.py       # リクエストID生成
├── tests/
│   ├── test_auth.py
│   ├── test_database.py
│   └── test_logging.py
├── setup.py
├── requirements.txt
└── README.md
```

### 2. 認証機能実装

#### 2.1 JWT処理 (`common/auth/jwt.py`)
```python
# JWT生成、検証、デコード
- create_access_token(data: dict) -> str
- decode_access_token(token: str) -> dict
- verify_token_signature(token: str) -> bool
```

**機能**:
- HS256アルゴリズムでJWT生成
- 有効期限チェック (デフォルト60分)
- JWT IDの生成・検証
- カスタムクレームのサポート

#### 2.2 認証Middleware (`common/auth/middleware.py`)
```python
# FastAPI Middleware
- JWTAuthenticationMiddleware
  - Authorizationヘッダーからトークン抽出
  - トークン検証
  - request.state.user にユーザー情報設定
  - 認証失敗時は401エラー
```

#### 2.3 FastAPI依存注入 (`common/auth/dependencies.py`)
```python
# FastAPI Depends用
- get_current_user(request: Request) -> User
- require_role(service: str, role: str)
  - ロールベース認可デコレータ
```

### 3. データベース機能実装

#### 3.1 Cosmos DB接続 (`common/database/cosmos.py`)
```python
# Cosmos DB接続管理
- CosmosDBClient クラス
  - 非同期接続プールの管理
  - コンテナへのアクセス
  - クエリ実行ヘルパー
```

**機能**:
- シングルトンパターンでの接続管理
- 複数コンテナへの接続
- コネクションプールの最適化
- エラーハンドリングとリトライ

#### 3.2 基底Repositoryクラス (`common/database/repository.py`)
```python
# CRUDの共通実装
class BaseRepository(Generic[T]):
    async def get(id: str, partition_key: str) -> T
    async def create(item: T) -> T
    async def update(id: str, partition_key: str, data: dict) -> T
    async def delete(id: str, partition_key: str) -> None
    async def query(
        query: str,
        parameters: list,
        partition_key: Optional[str] = None
    ) -> List[T]
    async def list_by_partition(
        partition_key: str,
        limit: int = 100,
        continuation_token: Optional[str] = None
    ) -> Tuple[List[T], Optional[str]]
```

### 4. ロギング機能実装

#### 4.1 JSONフォーマッター (`common/logging/formatter.py`)
```python
# 構造化ログのJSON出力
class JSONFormatter(logging.Formatter):
    - timestamp, level, message, module等を含むJSON出力
    - 追加フィールド (user_id, tenant_id, request_id等) のサポート
    - 例外情報の整形
```

#### 4.2 ロガー設定 (`common/logging/logger.py`)
```python
# アプリケーション全体のロガー設定
- setup_logging(app_name: str, log_level: str) -> logging.Logger
- get_logger(name: str) -> logging.Logger
```

**機能**:
- 環境変数でログレベル制御
- Application Insightsへの統合
- リクエストコンテキストの自動追加

### 5. 共通モデル実装

#### 5.1 基底Pydanticモデル (`common/models/base.py`)
```python
# 全エンティティの基底クラス
class BaseModel(pydantic.BaseModel):
    id: str = Field(default_factory=lambda: str(uuid.uuid4()))
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }
```

#### 5.2 エラーモデル (`common/models/errors.py`)
```python
# 標準化されたエラーレスポンス
class ErrorResponse(BaseModel):
    code: str
    message: str
    details: Optional[dict] = None
    timestamp: datetime = Field(default_factory=datetime.utcnow)
    request_id: Optional[str] = None
```

### 6. ミドルウェア実装

#### 6.1 エラーハンドリング (`common/middleware/error_handler.py`)
```python
# 全ての例外を標準フォーマットで返却
- ErrorHandlerMiddleware
  - HTTPExceptionの処理
  - ValidationErrorの処理
  - 予期しないエラーの処理
  - エラーログの記録
```

#### 6.2 リクエストID生成 (`common/middleware/request_id.py`)
```python
# 各リクエストに一意のIDを付与
- RequestIDMiddleware
  - X-Request-IDヘッダーの生成
  - request.state.request_id に設定
  - レスポンスヘッダーに付与
```

#### 6.3 CORS設定 (`common/middleware/cors.py`)
```python
# CORS設定のヘルパー
- setup_cors(app: FastAPI, allowed_origins: List[str])
```

### 7. ユーティリティ実装

#### 7.1 バリデーター (`common/utils/validators.py`)
```python
# 汎用バリデーション関数
- validate_email(email: str) -> bool
- validate_password_strength(password: str) -> bool
- validate_tenant_id_format(tenant_id: str) -> bool
- validate_uuid(value: str) -> bool
```

#### 7.2 ヘルパー関数 (`common/utils/helpers.py`)
```python
# 汎用ヘルパー
- generate_id(prefix: str) -> str  # "user_" + UUID
- hash_password(password: str) -> str
- verify_password(password: str, hashed: str) -> bool
- mask_sensitive_data(text: str) -> str
```

### 8. テスト実装

各モジュールの単体テストを実装:
- `test_auth.py`: JWT, Middleware
- `test_database.py`: Cosmos DB接続、Repository
- `test_logging.py`: ロガー、フォーマッター
- `test_validators.py`: バリデーター

**カバレッジ目標**: 80%以上

### 9. パッケージング

#### 9.1 setup.py
```python
setup(
    name="management-app-common",
    version="0.1.0",
    packages=find_packages(),
    install_requires=[
        "fastapi>=0.100.0",
        "pydantic[email]>=2.0.0",
        "python-jose[cryptography]>=3.3.0",
        "passlib[bcrypt]>=1.7.4",
        "azure-cosmos>=4.5.0",
        "python-multipart>=0.0.6",
    ]
)
```

#### 9.2 requirements.txt
各サービスで共通ライブラリをインストール:
```
-e ../common
```

## 完了条件

- [ ] 全ての共通ライブラリモジュールが実装される
- [ ] JWT生成・検証が動作する
- [ ] 認証Middlewareがリクエストを検証する
- [ ] Cosmos DB接続が確立し、CRUDが実行できる
- [ ] BaseRepositoryが正常に動作する
- [ ] 構造化ログがJSON形式で出力される
- [ ] エラーハンドリングが標準化される
- [ ] リクエストIDが全リクエストに付与される
- [ ] 全バリデーター・ヘルパーが動作する
- [ ] 単体テストのカバレッジが80%以上
- [ ] ドキュメント (README.md) が作成される
- [ ] 各サービスから共通ライブラリがインポート可能

## 依存タスク
- 01. インフラ基盤構築

## 後続タスク
- 03. 認証認可サービス - コアAPI
- 05. テナント管理サービス - コアAPI
- 07. サービス設定サービス - コアAPI
- 09. モックサービス基盤

## 技術的考慮事項

### パフォーマンス
- Cosmos DB接続プールの最適化
- 非同期処理の活用
- JWT検証のキャッシング (Phase 2)

### セキュリティ
- JWT秘密鍵の環境変数管理
- パスワードハッシュ化 (bcrypt, cost factor 12)
- ログ内の機密情報マスキング

### 保守性
- 各モジュールは単一責任原則に従う
- 明確なインターフェース定義
- 十分なテストカバレッジ

### 拡張性
- プラガブルな設計
- 依存注入パターンの活用
- 設定の外部化

## 参照ドキュメント
- [コンポーネント設計 - 共通ライブラリ](../../arch/components/README.md#8-共通ライブラリ)
- [セキュリティ設計 - 認証](../../arch/security/README.md#2-認証-authentication)
- [データモデル設計](../../arch/data/README.md)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Pydantic Documentation](https://docs.pydantic.dev/)

## 見積もり工数
- 作業時間: 3日
- テスト: 1日
- レビュー: 0.5日
- **合計**: 4.5日

## 備考
- この共通ライブラリは全サービスの基盤となるため、品質を重視
- 後続タスクで必要に応じて機能追加
- Phase 2でキャッシング、リトライ機能などを追加予定
