# 機能仕様書: インフラ基盤構築

## ドキュメント情報
- **バージョン**: 1.0.0
- **作成日**: 2026-02-01
- **対象フェーズ**: Phase1-MVP開発
- **関連タスク**: [01-インフラ基盤構築](../01-インフラ基盤構築.md)

---

## 1. ビジネス目的

### 1.1 なぜ必要か

本タスクは、管理アプリケーションを動作させるための**基盤環境**を構築します。顧客にサービスを提供するためには、安定した実行環境が不可欠であり、このインフラ基盤構築はすべての開発タスクの前提となります。

### 1.2 ビジネス価値

| ビジネス価値 | 説明 |
|------------|------|
| **迅速な市場投入** | 標準化されたインフラにより、開発チームは即座にアプリケーション開発を開始できる |
| **予測可能なコスト** | Azureの最小構成（月額$94）により、MVP段階の投資を最小限に抑えられる |
| **スケーラビリティの確保** | 将来の成長に対応できる拡張可能な設計により、ビジネスの成長を妨げない |
| **運用コストの削減** | Infrastructure as Code（Bicep）による自動化で、手動設定のミスとコストを削減 |
| **監視基盤の確立** | 初期段階から監視体制を構築し、サービス品質とユーザー満足度を確保 |

### 1.3 ビジネス上の前提条件

- **対象市場**: 複数サービスを提供する企業の管理者向け管理アプリケーション
- **初期規模**: Stagingでの検証を想定（Production展開は全機能完成後）
- **コスト制約**: MVP段階であり、過剰な投資は避ける必要がある
- **開発速度優先**: 市場検証のため、迅速な開発環境の提供が重要

---

## 2. 機能要件（簡潔版）

### 2.1 提供する機能

#### 2.1.1 クラウド実行環境の提供
- **説明**: Azure上でアプリケーションを実行可能な環境を提供
- **ビジネス貢献**: ユーザーがインターネット経由でサービスにアクセス可能になる

#### 2.1.2 データストレージの提供
- **説明**: テナント情報、ユーザー情報、サービス設定を保存する Cosmos DB を提供
- **ビジネス貢献**: アプリケーションが複数テナントのデータを安全に管理できる

#### 2.1.3 監視基盤の提供
- **説明**: Application Insights による性能監視とエラー追跡
- **ビジネス貢献**: サービス障害を早期発見し、ビジネス機会損失を最小化

#### 2.1.4 開発環境の提供
- **説明**: ローカル開発用の Cosmos DB Emulator 環境
- **ビジネス貢献**: 開発者がクラウドコストをかけずに迅速に開発可能

### 2.2 環境構成

| 環境 | 目的 | ビジネス上の位置づけ |
|-----|------|-------------------|
| **Development** | ローカル開発 | 開発速度の最大化、コスト削減 |
| **Staging** | 検証・テスト | 顧客提供前の品質保証 |
| **Production** | 本番運用 | Phase1完了後に構築（現時点では対象外） |

### 2.3 構築対象リソース

| リソース | 目的 | ビジネス上の重要性 |
|---------|------|------------------|
| **App Service (Frontend)** | ユーザーインターフェース提供 | 顧客との接点 |
| **App Service (Backend×7)** | ビジネスロジック実行 | サービスの中核機能 |
| **Cosmos DB** | データ永続化 | ビジネスデータの保管 |
| **Application Insights** | 監視・分析 | サービス品質の可視化 |

---

## 3. 非機能要件（簡潔版）

### 3.1 コスト要件

| 項目 | 目標値 | ビジネス上の理由 |
|-----|--------|---------------|
| **月額コスト** | $94以下 | MVP段階での投資最小化 |
| **構成** | App Service B1プラン、Cosmos DB最小RU | コスト対効果の最大化 |

### 3.2 可用性要件

| 項目 | 目標値 | ビジネス上の理由 |
|-----|--------|---------------|
| **稼働時間** | 営業時間内99%（Staging） | MVP検証に十分な品質 |
| **データバックアップ** | 30日間継続的バックアップ | データ損失によるビジネスリスク回避 |

### 3.3 セキュリティ要件

| 項目 | 要件 | ビジネス上の理由 |
|-----|------|---------------|
| **通信暗号化** | HTTPS必須、TLS 1.2以上 | 顧客データ保護、コンプライアンス遵守 |
| **認証** | Azure認証基盤の利用 | セキュリティインシデントによる信用失墜防止 |

### 3.4 拡張性要件

| 項目 | 要件 | ビジネス上の理由 |
|-----|------|---------------|
| **スケーラビリティ** | 自動スケール設定（Phase1では最小構成） | ビジネス成長に合わせた段階的投資が可能 |
| **マルチテナント対応** | Cosmos DBパーティション設計 | 将来の顧客増加に対応 |

---

## 4. 受け入れ基準

### 4.1 機能的受け入れ基準

- [ ] **Staging環境へのデプロイ成功**: Bicep実行でエラーなく全リソースが作成される
- [ ] **リソースの正常動作確認**: 
  - [ ] Cosmos DBにデータベース1つとコンテナ7つが作成されている
  - [ ] App Service 8つ（Frontend + Backend×7）が起動している
  - [ ] Application Insightsがログを収集している
- [ ] **接続性の確認**: 各App ServiceからCosmos DBへの接続が成功する
- [ ] **ローカル開発環境の構築**: DevContainer内でCosmos DB Emulatorが起動する
- [ ] **環境変数テンプレート**: 各サービスの`.env.example`が作成されている

### 4.2 非機能的受け入れ基準

- [ ] **コスト確認**: Azureポータルで月額見積もりが$100以下であることを確認
- [ ] **セキュリティ**: すべてのApp ServiceでHTTPS強制が有効化されている
- [ ] **バックアップ**: Cosmos DBで継続的バックアップ（30日間）が有効化されている
- [ ] **監視**: Application Insightsで基本メトリクス（リクエスト数、応答時間、エラー）が表示される

### 4.3 運用的受け入れ基準

- [ ] **デプロイスクリプト**: `deploy.sh`を実行してデプロイが成功する
- [ ] **削除スクリプト**: `destroy.sh`を実行してリソースが削除される
- [ ] **検証スクリプト**: `validate.sh`を実行してBicepテンプレートが正しいことを確認
- [ ] **ドキュメント**: デプロイ手順が文書化されている

---

## 5. ビジネスリスク

### 5.1 リスク一覧と対策

| リスク | 影響度 | 発生確率 | ビジネスへの影響 | 対策 |
|-------|-------|---------|---------------|------|
| **コストオーバーラン** | 高 | 中 | 予算超過によるプロジェクト継続困難 | ・月次コスト監視アラート設定<br>・最小構成の徹底 |
| **デプロイ失敗** | 高 | 低 | 開発遅延によるリリーススケジュール遅れ | ・Staging環境での事前検証<br>・Bicep検証スクリプトの活用 |
| **セキュリティ設定不備** | 高 | 中 | データ漏洩による信用失墜、法的リスク | ・HTTPS必須化<br>・Azure Security Centerでの定期監査 |
| **パフォーマンス不足** | 中 | 中 | ユーザー体験の低下、検証失敗 | ・Application Insightsでの早期検知<br>・必要に応じたスケールアップ計画 |
| **データ損失** | 高 | 低 | ビジネスデータの消失、信用失墜 | ・継続的バックアップ有効化<br>・リストア手順の文書化 |
| **ベンダーロックイン** | 中 | 高 | 将来的な移行コスト増大 | ・Infrastructure as Code（Bicep）による構成管理<br>・データベース設計の標準化 |

### 5.2 想定される制約

#### 5.2.1 技術的制約
- **Azure依存**: Azureのサービス仕様に依存（他クラウドへの移行時にコストが発生）
- **最小構成の制限**: B1プランは性能に制限があり、本格的な負荷には対応できない

#### 5.2.2 ビジネス的制約
- **MVP前提**: 本格的な商用利用には追加投資が必要
- **Staging環境のみ**: Production環境は全機能完成後に構築（Phase1では顧客提供不可）

---

## 6. 成功の定義

### 6.1 短期的成功指標（Phase1完了時）

| 指標 | 目標値 | ビジネス上の意味 |
|-----|--------|---------------|
| **デプロイ成功率** | 100%（Staging環境） | 開発チームが安定して作業可能 |
| **月額コスト** | $94以下 | 予算内での運用 |
| **インフラ起因の障害** | 0件 | 開発が中断されない |
| **環境構築時間** | 30分以内 | 迅速な環境再現が可能 |

### 6.2 長期的成功指標（Phase2以降）

| 指標 | 目標値 | ビジネス上の意味 |
|-----|--------|---------------|
| **Production稼働率** | 99.9% | 顧客サービスの信頼性 |
| **スケールアップ対応時間** | 24時間以内 | ビジネス成長への迅速な対応 |
| **インフラコストのROI** | 顧客1社あたり月額$10以下 | 収益性の確保 |

---

## 7. 関係者とコミュニケーション

### 7.1 ステークホルダー

| 役割 | 関心事 | このタスクでの期待 |
|-----|-------|------------------|
| **プロダクトオーナー** | ビジネス価値、コスト | 最小投資で迅速な価値提供 |
| **開発チーム** | 開発環境、安定性 | すぐに開発を開始できる環境 |
| **運用チーム** | 監視、トラブルシューティング | 監視基盤の整備 |
| **セキュリティチーム** | データ保護、コンプライアンス | セキュリティ設定の適切性 |
| **経営層** | ROI、リスク管理 | コスト最適化と拡張性のバランス |

### 7.2 報告すべき情報

#### 7.2.1 タスク完了時
- ✅ Staging環境のURL一覧
- ✅ 月額コスト見積もり
- ✅ セキュリティ設定の確認結果
- ✅ 監視ダッシュボードのURL

#### 7.2.2 継続的に報告（Phase1期間中）
- 📊 週次コスト実績（予算との差異）
- 🚨 インフラ起因の障害報告
- 📈 リソース使用率レポート

---

## 8. 次のステップ

### 8.1 このタスク完了後のビジネス的な次のステップ

1. **開発タスクの開始**: 各開発チームがアプリケーション開発を開始
2. **継続的な監視**: Application Insightsを使用したサービス品質の監視
3. **コスト最適化**: 実際の使用状況に基づいた構成の見直し
4. **Production準備**: Phase1完了後、本番環境の計画と構築

### 8.2 依存する後続タスク

このインフラ基盤構築が完了しないと着手できないタスク：

- **02. 共通ライブラリ実装**: Cosmos DB接続、認証ライブラリの開発
- **03. 認証認可サービス - コアAPI**: JWTベースの認証機能の実装
- **21. CI/CDパイプライン構築**: 自動デプロイ環境の整備

---

## 9. 参照ドキュメント

### 9.1 内部ドキュメント
- [サービス概要](../../init.md)
- [デプロイメント設計](../../arch/deployment/README.md)
- [データモデル設計](../../arch/data/README.md)
- [開発タスク一覧](../開発タスク.md)

### 9.2 外部ドキュメント
- [Azure Bicep ドキュメント](https://docs.microsoft.com/azure/azure-resource-manager/bicep/)
- [Azure App Service 料金](https://azure.microsoft.com/pricing/details/app-service/)
- [Cosmos DB 料金](https://azure.microsoft.com/pricing/details/cosmos-db/)

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 承認者 |
|----------|------|---------|--------|
| 1.0.0 | 2026-02-01 | 初版作成 | - |
