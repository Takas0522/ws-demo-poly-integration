# テスト設計書: サービス設定サービス - ロール統合

## 1. テスト概要

### 1.1 テスト対象
タスク08「サービス設定サービス - ロール統合」の実装コードに対する単体テストおよび統合テストを実施します。

**対象モジュール**:
- **Models**: `IntegratedRole`, `ServiceRoleInfo`
- **Schemas**: `IntegratedRolesResponse`, `TenantAvailableRolesResponse`, `ServiceRoleResponse`
- **Services**: `RoleAggregator`
- **APIs**: `roles.py` (統合ロールAPI), `service_roles.py` (サービス設定サービス自身のロール提供)
- **APIs (tenant-management)**: `roles.py` (テナント管理サービスのロール提供)

### 1.2 テスト目的
- 仕様書に定義された要件が正しく実装されていることを検証
- OWASPセキュリティ基準（A01, A05, A07, A09）への準拠を確認
- エッジケース、異常系、境界値における正しい動作を保証
- サービス間通信の認証とエラーハンドリングの妥当性を検証

### 1.3 テストスコープ
**対象範囲**:
- ✅ ロール情報の収集と統合ロジック
- ✅ テナントフィルタリング機能
- ✅ サービス間認証（X-Service-Key）
- ✅ 部分的失敗のハンドリング
- ✅ 並列処理の正確性
- ✅ テナント分離の検証
- ✅ エラーハンドリングとログ記録

**対象外**:
- ❌ 実際のサービス間HTTP通信（モックを使用）
- ❌ Cosmos DBの実際の接続（モックコンテナを使用）
- ❌ フロントエンドUIテスト

## 2. テスト環境

### 2.1 必要なツール
- **テストフレームワーク**: pytest 7.4+
- **非同期テスト**: pytest-asyncio
- **モックライブラリ**: unittest.mock (標準ライブラリ)
- **HTTPクライアント**: httpx (非同期)
- **カバレッジ**: pytest-cov

### 2.2 テストデータ
```python
# サービスデータ
CORE_SERVICES = ["auth-service", "tenant-management", "service-setting"]
MANAGED_SERVICES = ["file-service", "messaging-service", "api-service", "backup-service"]

# テナントデータ
TENANT_PRIVILEGED = "tenant_privileged"
TENANT_REGULAR = "tenant_acme"

# ロール情報サンプル
SAMPLE_ROLES = {
    "auth-service": [
        {"roleName": "全体管理者", "description": "ユーザー登録・削除、ロール割り当て"},
        {"roleName": "閲覧者", "description": "ユーザー情報の参照のみ"}
    ],
    "file-service": [
        {"roleName": "管理者", "description": "全機能へのアクセス"},
        {"roleName": "編集者", "description": "ファイルのアップロード、削除"},
        {"roleName": "閲覧者", "description": "ファイルのダウンロード、一覧表示のみ"}
    ]
}
```

## 3. テストケース一覧

### 3.1 Models層テスト (`test_models/test_role.py`)

| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TM-001 | 正常系 | IntegratedRoleの正常作成 | 有効なサービスID、ロール名、説明 | モデルが正常に作成される | 高 |
| TM-002 | 正常系 | ServiceRoleInfoの正常作成 | 有効なロール名、説明 | モデルが正常に作成される | 高 |
| TM-003 | 正常系 | エイリアス変換（snake_case → camelCase） | service_id, role_name | serviceId, roleNameに変換 | 高 |
| TM-004 | 正常系 | エイリアス変換（camelCase → snake_case） | serviceId, roleName | service_id, role_nameに変換 | 高 |
| TM-005 | 境界値 | description最小長（1文字） | description="A" | 正常に作成される | 中 |
| TM-006 | 境界値 | description最大長（200文字） | description="A"*200 | 正常に作成される | 中 |
| TM-007 | 異常系 | 必須フィールド欠如 | service_idなし | ValidationErrorが発生 | 高 |
| TM-008 | 異常系 | 不正な型 | service_id=123 (int) | ValidationErrorが発生 | 高 |
| TM-009 | エッジケース | Phase 2フィールド（permissions） | permissions=None | デフォルト値Noneが設定 | 低 |
| TM-010 | エッジケース | Phase 2フィールド（is_default） | is_defaultなし | デフォルト値Falseが設定 | 低 |

### 3.2 Schemas層テスト (`test_schemas/test_role.py`)

| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TS-001 | 正常系 | IntegratedRolesResponseの正常作成 | 有効なroles, metadata | レスポンスが正常に作成される | 高 |
| TS-002 | 正常系 | TenantAvailableRolesResponseの正常作成 | tenant_id, roles, metadata | レスポンスが正常に作成される | 高 |
| TS-003 | 正常系 | ServiceRoleResponseの正常作成 | service_id, roles, metadata | レスポンスが正常に作成される | 高 |
| TS-004 | 正常系 | IntegratedRolesMetadataの作成 | total_services=7, failed_services=["backup-service"] | メタデータが正常に作成される | 高 |
| TS-005 | 境界値 | 空のrolesディクショナリ | roles={} | 正常に作成、total_services=0 | 中 |
| TS-006 | 境界値 | 大量のロール（100サービス×10ロール） | 1000ロール | 正常に作成される | 低 |
| TS-007 | 異常系 | 必須フィールド欠如 | rolesフィールドなし | ValidationErrorが発生 | 高 |
| TS-008 | 異常系 | 不正な型（rolesがList） | roles=[] | ValidationErrorが発生 | 高 |
| TS-009 | エッジケース | failedServices空配列 | failed_services=[] | デフォルト値として設定 | 低 |
| TS-010 | エッジケース | cachedAt=None（Phase 2未実装） | cached_at=None | Noneが設定される | 低 |

### 3.3 Services層テスト (`test_services/test_role_aggregator.py`)

| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TSV-001 | 正常系 | fetch_service_roles成功 | 有効なservice_id | ロール情報が取得される | 高 |
| TSV-002 | 正常系 | get_all_service_roles全成功 | 全サービスが正常応答 | 全サービスのロールが統合される | 高 |
| TSV-003 | 正常系 | get_tenant_available_roles（コアサービス） | テナントID | コアサービス3種が常に含まれる | 高 |
| TSV-004 | 正常系 | get_tenant_available_roles（割り当てサービス） | テナント+ServiceAssignment | 割り当てサービスが含まれる | 高 |
| TSV-005 | 正常系 | get_service_roles成功 | 有効なservice_id | 特定サービスのロールが取得される | 高 |
| TSV-006 | 正常系 | 並列処理の正確性 | 7サービス | 並列でロール取得が実行される | 高 |
| TSV-007 | 異常系 | fetch_service_rolesタイムアウト | timeout=0.5秒 | TimeoutExceptionが発生 | 高 |
| TSV-008 | 異常系 | fetch_service_rolesでHTTPエラー | 404/503レスポンス | HTTPStatusErrorが発生 | 高 |
| TSV-009 | 異常系 | サービスURL未設定 | service_idに対応するURLなし | ValueErrorが発生 | 高 |
| TSV-010 | 部分失敗 | 一部サービスのロール取得失敗 | 3/7サービスが失敗 | 成功したサービスのロールは返却 | 高 |
| TSV-011 | 部分失敗 | 全サービスのロール取得失敗 | 全サービスが失敗 | HTTPException(503)が発生 | 高 |
| TSV-012 | 境界値 | タイムアウト直前（499ms） | 499ms応答 | 正常にロール取得 | 中 |
| TSV-013 | 境界値 | タイムアウト直後（501ms） | 501ms応答 | TimeoutExceptionが発生 | 中 |
| TSV-014 | エッジケース | ServiceAssignmentなしのテナント | active割り当て0件 | コアサービスのみ返却 | 中 |
| TSV-015 | エッジケース | 不正なレスポンス形式 | dataフィールドなし | エラーハンドリングが実行 | 中 |
| TSV-016 | エッジケース | レスポンスが空配列 | data=[] | 空配列が正常に処理される | 低 |
| TSV-017 | ログ検証 | ロール取得成功ログ | 正常実行 | INFOログが記録される | 中 |
| TSV-018 | ログ検証 | タイムアウトログ | タイムアウト発生 | WARNINGログが記録される | 中 |
| TSV-019 | ログ検証 | HTTPエラーログ | HTTPエラー発生 | ERRORログが記録され、レスポンス200文字制限 | 高 |

### 3.4 APIs層テスト (`test_api/test_roles.py`)

| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TA-001 | 正常系 | GET /api/v1/integrated-roles成功 | 認証ヘッダー | 200 OK + 統合ロール情報 | 高 |
| TA-002 | 正常系 | GET /api/v1/tenants/{id}/available-roles成功 | 自テナントID | 200 OK + フィルタリングされたロール | 高 |
| TA-003 | 正常系 | GET /api/v1/services/{id}/roles成功 | 有効なservice_id | 200 OK + サービスロール情報 | 高 |
| TA-004 | 正常系 | レスポンス形式の検証 | - | 仕様書通りのJSON構造 | 高 |
| TA-005 | 正常系 | メタデータの正確性 | - | totalServices, totalRolesが正確 | 高 |
| TA-006 | 認証 | 認証ヘッダーなし | Authorizationなし | 401 Unauthorized | 高 |
| TA-007 | 認証 | 不正なトークン | 無効なJWT | 401 Unauthorized | 高 |
| TA-008 | 認可 | service-setting:閲覧者ロールで実行 | 閲覧者ロール | 200 OK | 中 |
| TA-009 | 認可 | 不足したロール | 他サービスのロールのみ | 403 Forbidden | 中 |
| TA-010 | テナント分離 | 他テナントのavailable-roles取得試行 | 異なるtenant_id | 403 Forbidden | 高 |
| TA-011 | テナント分離 | 特権テナントが他テナント取得 | 特権テナント + 他tenant_id | 200 OK | 高 |
| TA-012 | 異常系 | 存在しないサービスID | nonexistent-service | 404 Not Found | 高 |
| TA-013 | 異常系 | 存在しないテナントID | nonexistent-tenant | 404 Not Found | 高 |
| TA-014 | 異常系 | 全サービス障害 | 全サービスが503 | 503 Service Unavailable | 高 |
| TA-015 | 部分失敗 | 一部サービス障害 | 3/7サービスが失敗 | 200 OK + metadata.failedServices | 高 |
| TA-016 | 境界値 | クエリパラメータinclude_service_ids | "file-service,messaging-service" | 指定サービスのみ返却 | 低 |
| TA-017 | エッジケース | 未実装のクエリパラメータ | 不正なパラメータ | 無視される（エラーにならない） | 低 |

### 3.5 サービス間認証テスト (`test_api/test_service_roles.py`, `test_api_roles.py`)

| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TSA-001 | 正常系 | GET /api/v1/roles（X-Service-Key有効） | 正しいX-Service-Key | 200 OK + ロール一覧 | 高 |
| TSA-002 | 正常系 | service-setting自身のロール取得 | - | 2ロール（全体管理者、閲覧者） | 高 |
| TSA-003 | 正常系 | tenant-management自身のロール取得 | - | 3ロール（全体管理者、管理者、閲覧者） | 高 |
| TSA-004 | セキュリティ | X-Service-Keyなし | ヘッダーなし | 401 Unauthorized | 高 |
| TSA-005 | セキュリティ | X-Service-Key不正 | 間違ったキー | 401 Unauthorized | 高 |
| TSA-006 | セキュリティ | 空のX-Service-Key | 空文字列 | 401 Unauthorized | 高 |
| TSA-007 | ログ検証 | 認証失敗のログ記録 | 不正なキー | WARNINGログ + remote_addr記録 | 高 |
| TSA-008 | セキュリティ | タイミング攻撃への耐性 | 異なる長さのキー | 定数時間比較（推奨） | 低 |
| TSA-009 | エッジケース | X-Service-Keyが大文字小文字違い | 異なる大文字小文字 | 401 Unauthorized | 中 |
| TSA-010 | エッジケース | 複数のX-Service-Keyヘッダー | 複数ヘッダー | 最初のヘッダーが評価される | 低 |

## 4. モック設計

### 4.1 モック対象

#### 4.1.1 HTTPクライアント（httpx.AsyncClient）
```python
mock_http_client = AsyncMock()

async def mock_get(url, **kwargs):
    """サービスからのロール情報取得をモック"""
    mock_response = AsyncMock()
    mock_response.status_code = 200
    mock_response.raise_for_status = AsyncMock()
    
    if "auth-service" in url:
        mock_response.json.return_value = {
            "data": [
                {"roleName": "全体管理者", "description": "ユーザー登録・削除"},
                {"roleName": "閲覧者", "description": "ユーザー情報の参照のみ"}
            ]
        }
    # 他のサービスも同様にモック
    
    return mock_response

mock_http_client.get = mock_get
```

#### 4.1.2 Cosmos DBコンテナ
既存のconftest.pyの`mock_cosmos_container`を使用

#### 4.1.3 ServiceRepository
```python
mock_service_repository = AsyncMock()
mock_service_repository.list_all.return_value = [
    Service(id="auth-service", ..., is_active=True),
    Service(id="file-service", ..., is_active=True),
    # ...
]
mock_service_repository.get_service.return_value = Service(...)
```

#### 4.1.4 ServiceAssignmentRepository
```python
mock_assignment_repository = AsyncMock()
mock_assignment_repository.list_by_tenant.return_value = [
    ServiceAssignment(service_id="file-service", status="active", ...),
    # ...
]
```

### 4.2 モックデータ構造

#### サービスデータ
```python
TEST_SERVICES = [
    {
        "id": "auth-service",
        "tenant_id": "_system",
        "type": "service",
        "name": "認証認可サービス",
        "is_active": True,
        "version": "1.0.0",
        "created_at": datetime.utcnow(),
        "updated_at": datetime.utcnow()
    },
    # ... 他のサービス
]
```

#### ロール情報データ
```python
MOCK_ROLE_RESPONSES = {
    "auth-service": {
        "data": [
            {"roleName": "全体管理者", "description": "ユーザー登録・削除、ロール割り当て"},
            {"roleName": "閲覧者", "description": "ユーザー情報の参照のみ"}
        ]
    },
    "file-service": {
        "data": [
            {"roleName": "管理者", "description": "全機能へのアクセス"},
            {"roleName": "編集者", "description": "ファイルのアップロード、削除"},
            {"roleName": "閲覧者", "description": "ファイルのダウンロード、一覧表示のみ"}
        ]
    },
    # ... 他のサービス
}
```

## 5. カバレッジ目標

| 種類 | 目標 | 測定方法 |
|------|------|----------|
| 行カバレッジ | 80%以上 | pytest-cov |
| 分岐カバレッジ | 70%以上 | pytest-cov --cov-branch |
| 重要ロジック | 100% | 手動レビュー |

**重要ロジック**（100%カバレッジ必須）:
- ✅ サービス間認証チェック（X-Service-Key）
- ✅ テナント分離チェック
- ✅ 並列ロール取得とエラーハンドリング
- ✅ 部分的失敗のハンドリング
- ✅ タイムアウト処理

## 6. テスト実行方法

### 6.1 全テスト実行
```bash
# service-setting-service
cd /workspaces/ws-demo-poly-integration/src/service-setting-service
pytest tests/test_models/test_role.py -v
pytest tests/test_schemas/test_role.py -v
pytest tests/test_services/test_role_aggregator.py -v
pytest tests/test_api/test_roles.py -v
pytest tests/test_api/test_service_roles.py -v

# tenant-management-service
cd /workspaces/ws-demo-poly-integration/src/tenant-management-service
pytest tests/test_api_roles.py -v
```

### 6.2 カバレッジ測定
```bash
# service-setting-service
pytest tests/test_models/test_role.py \
       tests/test_schemas/test_role.py \
       tests/test_services/test_role_aggregator.py \
       tests/test_api/test_roles.py \
       tests/test_api/test_service_roles.py \
       --cov=app/models/role \
       --cov=app/schemas/role \
       --cov=app/services/role_aggregator \
       --cov=app/api/roles \
       --cov=app/api/service_roles \
       --cov-report=html \
       --cov-report=term

# tenant-management-service
pytest tests/test_api_roles.py \
       --cov=app/api/roles \
       --cov-report=html \
       --cov-report=term
```

### 6.3 特定カテゴリのみ実行
```bash
# 正常系のみ
pytest -k "Test正常系" -v

# 異常系のみ
pytest -k "Test異常系" -v

# セキュリティテストのみ
pytest -k "security or セキュリティ" -v
```

## 7. 品質基準

### 7.1 テスト成功基準
- ✅ すべてのテストケースがPASS
- ✅ 行カバレッジ80%以上
- ✅ 分岐カバレッジ70%以上
- ✅ 重要ロジックのカバレッジ100%
- ✅ コンパイル/構文エラーなし

### 7.2 品質保証観点（ISTQB準拠）
1. **機能適合性**: 仕様書の要件を満たす
2. **信頼性**: エラーハンドリングが適切
3. **セキュリティ**: 認証・認可が正しく機能
4. **保守性**: テストコードが読みやすく理解しやすい
5. **移植性**: 環境依存なし（モックを使用）

### 7.3 非機能要件の検証
- **パフォーマンス**: タイムアウト処理の正確性（500ms）
- **並列処理**: asyncio.gatherの動作検証
- **ログ記録**: 構造化ログの正確性
- **エラーメッセージ**: エラーコードの一貫性

## 8. 付録

### 8.1 テスト技法（ISTQB準拠）

#### 同値分割法
- **正常系**: 有効なservice_id, tenant_id, role_name
- **異常系**: 不正な形式の入力、存在しないID

#### 境界値分析
- **タイムアウト**: 499ms（成功）、501ms（失敗）
- **説明文字数**: 1文字（最小）、200文字（最大）
- **サービス数**: 0サービス、7サービス、100サービス

#### デシジョンテーブル

| テナント種別 | 要求対象 | ServiceAssignment | 結果 |
|--------------|----------|-------------------|------|
| 特権 | 他テナント | あり/なし | 許可 |
| 一般 | 自テナント | あり | コア+割り当てサービス |
| 一般 | 自テナント | なし | コアサービスのみ |
| 一般 | 他テナント | - | 拒否(403) |

#### 状態遷移テスト
```
初期状態 → ロール取得要求 → [成功] → 統合ロール返却 → 終了
                           → [一部失敗] → 部分ロール返却 → 終了
                           → [全失敗] → 503エラー → 終了
```

### 8.2 リスクベース分析

| リスク | 影響度 | 発生確率 | 優先度 | テストケース |
|--------|--------|----------|--------|--------------|
| サービス間認証の不備 | 高 | 中 | 高 | TSA-004, TSA-005 |
| テナント分離違反 | 高 | 中 | 高 | TA-010, TA-011 |
| 全サービス障害時の処理 | 高 | 低 | 高 | TSV-011, TA-014 |
| タイムアウト処理の不具合 | 中 | 中 | 中 | TSV-007, TSV-012 |
| 並列処理の競合 | 中 | 低 | 中 | TSV-006 |
| ログの機密情報漏洩 | 高 | 低 | 高 | TSV-019 |

---

**文書管理情報**:
- **作成日**: 2026-02-02
- **作成者**: Test Planner Agent
- **バージョン**: 1.0.0
- **関連仕様書**: [08-サービス設定サービス-ロール統合.md](./08-サービス設定サービス-ロール統合.md)
- **実装レビュー**: [08-サービス設定サービス-ロール統合-impl-review-002.md](../review/08-サービス設定サービス-ロール統合-impl-review-002.md)
