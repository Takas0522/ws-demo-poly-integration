# テストプラン構築レポート: テナント管理サービス - ユーザー・ドメイン管理

## 対象機能
タスク06「テナント管理サービス - ユーザー・ドメイン管理」

- TenantUser管理（ユーザー招待・削除・一覧取得）
- Domain管理（ドメイン追加・検証・削除・一覧取得）

## テストケース数

### Model層
- **TenantUser**: 5件（正常系3件、境界値2件）
- **Domain**: 6件（正常系4件、境界値2件）
- **小計**: 11件

### Schema層
- **TenantUserスキーマ**: 8件（正常系5件、異常系3件）
- **Domainスキーマ**: 13件（正常系7件、異常系4件、境界値4件）
- **小計**: 21件

### Repository層
- **TenantUserRepository**: 11件（正常系8件、境界値2件、異常系2件）
- **DomainRepository**: 11件（正常系8件、異常系3件）
- **小計**: 22件

### Service層
- **TenantUserService**: 24件（正常系10件、異常系9件、エッジケース4件）
- **DomainService**: 18件（正常系11件、異常系7件）
- **AuthServiceClient**: 12件（正常系4件、異常系5件、リトライ3件）
- **小計**: 54件

### API層
- **TenantUsers API**: 13件（正常系4件、境界値3件、異常系6件）
- **Domains API**: 12件（正常系5件、異常系7件）
- **小計**: 25件

---

## 合計テストケース数: 133件

| レイヤー | 正常系 | 異常系 | 境界値 | エッジケース | 合計 |
|---------|-------|-------|-------|------------|------|
| Model | 7 | 0 | 4 | 0 | 11 |
| Schema | 12 | 7 | 4 | 0 | 21 |
| Repository | 16 | 5 | 2 | 0 | 22 |
| Service | 25 | 21 | 0 | 8 | 54 |
| API | 9 | 13 | 3 | 0 | 25 |
| **合計** | **69** | **46** | **13** | **8** | **133** |

---

## 作成したテストファイル

### Model層
- [tests/test_models_tenant_user.py](../../../src/tenant-management-service/tests/test_models_tenant_user.py)
- [tests/test_models_domain.py](../../../src/tenant-management-service/tests/test_models_domain.py)

### Schema層
- [tests/test_schemas_tenant_user.py](../../../src/tenant-management-service/tests/test_schemas_tenant_user.py)
- [tests/test_schemas_domain.py](../../../src/tenant-management-service/tests/test_schemas_domain.py)

### Repository層
- [tests/test_repositories_tenant_user.py](../../../src/tenant-management-service/tests/test_repositories_tenant_user.py)
- [tests/test_repositories_domain.py](../../../src/tenant-management-service/tests/test_repositories_domain.py)

### Service層
- [tests/test_services_tenant_user.py](../../../src/tenant-management-service/tests/test_services_tenant_user.py)
- [tests/test_services_domain.py](../../../src/tenant-management-service/tests/test_services_domain.py)
- [tests/test_services_auth_client.py](../../../src/tenant-management-service/tests/test_services_auth_client.py)

### API層
- [tests/test_api_tenant_users.py](../../../src/tenant-management-service/tests/test_api_tenant_users.py)
- [tests/test_api_domains.py](../../../src/tenant-management-service/tests/test_api_domains.py)

---

## カバレッジ目標

| レイヤー | 行カバレッジ | 分岐カバレッジ | 備考 |
|---------|------------|--------------|------|
| Model | 90% | 80% | シンプルなデータクラス |
| Schema | 85% | 75% | バリデーションロジック |
| Repository | 80% | 70% | Cosmos DB操作 |
| Service | 80% | 75% | ビジネスロジック |
| API | 75% | 70% | エンドポイント |
| **全体目標** | **80%** | **70%** | - |

---

## テストコード構造

### 命名規則
- **クラス名**: `Test{対象クラス名}{メソッド名}`（Serviceの場合）
- **メソッド名**: `test_should_{期待する振る舞い}_{条件}`
- **テストカテゴリ**: `Test正常系`, `Test異常系`, `Test境界値`, `Testエッジケース`

### テストメソッドの構造
```python
class TestTenantUserService:
    """TenantUserServiceのテスト"""

    class Test正常系:
        """正常系テスト"""

        @pytest.mark.asyncio
        async def test_should_invite_user_successfully(self):
            """ユーザー招待が成功する"""
            # TODO: テスト実装
            pass
```

---

## モック設計

### Repository層テスト
- **Cosmos DB Container**: `AsyncMock`を使用してCosmos DB操作をモック化
- **メソッド**: `create_item`, `read_item`, `query_items`, `delete_item`, `upsert_item`

### Service層テスト
- **Repository**: リポジトリメソッドをモック化
- **AuthServiceClient**: 認証サービスとの通信をモック化
- **DNS Resolver**: `dnspython`のResolverをモック化

### API層テスト
- **FastAPI TestClient**: `app`をマウントしてテスト
- **Service依存注入**: `Depends`をオーバーライドしてモックServiceを注入

---

## テスト実行方法

### 全テスト実行
```bash
cd /workspace/src/tenant-management-service

# 全テスト実行（カバレッジ測定）
pytest tests/test_models_tenant_user.py \
       tests/test_models_domain.py \
       tests/test_schemas_tenant_user.py \
       tests/test_schemas_domain.py \
       tests/test_repositories_tenant_user.py \
       tests/test_repositories_domain.py \
       tests/test_services_tenant_user.py \
       tests/test_services_domain.py \
       tests/test_services_auth_client.py \
       tests/test_api_tenant_users.py \
       tests/test_api_domains.py \
       -v --cov=app --cov-report=html --cov-report=term

# カバレッジレポート表示
open htmlcov/index.html
```

### レイヤー別実行
```bash
# Model層のみ
pytest tests/test_models_*.py -v

# Schema層のみ
pytest tests/test_schemas_*.py -v

# Repository層のみ
pytest tests/test_repositories_*.py -v

# Service層のみ
pytest tests/test_services_*.py -v

# API層のみ
pytest tests/test_api_*.py -v
```

### 特定のテストクラスのみ実行
```bash
pytest tests/test_services_tenant_user.py::TestTenantUserServiceInviteUser -v
```

---

## 次のステップ

### Phase 1（現在）
- [x] テスト設計書作成
- [x] テストコードの枠組み作成（メソッド内部実装は空）
- [ ] テスト実装（各開発者が担当）
- [ ] カバレッジ測定
- [ ] テスト実行結果レポート作成

### Phase 2（今後）
- [ ] JWT検証のテスト追加
- [ ] ロールベース認可のテスト追加
- [ ] 実際のDNS検証テスト（モックから切り替え）
- [ ] パフォーマンステスト実装
- [ ] セキュリティテスト実装

---

## 備考

### テストの優先度
- **高優先度**: 正常系、主要な異常系（404, 409, 400）
- **中優先度**: 境界値、エッジケース、リトライロジック
- **低優先度**: 詳細なバリデーション、ログ記録確認

### テストデータ
- **テナントID**: `tenant_test_123`
- **ユーザーID**: `user_550e8400-e29b-41d4-a716-446655440000`
- **ドメイン**: `example.com`, `test.com`
- **検証トークン**: `txt-verification-abc123...`（32文字）

### 依存関係
- pytest 7.4.3
- pytest-asyncio 0.21.1
- pytest-cov 4.1.0
- httpx 0.25.1
- aioresponses（HTTPモック用）

---

## 完了条件チェックリスト

- [x] すべてのテストケースがテストコードとして定義されている
- [x] テストの枠組み（describe/it または class/method）が作成されている
- [x] 各テストメソッドに適切なコメント（docstring）がある
- [x] 各テストメソッドにArrange-Act-Assert構造のコメントが追加されている
- [x] モックの構造が設計されている（fixtureとして定義）
- [x] conftest.pyにTenantUser、Domain、認証サービス、DNSのフィクスチャが追加されている
- [x] テストコードがPython構文エラーなく通る
- [x] pytest実行時にエラーにならない最小限の実装が完了している
- [x] テスト設計書が作成されている
- [x] テストプラン構築レポートが作成されている

---

## 改善履歴

### 2026-02-01: レビュー指摘対応（改善工程）

**改善内容:**
1. **conftest.pyのフィクスチャ拡張**
   - TenantUserモデル用フィクスチャ追加（`sample_tenant_user`, `sample_tenant_user_data`）
   - Domainモデル用フィクスチャ追加（`sample_domain`, `verified_domain`, `sample_domain_data`）
   - 認証サービスクライアント用モック追加（`mock_auth_service_user_response`, `mock_httpx_client_success`）
   - DNS用モック追加（`mock_dns_resolver`, `mock_dns_txt_records`）
   - 境界値テストデータ追加（`INVALID_DOMAINS`, `VALID_DOMAINS`）

2. **テストコードの骨組み改善**
   - 全テストメソッドにArrange-Act-Assert構造のコメントを追加
   - 各テストメソッドに適切なフィクスチャパラメータを追加
   - モック設定の具体例を追加（実装は工程3-5で行う旨を明記）

3. **pytest実行可能性の確保**
   - 全フィクスチャが正しく定義されている
   - テストメソッドは`pass`で最小限の実装（実装は工程3-5で実施）
   - 構文エラーなし（VSCode診断で確認済み）

**参考資料:**
- タスク05のTEST_IMPLEMENTATION_REPORT_FINAL.md
- auth-serviceのテスト実装パターン

---

**テストプラン構築完了日**: 2026-02-01  
**改善完了日**: 2026-02-01  
**対象タスク**: タスク06 - テナント管理サービス - ユーザー・ドメイン管理  
**テストケース総数**: 133件  
**カバレッジ目標**: 行カバレッジ 80%以上、分岐カバレッジ 70%以上
