# テスト設計書: テナント管理サービス - ユーザー・ドメイン管理

## 1. テスト概要

### 1.1 テスト対象
- **TenantUser管理**: ユーザー招待、一覧取得、削除
- **Domain管理**: ドメイン追加、検証、一覧取得、削除
- **対象レイヤー**: Model, Schema, Repository, Service, API

### 1.2 テスト目的
タスク06「テナント管理サービス - ユーザー・ドメイン管理」の実装が仕様を満たしていることを確認する。

### 1.3 テストスコープ
- ✅ Model層: TenantUser, Domain
- ✅ Schema層: バリデーション、シリアライゼーション
- ✅ Repository層: CRUD操作、クエリ
- ✅ Service層: ビジネスロジック、外部サービス連携
- ✅ API層: エンドポイント、エラーハンドリング

## 2. テスト環境

### 2.1 必要なツール
- pytest 7.4.3
- pytest-asyncio 0.21.1
- pytest-cov 4.1.0
- httpx 0.25.1（HTTPクライアント）
- aioresponses（HTTPモック）
- unittest.mock（モック）

### 2.2 テストデータ
- テナントID: `tenant_test_123`
- ユーザーID: `user_550e8400-e29b-41d4-a716-446655440000`
- ドメイン: `example.com`, `test.com`

## 3. テストケース一覧

### 3.1 Model層テスト

#### TenantUser Model
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TM001 | 正常系 | TenantUserモデルの作成 | 有効なデータ | インスタンス作成成功 | 高 |
| TM002 | 正常系 | フィールドのエイリアス変換 | camelCase | 正しく変換される | 高 |
| TM003 | 境界値 | 日時フィールドのISO形式変換 | datetime | ISO8601形式 | 中 |

#### Domain Model
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| DM001 | 正常系 | Domainモデルの作成 | 有効なデータ | インスタンス作成成功 | 高 |
| DM002 | 正常系 | verification_tokenのデフォルト値 | - | verifiedはFalse | 高 |
| DM003 | 境界値 | Optional フィールド | None値 | 適切に処理される | 中 |

### 3.2 Schema層テスト

#### TenantUser Schema
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TS001 | 正常系 | TenantUserCreateRequest: 有効なデータ | 有効なuser_id | バリデーション成功 | 高 |
| TS002 | 異常系 | TenantUserCreateRequest: user_id空文字 | "" | ValidationError | 高 |
| TS003 | 正常系 | TenantUserResponse: シリアライゼーション | TenantUser | JSONに変換される | 高 |
| TS004 | 正常系 | TenantUserListResponse: ページネーション | data + pagination | 正しく構造化される | 中 |

#### Domain Schema
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| DS001 | 正常系 | DomainCreateRequest: 有効なドメイン | "example.com" | バリデーション成功 | 高 |
| DS002 | 異常系 | DomainCreateRequest: 不正なドメイン形式 | "invalid" | ValidationError | 高 |
| DS003 | 異常系 | DomainCreateRequest: 禁止ドメイン | "localhost" | ValidationError | 高 |
| DS004 | 境界値 | DomainCreateRequest: 最小長 | "a.io" | バリデーション成功 | 中 |
| DS005 | 境界値 | DomainCreateRequest: 最大長 | 253文字 | バリデーション成功 | 中 |
| DS006 | 正常系 | DomainResponse: 検証手順付き | Domain + instructions | 正しく構造化される | 高 |

### 3.3 Repository層テスト

#### TenantUserRepository
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TR001 | 正常系 | create: TenantUser作成 | 有効なTenantUser | 作成されたTenantUser | 高 |
| TR002 | 正常系 | get: TenantUser取得 | id, partition_key | TenantUser取得 | 高 |
| TR003 | 正常系 | get: 存在しないTenantUser | 存在しないid | None | 高 |
| TR004 | 正常系 | delete: 物理削除 | id, partition_key | 削除成功 | 高 |
| TR005 | 正常系 | find_by_user: ユーザーIDで検索 | tenant_id, user_id | TenantUser取得 | 高 |
| TR006 | 正常系 | find_by_user: 重複なし | tenant_id, user_id | None | 高 |
| TR007 | 正常系 | list_by_tenant: 一覧取得 | tenant_id, skip, limit | TenantUser配列 | 高 |
| TR008 | 境界値 | list_by_tenant: ページネーション | skip=10, limit=5 | 正しく取得 | 中 |
| TR009 | 正常系 | count_by_tenant: カウント取得 | tenant_id | ユーザー数 | 高 |

#### DomainRepository
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| DR001 | 正常系 | create: Domain作成 | 有効なDomain | 作成されたDomain | 高 |
| DR002 | 正常系 | get: Domain取得 | id, partition_key | Domain取得 | 高 |
| DR003 | 正常系 | get: 存在しないDomain | 存在しないid | None | 高 |
| DR004 | 正常系 | update: Domain更新 | id, data | 更新されたDomain | 高 |
| DR005 | 正常系 | delete: 物理削除 | id, partition_key | 削除成功 | 高 |
| DR006 | 正常系 | list_by_tenant: 全て取得 | tenant_id | Domain配列 | 高 |
| DR007 | 正常系 | list_by_tenant: verified=True | tenant_id, verified=True | 検証済みのみ | 高 |
| DR008 | 正常系 | list_by_tenant: verified=False | tenant_id, verified=False | 未検証のみ | 高 |

### 3.4 Service層テスト

#### TenantUserService
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TUS001 | 正常系 | invite_user: 招待成功 | 有効なデータ | TenantUser作成 | 高 |
| TUS002 | 異常系 | invite_user: テナント不存在 | 存在しないtenant_id | ValueError | 高 |
| TUS003 | 異常系 | invite_user: ユーザー不存在 | 存在しないuser_id | ValueError | 高 |
| TUS004 | 異常系 | invite_user: 重複招待 | 既存user_id | ValueError | 高 |
| TUS005 | 異常系 | invite_user: 最大ユーザー数超過 | user_count >= max_users | ValueError | 高 |
| TUS006 | 異常系 | invite_user: 認証サービス不可 | タイムアウト | RuntimeError | 高 |
| TUS007 | 正常系 | invite_user: user_count自動インクリメント | TenantUser作成 | user_count+1 | 高 |
| TUS008 | 正常系 | list_tenant_users: 一覧取得 | tenant_id | ユーザー一覧 | 高 |
| TUS009 | 正常系 | list_tenant_users: include_total=True | tenant_id, include_total | total含む | 高 |
| TUS010 | 正常系 | list_tenant_users: include_total=False | tenant_id | total省略 | 中 |
| TUS011 | 正常系 | list_tenant_users: ユーザー詳細並列取得 | 複数TenantUser | 詳細情報マージ | 高 |
| TUS012 | エッジケース | list_tenant_users: 詳細取得失敗 | ユーザー1件失敗 | 部分的失敗許容 | 中 |
| TUS013 | 正常系 | remove_user: 削除成功 | tenant_id, user_id | 削除成功 | 高 |
| TUS014 | 異常系 | remove_user: TenantUser不存在 | 存在しないuser_id | ValueError | 高 |
| TUS015 | 正常系 | remove_user: user_count自動デクリメント | TenantUser削除 | user_count-1 | 高 |

#### DomainService
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| DS101 | 正常系 | add_domain: ドメイン追加成功 | 有効なドメイン | Domain作成 | 高 |
| DS102 | 異常系 | add_domain: テナント不存在 | 存在しないtenant_id | ValueError | 高 |
| DS103 | 正常系 | add_domain: 検証トークン生成 | - | txt-verification-* | 高 |
| DS104 | 正常系 | verify_domain: 検証成功 | DNS正常 | verified=True | 高 |
| DS105 | 異常系 | verify_domain: Domain不存在 | 存在しないdomain_id | ValueError | 高 |
| DS106 | 異常系 | verify_domain: 検証失敗 | TXTレコード不一致 | ValueError | 高 |
| DS107 | 正常系 | verify_domain: 既に検証済み | verified=True | スキップ | 中 |
| DS108 | 異常系 | verify_domain: DNS Timeout | タイムアウト | 最大3回リトライ | 高 |
| DS109 | 異常系 | verify_domain: NXDOMAIN | ドメイン不存在 | ValueError | 中 |
| DS110 | 異常系 | verify_domain: NoAnswer | TXTレコードなし | ValueError | 中 |
| DS111 | 正常系 | list_domains: 全て取得 | tenant_id | Domain配列 | 高 |
| DS112 | 正常系 | list_domains: verified=True | tenant_id, verified | 検証済みのみ | 高 |
| DS113 | 正常系 | delete_domain: 削除成功 | tenant_id, domain_id | 削除成功 | 高 |
| DS114 | 異常系 | delete_domain: Domain不存在 | 存在しないdomain_id | ValueError | 高 |

#### AuthServiceClient
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| AS001 | 正常系 | verify_user_exists: ユーザー存在 | 有効なuser_id | True | 高 |
| AS002 | 異常系 | verify_user_exists: ユーザー不存在 | 存在しないuser_id | ValueError | 高 |
| AS003 | 異常系 | verify_user_exists: タイムアウト | タイムアウト | RuntimeError | 高 |
| AS004 | 異常系 | verify_user_exists: 認証失敗 | 401 | Exception | 高 |
| AS005 | 異常系 | verify_user_exists: サービスエラー | 503 | RuntimeError | 高 |
| AS006 | 正常系 | verify_user_exists: リトライ成功 | 2回目で成功 | True | 中 |
| AS007 | 正常系 | get_user_details: 詳細取得成功 | 有効なuser_id | ユーザー詳細 | 高 |
| AS008 | エッジケース | get_user_details: 取得失敗 | エラー | None（fallback） | 中 |

### 3.5 API層テスト

#### TenantUsers API
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| TA001 | 正常系 | POST /tenants/{id}/users: 招待成功 | 有効なデータ | 201 Created | 高 |
| TA002 | 異常系 | POST /tenants/{id}/users: テナント不存在 | 存在しないid | 404 Not Found | 高 |
| TA003 | 異常系 | POST /tenants/{id}/users: ユーザー不存在 | 存在しないuser_id | 404 Not Found | 高 |
| TA004 | 異常系 | POST /tenants/{id}/users: 重複招待 | 既存user_id | 409 Conflict | 高 |
| TA005 | 異常系 | POST /tenants/{id}/users: 最大ユーザー数超過 | max超過 | 400 Bad Request | 高 |
| TA006 | 異常系 | POST /tenants/{id}/users: 認証サービス不可 | 503 | 503 Service Unavailable | 高 |
| TA007 | 正常系 | GET /tenants/{id}/users: 一覧取得成功 | tenant_id | 200 OK | 高 |
| TA008 | 境界値 | GET /tenants/{id}/users: limit=100 | limit=100 | 200 OK | 中 |
| TA009 | 異常系 | GET /tenants/{id}/users: limit>100 | limit=101 | 400 Bad Request | 高 |
| TA010 | 異常系 | GET /tenants/{id}/users: skip<0 | skip=-1 | 400 Bad Request | 高 |
| TA011 | 正常系 | DELETE /tenants/{id}/users/{uid}: 削除成功 | 有効なid | 204 No Content | 高 |
| TA012 | 異常系 | DELETE /tenants/{id}/users/{uid}: 不存在 | 存在しないid | 404 Not Found | 高 |

#### Domains API
| ID | カテゴリ | テストケース | 入力 | 期待結果 | 優先度 |
|----|----------|--------------|------|----------|--------|
| DA001 | 正常系 | POST /tenants/{id}/domains: 追加成功 | 有効なドメイン | 201 Created | 高 |
| DA002 | 異常系 | POST /tenants/{id}/domains: テナント不存在 | 存在しないid | 404 Not Found | 高 |
| DA003 | 異常系 | POST /tenants/{id}/domains: 不正なドメイン | "invalid" | 422 Unprocessable Entity | 高 |
| DA004 | 正常系 | POST /tenants/{id}/domains: DNS手順含む | - | verification_instructions | 高 |
| DA005 | 正常系 | POST /tenants/{id}/domains/{did}/verify: 検証成功 | DNS正常 | 200 OK | 高 |
| DA006 | 異常系 | POST /tenants/{id}/domains/{did}/verify: 不存在 | 存在しないid | 404 Not Found | 高 |
| DA007 | 異常系 | POST /tenants/{id}/domains/{did}/verify: 検証失敗 | TXT不一致 | 422 Unprocessable Entity | 高 |
| DA008 | 正常系 | GET /tenants/{id}/domains: 一覧取得成功 | tenant_id | 200 OK | 高 |
| DA009 | 正常系 | GET /tenants/{id}/domains?verified=true | verified=true | 検証済みのみ | 高 |
| DA010 | 正常系 | DELETE /tenants/{id}/domains/{did}: 削除成功 | 有効なid | 204 No Content | 高 |
| DA011 | 異常系 | DELETE /tenants/{id}/domains/{did}: 不存在 | 存在しないid | 404 Not Found | 高 |

## 4. モック設計

### 4.1 モック対象
- **Cosmos DB Container**: Repository層のテストで使用
- **認証認可サービス (AuthServiceClient)**: Service/API層のテストで使用
- **DNS Resolver (dnspython)**: DomainServiceのテストで使用

### 4.2 モックデータ

#### AuthServiceMock
```python
class AuthServiceMock:
    users = {
        "user_550e8400-e29b-41d4-a716-446655440000": {
            "id": "user_550e8400-e29b-41d4-a716-446655440000",
            "username": "john.doe",
            "email": "john@example.com"
        }
    }
```

#### DNSResolverMock
```python
class DNSResolverMock:
    txt_records = {
        "_tenant_verification.example.com": ["txt-verification-abc123..."]
    }
```

## 5. カバレッジ目標

| レイヤー | 行カバレッジ | 分岐カバレッジ | 備考 |
|---------|------------|--------------|------|
| Model | 90% | 80% | シンプルなデータクラス |
| Schema | 85% | 75% | バリデーションロジック |
| Repository | 80% | 70% | Cosmos DB操作 |
| Service | 80% | 75% | ビジネスロジック |
| API | 75% | 70% | エンドポイント |
| **全体目標** | **80%** | **70%** | - |

## 6. テスト実行計画

### 6.1 実行順序
1. Model層テスト
2. Schema層テスト
3. Repository層テスト（モック使用）
4. Service層テスト（モック使用）
5. API層テスト（統合テスト）

### 6.2 実行コマンド
```bash
# 全テスト実行
pytest tests/test_models_tenant_user.py tests/test_models_domain.py \
       tests/test_schemas_tenant_user.py tests/test_schemas_domain.py \
       tests/test_repositories_tenant_user.py tests/test_repositories_domain.py \
       tests/test_services_tenant_user.py tests/test_services_domain.py \
       tests/test_services_auth_client.py \
       tests/test_api_tenant_users.py tests/test_api_domains.py \
       -v --cov=app --cov-report=html --cov-report=term

# カバレッジレポート表示
open htmlcov/index.html
```

## 7. 備考

- **Phase 1**: 認証・認可は未実装のため、テストでは固定値を使用
- **Phase 2**: JWT検証、ロールベース認可のテストを追加予定
- **DNS検証**: Phase 1ではモックを使用、Phase 2で実際のDNS検証を実装
