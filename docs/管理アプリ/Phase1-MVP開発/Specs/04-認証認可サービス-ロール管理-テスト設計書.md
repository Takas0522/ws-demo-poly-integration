# テスト設計書: 認証認可サービス - ロール管理

**バージョン**: 1.0.0  
**ドキュメントID**: TEST-AUTH-ROLE-001  
**作成日**: 2026-02-01  
**ステータス**: Draft

---

## 1. テスト概要

### 1.1 テスト対象

タスク04「認証認可サービス - ロール管理」の実装に対する単体テスト

#### 対象モジュール

| モジュール | ファイルパス | 責務 |
|----------|-------------|------|
| RoleAssignmentモデル | `app/models/role_assignment.py` | ロール割り当てデータモデル |
| RoleRepository | `app/repositories/role_repository.py` | ロール割り当てデータアクセス |
| RoleService | `app/services/role_service.py` | ロール管理ビジネスロジック |
| Roles API | `app/api/roles.py` | ロール管理REST API |
| AuthService (JWT) | `app/services/auth_service.py` | JWT生成時のロール情報追加 |

### 1.2 テスト目的

- **機能検証**: すべての機能が仕様通りに動作することを確認
- **エラーハンドリング**: 異常系の適切な処理を確認
- **境界値検証**: 境界条件での動作を確認
- **セキュリティ**: テナント分離、認可チェックの適切性を確認
- **パフォーマンス**: JWT生成の性能要件（< 100ms）を確認

### 1.3 テストスコープ

**含まれるテスト**:
- 単体テスト（ユニットテスト）
- ISTQB標準準拠のテスト技法
- モックを使用した依存関係の分離

**含まれないテスト**:
- 統合テスト（別途実施）
- E2Eテスト（別途実施）
- パフォーマンステスト（統合テストで実施）

---

## 2. テスト環境

### 2.1 必要なツール

| ツール | バージョン | 用途 |
|-------|----------|------|
| pytest | 7.4+ | テストフレームワーク |
| pytest-asyncio | 0.21+ | 非同期テスト |
| pytest-cov | 4.1+ | カバレッジ測定 |
| unittest.mock | 標準ライブラリ | モック作成 |

### 2.2 テストデータ

#### サンプルユーザー
```python
{
    "id": "user_test_001",
    "tenant_id": "tenant-test",
    "username": "testuser",
    "email": "test@example.com",
    "is_active": True
}
```

#### サンプルRoleAssignment
```python
{
    "id": "role_assignment_test_001",
    "tenant_id": "tenant-test",
    "user_id": "user_test_001",
    "service_id": "auth-service",
    "role_name": "全体管理者",
    "assigned_by": "user_admin",
    "assigned_at": "2026-02-01T10:00:00Z"
}
```

---

## 3. テストケース一覧

### 3.1 モデル層テスト（test_models_role_assignment.py）

| ID | カテゴリ | テストケース | 期待結果 | 優先度 |
|----|----------|--------------|----------|--------|
| TC-MODEL-RA-001 | 正常系 | RoleAssignment正常な作成 | インスタンス化成功 | 高 |
| TC-MODEL-RA-002 | 正常系 | デフォルト値の設定 | id, type, datetimeが自動設定 | 高 |
| TC-MODEL-RA-003 | 正常系 | エイリアスによるシリアライズ | camelCaseでシリアライズ | 中 |
| TC-MODEL-RA-004 | 正常系 | datetimeのISO形式変換 | ISO 8601形式（Z付き） | 中 |
| TC-MODEL-RA-E-001 | 異常系 | 必須フィールド欠損（tenant_id） | ValidationError | 高 |
| TC-MODEL-RA-E-002 | 異常系 | 必須フィールド欠損（user_id） | ValidationError | 高 |
| TC-MODEL-RA-E-003 | 異常系 | 必須フィールド欠損（service_id） | ValidationError | 高 |
| TC-MODEL-RA-E-004 | 異常系 | 必須フィールド欠損（role_name） | ValidationError | 高 |
| TC-MODEL-RA-E-005 | 異常系 | 必須フィールド欠損（assigned_by） | ValidationError | 高 |
| TC-MODEL-RA-E-006 | 異常系 | 空文字列のservice_id | ValidationError | 中 |
| TC-MODEL-RA-E-007 | 異常系 | 空文字列のrole_name | ValidationError | 中 |
| TC-MODEL-RA-B-001 | 境界値 | 最大長のservice_id（255文字） | インスタンス化成功 | 低 |
| TC-MODEL-RA-B-002 | 境界値 | 最大長のrole_name（100文字） | インスタンス化成功 | 低 |
| TC-MODEL-RAC-001 | 正常系 | RoleAssignmentCreate正常な作成 | インスタンス化成功 | 高 |
| TC-MODEL-RAC-002 | 正常系 | エイリアスによるデシリアライズ | camelCaseから変換 | 中 |
| TC-MODEL-R-001 | 正常系 | Role正常な作成 | インスタンス化成功 | 高 |
| TC-MODEL-R-002 | 正常系 | エイリアスによるシリアライズ | camelCaseでシリアライズ | 中 |

**小計**: 17件

### 3.2 Repository層テスト（test_repositories_role.py）

| ID | カテゴリ | テストケース | 期待結果 | 優先度 |
|----|----------|--------------|----------|--------|
| TC-REPO-R-CREATE-001 | 正常系 | create - 正常な作成 | RoleAssignmentオブジェクト返却 | 高 |
| TC-REPO-R-CREATE-E-001 | 異常系 | create - Cosmos DBエラー | CosmosHttpResponseError再発生 | 高 |
| TC-REPO-R-GET-001 | 正常系 | get - 正常な取得 | RoleAssignmentオブジェクト返却 | 高 |
| TC-REPO-R-GET-E-001 | 異常系 | get - 存在しないロール割り当て | None返却 | 高 |
| TC-REPO-R-GET-E-002 | 異常系 | get - 404以外のCosmos DBエラー | CosmosHttpResponseError再発生 | 中 |
| TC-REPO-R-DELETE-001 | 正常系 | delete - 正常な削除 | 例外なし | 高 |
| TC-REPO-R-DELETE-E-001 | 異常系 | delete - Cosmos DBエラー | CosmosHttpResponseError再発生 | 中 |
| TC-REPO-R-GETBYUID-001 | 正常系 | get_by_user_id - 複数件取得 | RoleAssignmentリスト返却 | 高 |
| TC-REPO-R-GETBYUID-002 | 正常系 | get_by_user_id - 0件取得 | 空リスト返却 | 高 |
| TC-REPO-R-GETBYUID-003 | 正常系 | get_by_user_id - クエリパラメータ検証 | 正しいパラメータ使用 | 中 |
| TC-REPO-R-GETBYUID-E-001 | 異常系 | get_by_user_id - Cosmos DBエラー | CosmosHttpResponseError再発生 | 中 |
| TC-REPO-R-FIND-001 | 正常系 | find_by_user_and_service - 存在する | RoleAssignmentオブジェクト返却 | 高 |
| TC-REPO-R-FIND-002 | 正常系 | find_by_user_and_service - 存在しない | None返却 | 高 |
| TC-REPO-R-FIND-003 | 正常系 | find_by_user_and_service - クエリパラメータ検証 | 正しいパラメータ使用 | 中 |
| TC-REPO-R-FIND-E-001 | 異常系 | find_by_user_and_service - Cosmos DBエラー | CosmosHttpResponseError再発生 | 中 |
| TC-REPO-R-CINE-001 | 正常系 | create_if_not_exists - 新規作成 | (RoleAssignment, True)返却 | 高 |
| TC-REPO-R-CINE-002 | 正常系 | create_if_not_exists - 既存返却 | (RoleAssignment, False)返却 | 高 |
| TC-REPO-R-CINE-003 | 正常系 | create_if_not_exists - 競合状態（409） | (RoleAssignment, False)返却 | 高 |
| TC-REPO-R-CINE-004 | 正常系 | create_if_not_exists - 決定的ID生成 | "ra_{user_id}_{service_id}_{role_name}" | 高 |
| TC-REPO-R-CINE-E-001 | 異常系 | create_if_not_exists - 409以外のエラー | CosmosHttpResponseError再発生 | 中 |

**小計**: 20件

### 3.3 Service層テスト（test_services_role.py）

| ID | カテゴリ | テストケース | 期待結果 | 優先度 |
|----|----------|--------------|----------|--------|
| TC-SVC-R-GAR-001 | 正常系 | get_available_roles - 全ロール取得 | Roleリスト返却 | 高 |
| TC-SVC-R-GAR-002 | 正常系 | get_available_roles - 認証サービスロール | auth-serviceのロール含む | 高 |
| TC-SVC-R-GAR-003 | 正常系 | get_available_roles - テナント管理ロール | tenant-managementのロール含む | 高 |
| TC-SVC-R-VR-001 | 正常系 | validate_role - auth-service全体管理者 | True返却 | 高 |
| TC-SVC-R-VR-002 | 正常系 | validate_role - tenant-management管理者 | True返却 | 高 |
| TC-SVC-R-VR-E-001 | 異常系 | validate_role - 無効なサービスID | False返却 | 高 |
| TC-SVC-R-VR-E-002 | 異常系 | validate_role - 無効なロール名 | False返却 | 高 |
| TC-SVC-R-VR-E-003 | 異常系 | validate_role - 不正な組み合わせ | False返却 | 中 |
| TC-SVC-R-GUR-001 | 正常系 | get_user_roles - 複数件取得 | RoleAssignmentリスト返却 | 高 |
| TC-SVC-R-GUR-002 | 正常系 | get_user_roles - 0件取得 | 空リスト返却 | 高 |
| TC-SVC-R-GUR-E-001 | 異常系 | get_user_roles - ユーザー不存在 | HTTPException(404) | 高 |
| TC-SVC-R-AR-001 | 正常系 | assign_role - 正常な割り当て | RoleAssignmentオブジェクト返却 | 高 |
| TC-SVC-R-AR-002 | 正常系 | assign_role - auth-service全体管理者 | RoleAssignmentオブジェクト返却 | 高 |
| TC-SVC-R-AR-003 | 正常系 | assign_role - tenant-management管理者 | RoleAssignmentオブジェクト返却 | 高 |
| TC-SVC-R-AR-E-001 | 異常系 | assign_role - ユーザー不存在 | HTTPException(404) | 高 |
| TC-SVC-R-AR-E-002 | 異常系 | assign_role - 無効なロール | HTTPException(400) | 高 |
| TC-SVC-R-AR-E-003 | 異常系 | assign_role - 重複割り当て | HTTPException(409) | 高 |
| TC-SVC-R-RR-001 | 正常系 | remove_role - 正常な削除 | 例外なし | 高 |
| TC-SVC-R-RR-E-001 | 異常系 | remove_role - ロール割り当て不存在 | HTTPException(404) | 高 |
| TC-SVC-R-RR-E-002 | 異常系 | remove_role - ユーザーID不一致 | HTTPException(400) | 高 |

**小計**: 20件

### 3.4 API層テスト（test_api_roles.py）

| ID | カテゴリ | テストケース | 期待結果 | 優先度 |
|----|----------|--------------|----------|--------|
| TC-API-R-GAR-001 | 正常系 | GET /roles - 正常取得 | 200, data配列 | 高 |
| TC-API-R-GAR-002 | 正常系 | GET /roles - 認証サービスロール | auth-serviceのロール含む | 高 |
| TC-API-R-GAR-003 | 正常系 | GET /roles - テナント管理ロール | tenant-managementのロール含む | 高 |
| TC-API-R-GAR-004 | 正常系 | GET /roles - camelCase変換 | キー名がcamelCase | 中 |
| TC-API-R-GUR-001 | 正常系 | GET /users/{user_id}/roles - 複数件 | 200, data配列 | 高 |
| TC-API-R-GUR-002 | 正常系 | GET /users/{user_id}/roles - 0件 | 200, 空配列 | 高 |
| TC-API-R-GUR-003 | 正常系 | GET /users/{user_id}/roles - 同一テナント | 200, ロール一覧 | 高 |
| TC-API-R-GUR-004 | 正常系 | GET /users/{user_id}/roles - camelCase変換 | キー名がcamelCase | 中 |
| TC-API-R-GUR-E-001 | 異常系 | GET /users/{user_id}/roles - テナント分離違反 | HTTPException(403) | 高 |
| TC-API-R-GUR-E-002 | 異常系 | GET /users/{user_id}/roles - ユーザー不存在 | HTTPException(404) | 高 |
| TC-API-R-AR-001 | 正常系 | POST /users/{user_id}/roles - 正常割り当て | 201, RoleAssignment | 高 |
| TC-API-R-AR-002 | 正常系 | POST /users/{user_id}/roles - auth-service全体管理者 | 201, RoleAssignment | 高 |
| TC-API-R-AR-003 | 正常系 | POST /users/{user_id}/roles - tenant-management管理者 | 201, RoleAssignment | 高 |
| TC-API-R-AR-004 | 正常系 | POST /users/{user_id}/roles - 同一テナント | 201, RoleAssignment | 高 |
| TC-API-R-AR-005 | 正常系 | POST /users/{user_id}/roles - 監査ログ | logger.info呼び出し | 中 |
| TC-API-R-AR-006 | 正常系 | POST /users/{user_id}/roles - camelCase変換 | キー名がcamelCase | 中 |
| TC-API-R-AR-E-001 | 異常系 | POST /users/{user_id}/roles - テナント分離違反 | HTTPException(403) | 高 |
| TC-API-R-AR-E-002 | 異常系 | POST /users/{user_id}/roles - ユーザー不存在 | HTTPException(404) | 高 |
| TC-API-R-AR-E-003 | 異常系 | POST /users/{user_id}/roles - 重複割り当て | HTTPException(409) | 高 |
| TC-API-R-AR-E-004 | 異常系 | POST /users/{user_id}/roles - 無効なロール | HTTPException(400) | 高 |
| TC-API-R-RR-001 | 正常系 | DELETE /users/{user_id}/roles/{role_assignment_id} - 正常削除 | 204 | 高 |
| TC-API-R-RR-002 | 正常系 | DELETE /users/{user_id}/roles/{role_assignment_id} - 同一テナント | 204 | 高 |
| TC-API-R-RR-003 | 正常系 | DELETE /users/{user_id}/roles/{role_assignment_id} - 監査ログ | logger.info呼び出し | 中 |
| TC-API-R-RR-E-001 | 異常系 | DELETE /users/{user_id}/roles/{role_assignment_id} - テナント分離違反 | HTTPException(403) | 高 |
| TC-API-R-RR-E-002 | 異常系 | DELETE /users/{user_id}/roles/{role_assignment_id} - ロール割り当て不存在 | HTTPException(404) | 高 |
| TC-API-R-GCU-001 | 正常系 | get_current_user_from_request - 正常取得 | user_id, tenant_id返却 | 高 |
| TC-API-R-GCU-E-001 | 異常系 | get_current_user_from_request - X-User-Idなし | HTTPException(401) | 高 |
| TC-API-R-GCU-E-002 | 異常系 | get_current_user_from_request - X-Tenant-Idなし | HTTPException(401) | 高 |

**小計**: 28件

### 3.5 JWT生成テスト（test_services_auth_jwt_roles.py）

| ID | カテゴリ | テストケース | 期待結果 | 優先度 |
|----|----------|--------------|----------|--------|
| TC-AUTH-JWT-R-001 | 正常系 | create_token - ロール情報（複数件） | JWTにrolesフィールド（複数件） | 高 |
| TC-AUTH-JWT-R-002 | 正常系 | create_token - ロール情報（1件） | JWTにrolesフィールド（1件） | 高 |
| TC-AUTH-JWT-R-003 | 正常系 | create_token - ロール情報（0件） | JWTにrolesフィールド（空配列） | 高 |
| TC-AUTH-JWT-R-004 | 境界値 | create_token - ロール数制限（20件超） | JWTに20件のみ、logger.warning | 高 |
| TC-AUTH-JWT-R-005 | 境界値 | create_token - ロール数制限（ちょうど20件） | JWTに20件、logger.warningなし | 中 |
| TC-AUTH-JWT-R-006 | 正常系 | create_token - ロール情報フォーマット | {service_id, role_name}形式 | 高 |
| TC-AUTH-JWT-R-007 | 正常系 | create_token - auth-service全体管理者 | JWTに正しいロール情報 | 高 |
| TC-AUTH-JWT-R-008 | 正常系 | create_token - tenant-management管理者 | JWTに正しいロール情報 | 高 |
| TC-AUTH-JWT-R-009 | 正常系 | create_token - 複数サービスのロール | JWTに複数サービスのロール | 高 |
| TC-AUTH-JWT-R-010 | 正常系 | create_token - JWTペイロード構造 | 正しいペイロード構造 | 高 |
| TC-AUTH-JWT-R-011 | 正常系 | create_token - TokenResponse構造 | 正しいTokenResponse | 高 |
| TC-AUTH-JWT-R-P-001 | パフォーマンス | create_token - 100ms以内 | 実行時間 < 100ms | 中 |
| TC-AUTH-JWT-R-INT-001 | 統合 | create_token - RoleRepository呼び出し | get_by_user_id呼び出し | 高 |
| TC-AUTH-JWT-R-INT-E-001 | 異常系 | create_token - RoleRepositoryエラー | 例外再発生 | 中 |

**小計**: 14件

---

## 4. モック設計

### 4.1 モック対象

| 依存関係 | モック方法 | 理由 |
|---------|-----------|------|
| Cosmos DBコンテナ | MagicMock | 外部依存の分離 |
| UserRepository | MagicMock | Service層テストでの分離 |
| RoleRepository | MagicMock | Service層、API層テストでの分離 |
| RoleService | MagicMock | API層テストでの分離 |
| Request（FastAPI） | MagicMock | API層テストでのリクエストモック |
| Logger | patch | ログ記録の検証用 |

### 4.2 モックデータ

#### Cosmos DBコンテナのモック
```python
mock_container = MagicMock()
mock_container.create_item = AsyncMock(return_value={...})
mock_container.read_item = AsyncMock(return_value={...})
mock_container.delete_item = AsyncMock(return_value=None)
mock_container.query_items = MagicMock(return_value=AsyncIterator([...]))
```

#### UserRepositoryのモック
```python
mock_user_repository = MagicMock()
mock_user_repository.get = AsyncMock(return_value=User(...))
```

#### RoleRepositoryのモック
```python
mock_role_repository = MagicMock()
mock_role_repository.create = AsyncMock(return_value=RoleAssignment(...))
mock_role_repository.get = AsyncMock(return_value=RoleAssignment(...))
mock_role_repository.delete = AsyncMock(return_value=None)
mock_role_repository.get_by_user_id = AsyncMock(return_value=[...])
mock_role_repository.find_by_user_and_service = AsyncMock(return_value=RoleAssignment(...))
mock_role_repository.create_if_not_exists = AsyncMock(return_value=(RoleAssignment(...), True))
```

---

## 5. カバレッジ目標

### 5.1 総合カバレッジ目標

| 種類 | 目標 | Phase 1実績 | Phase 2目標 |
|------|------|------------|------------|
| **行カバレッジ** | **75%以上** | TBD | 80%以上 |
| **分岐カバレッジ** | **70%以上** | TBD | 75%以上 |
| **関数カバレッジ** | **80%以上** | TBD | 90%以上 |

### 5.2 レイヤー別カバレッジ目標

| レイヤー | 行カバレッジ | 分岐カバレッジ | 関数カバレッジ |
|---------|-----------|-------------|-------------|
| **Model層** | **100%** | 100% | 100% |
| **Repository層** | **80%以上** | 75%以上 | 90%以上 |
| **Service層** | **90%以上** | 85%以上 | 95%以上 |
| **API層** | **85%以上** | 80%以上 | 90%以上 |

### 5.3 カバレッジ測定コマンド

```bash
# カバレッジ測定
pytest --cov=app --cov-report=html --cov-report=term

# カバレッジレポート表示
open htmlcov/index.html
```

---

## 6. テスト実行

### 6.1 テスト収集コマンド

```bash
# すべてのテストケースを収集（実行はしない）
pytest --collect-only

# 特定のファイルのテストケースを収集
pytest tests/test_models_role_assignment.py --collect-only
pytest tests/test_repositories_role.py --collect-only
pytest tests/test_services_role.py --collect-only
pytest tests/test_api_roles.py --collect-only
pytest tests/test_services_auth_jwt_roles.py --collect-only
```

### 6.2 テスト実行コマンド

```bash
# すべてのテストを実行
pytest

# 特定のファイルのテストを実行
pytest tests/test_models_role_assignment.py
pytest tests/test_repositories_role.py

# カバレッジ付きで実行
pytest --cov=app --cov-report=html

# verbose モードで実行
pytest -v

# 特定のテストクラスを実行
pytest tests/test_models_role_assignment.py::TestRoleAssignmentModel

# 特定のテストメソッドを実行
pytest tests/test_models_role_assignment.py::TestRoleAssignmentModel::Test正常系::test_role_assignment_正常な作成
```

---

## 7. テストケース統計

### 7.1 総合統計

| カテゴリ | テストケース数 | 割合 |
|---------|-------------|------|
| **正常系** | **58件** | **58.6%** |
| **異常系** | **35件** | **35.4%** |
| **境界値** | **4件** | **4.0%** |
| **パフォーマンス** | **1件** | **1.0%** |
| **統合** | **1件** | **1.0%** |
| **合計** | **99件** | **100%** |

### 7.2 レイヤー別統計

| レイヤー | テストケース数 | 割合 |
|---------|-------------|------|
| Model層 | 17件 | 17.2% |
| Repository層 | 20件 | 20.2% |
| Service層 | 20件 | 20.2% |
| API層 | 28件 | 28.3% |
| JWT生成層 | 14件 | 14.1% |
| **合計** | **99件** | **100%** |

### 7.3 優先度別統計

| 優先度 | テストケース数 | 割合 |
|--------|-------------|------|
| **高** | **78件** | **78.8%** |
| **中** | **20件** | **20.2%** |
| **低** | **1件** | **1.0%** |
| **合計** | **99件** | **100%** |

---

## 8. ISTQB準拠のテスト技法

### 8.1 適用したテスト技法

| 技法 | 適用箇所 | 例 |
|------|---------|---|
| **同値分割法** | モデルバリデーション | 有効な値、無効な値の分類 |
| **境界値分析** | 文字列長、ロール数 | 255文字、100文字、20件、21件 |
| **デシジョンテーブル** | ロール検証 | service_id × role_nameの組み合わせ |
| **状態遷移テスト** | ロール割り当て | 未割り当て → 割り当て済み |
| **エラー推測** | 異常系 | Cosmos DBエラー、テナント分離違反 |

### 8.2 テスト設計の原則

1. **独立性**: 各テストケースは独立して実行可能
2. **再現性**: 同じ入力で同じ結果が得られる
3. **追跡性**: テストケースIDで仕様書と紐付け
4. **AAA パターン**: Arrange-Act-Assert構造
5. **モック活用**: 外部依存の分離

---

## 9. テスト実装の進め方

### 9.1 フェーズ1: テストコード骨組み作成（完了）

- ✅ テストファイル作成
- ✅ テストクラス・メソッド定義
- ✅ Docstring記載
- ✅ AAA構造のコメント配置
- ✅ pytest --collect-only で収集確認

### 9.2 フェーズ2: テスト実装（次ステップ）

1. **Model層テスト実装**（最も簡単）
2. **Repository層テスト実装**（モック作成）
3. **Service層テスト実装**（ビジネスロジック検証）
4. **JWT生成テスト実装**（統合的な検証）
5. **API層テスト実装**（最も複雑）

### 9.3 フェーズ3: カバレッジ測定と改善

- pytest --cov 実行
- 未カバーの分岐を特定
- 追加テストケース作成

### 9.4 フェーズ4: レビューとリファクタリング

- テストコードの可読性向上
- 重複コードの共通化
- フィクスチャの最適化

---

## 10. 注意事項

### 10.1 Phase 1での制約

- **テスト実装は空（pass）のまま**: 骨組みのみ作成
- **モックの詳細設計**: 実装時に詳細化
- **パフォーマンステスト**: 統合テストで実施

### 10.2 Phase 2での改善

- テスト実装の完了
- エラーハンドリングの強化
- パフォーマンステストの追加
- テストデータのバリエーション増加

---

## 11. 参照ドキュメント

- [仕様書: 認証認可サービス - ロール管理](./04-認証認可サービス-ロール管理.md)
- [ISTQB Certified Tester Foundation Level Syllabus](https://www.istqb.org/)
- [pytest 公式ドキュメント](https://docs.pytest.org/)
- [pytest-asyncio 公式ドキュメント](https://pytest-asyncio.readthedocs.io/)

---

**ドキュメント終了**
