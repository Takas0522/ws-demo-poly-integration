# 機能仕様書: サービス設定サービス - ロール統合

## 1. はじめに

### 1.1 目的
本仕様書は、サービス設定サービスにおけるロール統合機能の要件を定義します。各マイクロサービス（認証認可サービス、テナント管理サービス、管理対象サービス4種）が提供するロール情報を収集・統合し、テナントが利用可能なサービスに応じたロール一覧を提供することで、ロールベース認可の統一管理基盤を確立します。

### 1.2 スコープ
本仕様書が対象とする範囲は以下の通りです：

**対象範囲**:
- 各サービスからのロール情報収集インターフェースの設計
- サービス横断的なロール情報の統合ロジック
- テナント利用サービスに基づくロールフィルタリング
- 統合ロール情報を提供するREST API
- ロール情報のキャッシング戦略（Phase 2）

**対象外**:
- ロール割り当て機能（認証認可サービスで実装済み）
- ロールベース認可の実装（共通ライブラリで実装済み）
- ユーザーへのロール割り当てUI（フロントエンドタスクで実装）
- サービス自体のロール定義管理（各サービスが独立管理）

### 1.3 用語定義

| 用語 | 定義 |
|------|------|
| **ロール (Role)** | サービス内の特定の権限セットを表す識別子（例: "管理者", "閲覧者"） |
| **RoleAssignment** | ユーザーに対するロールの割り当てレコード（認証認可サービスで管理） |
| **統合ロール (Integrated Role)** | 複数サービスから収集されたロール情報を統合したデータモデル |
| **ロール情報提供API** | 各サービスが実装する `/api/v1/roles` エンドポイント |
| **ServiceAssignment** | テナントへのサービス割り当てレコード（サービス設定サービスで管理） |
| **ロール集約 (Role Aggregation)** | 複数サービスのロール情報を並列取得し、統合する処理 |
| **利用可能ロール** | テナントが現在利用しているサービスのロールのみをフィルタリングした結果 |
| **コアサービス** | 認証認可、テナント管理、サービス設定の3サービス（全テナント共通利用） |
| **管理対象サービス** | file-service、messaging-service、api-service、backup-serviceの4サービス |

### 1.4 関連ドキュメント
- [開発タスク一覧](../開発タスク.md)
- [07-サービス設定サービス-コアAPI](../07-サービス設定サービス-コアAPI.md)
- [アーキテクチャ概要](../../arch/overview.md)
- [コンポーネント設計](../../arch/components/README.md)
- [API設計](../../arch/api/README.md)

## 2. ビジネス要件

### 2.1 ビジネス目標
1. **ロール管理の一元化**: システム全体のロール情報を統合表示し、管理者が一元的に把握できるようにする
2. **権限設定の効率化**: テナントが利用可能なサービスのロールのみを提示し、管理者の権限設定作業を効率化
3. **将来的な拡張性**: 新規サービス追加時にロール情報が自動的に統合される仕組みを構築
4. **運用コストの削減**: ロール情報を手動で維持する必要をなくし、各サービスが自律的にロール定義を管理

### 2.2 ユーザーストーリー

#### US-08-001: 管理者が全サービスのロール一覧を確認できる
**As a** システム管理者  
**I want** 全サービスで定義されているロール一覧を一括で確認できる  
**So that** 新しいユーザーに適切なロールを割り当てる際に、選択肢を把握できる

**受入条件**:
- [ ] 全サービス（コアサービス3種、管理対象サービス4種）のロール情報が取得できる
- [ ] 各ロールにサービスID、ロール名、説明が含まれる
- [ ] レスポンス時間は500ms以内（P95）

#### US-08-002: テナントが利用可能なロールのみを表示できる
**As a** テナント管理者  
**I want** 自テナントが利用中のサービスのロールのみを表示したい  
**So that** 利用していないサービスのロールを誤って割り当てることを防げる

**受入条件**:
- [ ] テナントのServiceAssignmentに基づいてロールがフィルタリングされる
- [ ] コアサービスのロールは常に表示される（全テナント共通利用）
- [ ] 管理対象サービスは、ServiceAssignmentが存在する場合のみロールが表示される
- [ ] レスポンス時間は400ms以内（P95）

#### US-08-003: 各サービスのロール定義を動的に取得できる
**As a** サービス開発者  
**I want** 自サービスのロール定義を独立して追加・変更できる  
**So that** サービス設定サービス側の変更なしにロール構成を柔軟に管理できる

**受入条件**:
- [ ] 各サービスの `/api/v1/roles` エンドポイントを呼び出してロール情報を取得する
- [ ] 一部サービスのロール取得失敗時も、他のサービスのロール情報は返却される
- [ ] ロール取得エラーはログに記録され、運用チームに通知される

### 2.3 ビジネス価値

#### 定量的効果
- **権限設定時間を60%削減**: ロール一覧の統合表示により、複数サービスを横断した検索が不要に
- **設定ミスを80%削減**: 利用していないサービスのロールを選択できないようにすることで、誤設定を防止
- **新サービス追加時の開発時間を50%削減**: ロール情報提供APIに準拠するだけで、自動的にロール統合に組み込まれる

#### 定性的効果
- **管理者体験の向上**: 一元的なロール管理により、直感的な操作が可能に
- **システム保守性の向上**: ロール定義が各サービスで独立管理されるため、サービス間の依存関係を削減
- **監査対応の強化**: 全サービスのロール定義が一箇所から確認できるため、監査時の説明が容易

## 3. 機能要件

### 3.1 機能概要
サービス設定サービスは、各マイクロサービスからロール情報を収集し、テナントの利用状況に応じてフィルタリングした統合ロール情報を提供します。これにより、認証認可サービスがロール割り当てUI表示時に必要なロール一覧を取得できます。

**主要機能**:
1. **ロール情報収集**: 各サービスの `/api/v1/roles` エンドポイントを呼び出してロール情報を取得
2. **ロール統合**: 複数サービスのロール情報を並列取得し、単一のレスポンス形式に統合
3. **テナントフィルタリング**: テナントのServiceAssignmentに基づいてロールをフィルタリング
4. **キャッシング** (Phase 2): ロール情報を一定期間キャッシュし、レスポンス時間を短縮

### 3.2 機能詳細

#### 3.2.1 全サービスのロール情報取得
- **機能ID**: F-08-001
- **説明**: システムが提供する全サービスのロール情報を取得します
- **入力**: なし（または `include_service_ids` クエリパラメータでフィルタ）
- **処理**:
  1. サービスカタログから全サービスIDを取得（コアサービス3種 + 管理対象サービス4種）
  2. 各サービスの `/api/v1/roles` エンドポイントを並列呼び出し（最大7件同時）
  3. タイムアウト: 各サービス500ms
  4. 取得したロール情報を統合
  5. 一部サービスのロール取得失敗時も、他のサービスのロールは返却
  6. エラーログ記録（失敗したサービスID、エラー内容、タイムスタンプ）
- **出力**: 統合ロール情報（サービスIDをキーとした辞書形式）

**実装例**:
```python
async def get_all_service_roles(self) -> Dict[str, List[IntegratedRole]]:
    """全サービスのロール情報取得"""
    # サービスカタログ取得
    services = await self.service_repository.list_services(is_active=True)
    
    # 並列ロール取得
    async def fetch_service_roles_safe(service_id: str) -> tuple[str, Optional[List[Role]]]:
        try:
            roles = await asyncio.wait_for(
                self.fetch_service_roles(service_id),
                timeout=0.5
            )
            return service_id, roles
        except asyncio.TimeoutError:
            self.logger.warning(f"Timeout fetching roles from {service_id}")
            return service_id, None
        except Exception as e:
            self.logger.error(f"Failed to fetch roles from {service_id}: {e}")
            return service_id, None
    
    results = await asyncio.gather(
        *[fetch_service_roles_safe(s.id) for s in services],
        return_exceptions=False
    )
    
    # 統合ロール情報を構築
    integrated_roles = {}
    for service_id, roles in results:
        if roles is not None:
            integrated_roles[service_id] = [
                IntegratedRole(
                    service_id=service_id,
                    role_name=r.role_name,
                    description=r.description
                )
                for r in roles
            ]
    
    return integrated_roles
```

#### 3.2.2 テナント利用可能ロール取得
- **機能ID**: F-08-002
- **説明**: 特定テナントが現在利用しているサービスのロールのみを取得します
- **入力**: `tenant_id` (str)
- **処理**:
  1. テナントのServiceAssignment一覧を取得（`status=active`でフィルタ）
  2. コアサービス（auth-service、tenant-management、service-setting）を自動追加
  3. 各サービスのロール情報を並列取得（F-08-001の処理を再利用）
  4. テナントが利用しているサービスのロールのみをフィルタリング
- **出力**: 利用可能ロール情報（サービスIDをキーとした辞書形式）

**ビジネスロジック**:
```python
async def get_tenant_available_roles(self, tenant_id: str) -> Dict[str, List[IntegratedRole]]:
    """テナント利用可能ロール取得"""
    # 1. テナントのServiceAssignment取得
    assignments = await self.assignment_repository.list_by_tenant(
        tenant_id, status="active"
    )
    
    # 2. コアサービスを自動追加
    available_service_ids = {
        "auth-service",
        "tenant-management",
        "service-setting"
    }
    
    # 3. 管理対象サービスを追加
    for assignment in assignments:
        available_service_ids.add(assignment.service_id)
    
    # 4. 全サービスのロール情報取得
    all_roles = await self.get_all_service_roles()
    
    # 5. テナントが利用しているサービスのロールのみをフィルタ
    filtered_roles = {
        service_id: roles
        for service_id, roles in all_roles.items()
        if service_id in available_service_ids
    }
    
    self.logger.info(
        f"Tenant available roles: {len(filtered_roles)} services, "
        f"{sum(len(r) for r in filtered_roles.values())} roles",
        extra={"tenant_id": tenant_id}
    )
    
    return filtered_roles
```

#### 3.2.3 特定サービスのロール取得
- **機能ID**: F-08-003
- **説明**: 特定サービスのロール情報を取得します
- **入力**: `service_id` (str)
- **処理**:
  1. サービス存在確認
  2. サービスの `/api/v1/roles` エンドポイントを呼び出し
  3. タイムアウト: 500ms
  4. レスポンスをIntegratedRole形式に変換
- **出力**: IntegratedRole配列

#### 3.2.4 ロール情報の動的取得（各サービス側）
- **機能ID**: F-08-004
- **説明**: 各サービスが `/api/v1/roles` エンドポイントを実装し、自サービスのロール定義を提供します
- **標準仕様**:

```python
# 各サービスの app/api/roles.py
@router.get("/roles", response_model=List[RoleInfo])
async def get_service_roles():
    """サービスロール一覧取得（認証不要）"""
    return [
        RoleInfo(
            role_name="管理者",
            description="全機能へのアクセス"
        ),
        RoleInfo(
            role_name="編集者",
            description="データの作成・編集"
        ),
        RoleInfo(
            role_name="閲覧者",
            description="データの参照のみ"
        ),
    ]
```

**実装ガイドライン**:
- エンドポイント: `GET /api/v1/roles`
- 認証: 不要（サービス間通信のため）またはサービス共有鍵を使用
- レスポンス形式:
  ```json
  {
    "data": [
      {
        "roleName": "管理者",
        "description": "全機能へのアクセス"
      }
    ]
  }
  ```
- パフォーマンス要件: 50ms以内（P95）
- エラーハンドリング: 5xxエラー時はサービス設定サービス側でリトライ

### 3.3 API設計

#### 3.3.1 GET /api/v1/integrated-roles
全サービスの統合ロール情報取得

**リクエスト**:
```http
GET /api/v1/integrated-roles
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

**必要ロール**: service-setting: 閲覧者 以上

**クエリパラメータ**:
- `include_service_ids` (optional): カンマ区切りのサービスID（フィルタ用）

**レスポンス** (200 OK):
```json
{
  "roles": {
    "auth-service": [
      {
        "serviceId": "auth-service",
        "roleName": "全体管理者",
        "description": "ユーザー登録・削除、ロール割り当て"
      },
      {
        "serviceId": "auth-service",
        "roleName": "閲覧者",
        "description": "ユーザー情報の参照のみ"
      }
    ],
    "tenant-management": [
      {
        "serviceId": "tenant-management",
        "roleName": "全体管理者",
        "description": "特権テナント操作、全テナント管理"
      },
      {
        "serviceId": "tenant-management",
        "roleName": "管理者",
        "description": "通常テナントの追加・削除・編集"
      },
      {
        "serviceId": "tenant-management",
        "roleName": "閲覧者",
        "description": "テナント情報の参照のみ"
      }
    ],
    "service-setting": [
      {
        "serviceId": "service-setting",
        "roleName": "全体管理者",
        "description": "サービス割り当て・削除"
      },
      {
        "serviceId": "service-setting",
        "roleName": "閲覧者",
        "description": "サービス利用状況の参照"
      }
    ],
    "file-service": [
      {
        "serviceId": "file-service",
        "roleName": "管理者",
        "description": "全機能へのアクセス"
      },
      {
        "serviceId": "file-service",
        "roleName": "編集者",
        "description": "ファイルのアップロード、削除"
      },
      {
        "serviceId": "file-service",
        "roleName": "閲覧者",
        "description": "ファイルのダウンロード、一覧表示のみ"
      }
    ]
  },
  "metadata": {
    "totalServices": 7,
    "totalRoles": 18,
    "failedServices": [],
    "cachedAt": null
  }
}
```

**エラーレスポンス**:
- `503 Service Unavailable`: 全サービスのロール取得に失敗した場合
  ```json
  {
    "error": {
      "code": "ROLE_AGGREGATION_001_ALL_SERVICES_UNAVAILABLE",
      "message": "All services failed to provide role information",
      "details": {
        "failedServices": ["file-service", "messaging-service", "api-service", "backup-service"]
      },
      "timestamp": "2026-02-02T10:00:00Z",
      "requestId": "req_abc123"
    }
  }
  ```

**パフォーマンス要件**: < 500ms (P95)

#### 3.3.2 GET /api/v1/tenants/{tenant_id}/available-roles
テナント利用可能ロール取得

**リクエスト**:
```http
GET /api/v1/tenants/tenant_acme/available-roles
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

**必要ロール**: service-setting: 閲覧者 以上

**パスパラメータ**:
- `tenant_id` (required): テナントID

**レスポンス** (200 OK):
```json
{
  "tenantId": "tenant_acme",
  "roles": {
    "auth-service": [
      {
        "serviceId": "auth-service",
        "roleName": "全体管理者",
        "description": "ユーザー登録・削除、ロール割り当て"
      },
      {
        "serviceId": "auth-service",
        "roleName": "閲覧者",
        "description": "ユーザー情報の参照のみ"
      }
    ],
    "tenant-management": [
      {
        "serviceId": "tenant-management",
        "roleName": "管理者",
        "description": "通常テナントの追加・削除・編集"
      },
      {
        "serviceId": "tenant-management",
        "roleName": "閲覧者",
        "description": "テナント情報の参照のみ"
      }
    ],
    "file-service": [
      {
        "serviceId": "file-service",
        "roleName": "管理者",
        "description": "全機能へのアクセス"
      },
      {
        "serviceId": "file-service",
        "roleName": "閲覧者",
        "description": "ファイルのダウンロード、一覧表示のみ"
      }
    ]
  },
  "metadata": {
    "totalServices": 4,
    "totalRoles": 8,
    "assignedServices": ["file-service"],
    "cachedAt": null
  }
}
```

**テナント分離**:
- 特権テナント以外は、自テナントの情報のみ取得可能
- 他テナントへのアクセス試行は403エラー

**エラーレスポンス**:
- `403 Forbidden`: テナント分離違反
- `404 Not Found`: テナントが存在しない（ServiceAssignmentが0件の場合も該当）

**パフォーマンス要件**: < 400ms (P95)

#### 3.3.3 GET /api/v1/services/{service_id}/roles
特定サービスのロール情報取得

**リクエスト**:
```http
GET /api/v1/services/file-service/roles
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

**必要ロール**: service-setting: 閲覧者 以上

**パスパラメータ**:
- `service_id` (required): サービスID

**レスポンス** (200 OK):
```json
{
  "serviceId": "file-service",
  "serviceName": "ファイル管理サービス",
  "roles": [
    {
      "roleName": "管理者",
      "description": "全機能へのアクセス"
    },
    {
      "roleName": "編集者",
      "description": "ファイルのアップロード、削除"
    },
    {
      "roleName": "閲覧者",
      "description": "ファイルのダウンロード、一覧表示のみ"
    }
  ],
  "metadata": {
    "version": "1.0.0",
    "lastUpdated": "2026-02-01T10:00:00Z"
  }
}
```

**エラーレスポンス**:
- `404 Not Found`: サービスが存在しない
- `503 Service Unavailable`: サービスのロールエンドポイントにアクセスできない

**パフォーマンス要件**: < 200ms (P95)

### 3.4 データモデル

#### 3.4.1 IntegratedRole
統合ロール情報モデル

```python
from pydantic import BaseModel, Field, ConfigDict

class IntegratedRole(BaseModel):
    """統合ロール情報"""
    
    model_config = ConfigDict(populate_by_name=True)
    
    service_id: str = Field(..., alias="serviceId")
    role_name: str = Field(..., alias="roleName")
    description: str
    
    # 追加メタデータ（Phase 2で拡張）
    permissions: Optional[List[str]] = None  # 権限一覧
    is_default: bool = False  # デフォルトロールフラグ
    display_order: int = 0  # 表示順序
```

**フィールド詳細**:
- `service_id`: ロールを定義しているサービスID（例: "file-service"）
- `role_name`: ロール名（例: "管理者"）
- `description`: ロールの説明（50-200文字）
- `permissions`: 権限一覧（Phase 2で追加、例: ["files:read", "files:write"]）
- `is_default`: 新規ユーザーに自動割り当てするデフォルトロールか（Phase 2で追加）
- `display_order`: UI表示時のソート順序（Phase 2で追加）

#### 3.4.2 ServiceRoleInfo
サービスロール情報（各サービスの `/api/v1/roles` レスポンス形式）

```python
class ServiceRoleInfo(BaseModel):
    """サービスロール情報（各サービスのレスポンス形式）"""
    
    model_config = ConfigDict(populate_by_name=True)
    
    role_name: str = Field(..., alias="roleName")
    description: str
```

#### 3.4.3 IntegratedRolesResponse
統合ロール情報レスポンス

```python
class IntegratedRolesResponse(BaseModel):
    """統合ロール情報レスポンス"""
    
    roles: Dict[str, List[IntegratedRole]]  # サービスIDをキーとした辞書
    metadata: IntegratedRolesMetadata

class IntegratedRolesMetadata(BaseModel):
    """統合ロール情報メタデータ"""
    
    total_services: int = Field(..., alias="totalServices")
    total_roles: int = Field(..., alias="totalRoles")
    failed_services: List[str] = Field(default_factory=list, alias="failedServices")
    cached_at: Optional[datetime] = Field(None, alias="cachedAt")
```

### 3.5 ビジネスロジック

#### 3.5.1 ロール情報収集処理

**処理フロー**:
```mermaid
sequenceDiagram
    participant C as Client
    participant API as サービス設定サービス
    participant RA as RoleAggregator
    participant SR as ServiceRepository
    participant AS as 認証認可サービス
    participant TM as テナント管理サービス
    participant FS as ファイル管理サービス
    participant MS as メッセージングサービス
    
    C->>API: GET /api/v1/integrated-roles
    API->>RA: get_all_service_roles()
    RA->>SR: list_services(is_active=True)
    SR-->>RA: [Services]
    
    par 並列ロール取得
        RA->>AS: GET /api/v1/roles
        AS-->>RA: [Roles]
    and
        RA->>TM: GET /api/v1/roles
        TM-->>RA: [Roles]
    and
        RA->>FS: GET /api/v1/roles
        FS-->>RA: [Roles]
    and
        RA->>MS: GET /api/v1/roles
        MS-->>RA: [Roles]
    end
    
    RA->>RA: 統合とエラーハンドリング
    RA-->>API: IntegratedRoles
    API-->>C: 200 OK
```

**実装詳細**:
```python
class RoleAggregator:
    """ロール集約サービス"""
    
    def __init__(
        self,
        service_repository: ServiceRepository,
        http_client: httpx.AsyncClient
    ):
        self.service_repository = service_repository
        self.http_client = http_client
        self.logger = logging.getLogger(__name__)
        
        # サービスのベースURL（環境変数から取得）
        self.service_base_urls = {
            "auth-service": os.getenv("AUTH_SERVICE_URL"),
            "tenant-management": os.getenv("TENANT_SERVICE_URL"),
            "service-setting": "http://localhost:8002",  # 自サービス
            "file-service": os.getenv("FILE_SERVICE_URL"),
            "messaging-service": os.getenv("MESSAGING_SERVICE_URL"),
            "api-service": os.getenv("API_SERVICE_URL"),
            "backup-service": os.getenv("BACKUP_SERVICE_URL"),
        }
    
    async def fetch_service_roles(self, service_id: str) -> List[ServiceRoleInfo]:
        """
        特定サービスのロール情報取得
        
        Args:
            service_id: サービスID
        
        Returns:
            List[ServiceRoleInfo]: ロール情報配列
        
        Raises:
            httpx.TimeoutException: タイムアウト
            httpx.HTTPStatusError: HTTPエラー
        """
        base_url = self.service_base_urls.get(service_id)
        if not base_url:
            self.logger.error(f"Service URL not configured: {service_id}")
            raise ValueError(f"Service URL not configured for {service_id}")
        
        url = f"{base_url}/api/v1/roles"
        
        try:
            response = await self.http_client.get(
                url,
                timeout=0.5,  # 500msタイムアウト
                headers={"X-Service-Key": os.getenv("SERVICE_SHARED_SECRET")}
            )
            response.raise_for_status()
            
            data = response.json()
            roles = [ServiceRoleInfo(**r) for r in data.get("data", [])]
            
            self.logger.info(
                f"Fetched roles from {service_id}: {len(roles)} roles",
                extra={"service_id": service_id, "role_count": len(roles)}
            )
            
            return roles
        
        except httpx.TimeoutException:
            self.logger.warning(
                f"Timeout fetching roles from {service_id}",
                extra={"service_id": service_id, "timeout": 0.5}
            )
            raise
        
        except httpx.HTTPStatusError as e:
            self.logger.error(
                f"HTTP error fetching roles from {service_id}: {e.response.status_code}",
                extra={
                    "service_id": service_id,
                    "status_code": e.response.status_code,
                    "response": e.response.text
                }
            )
            raise
    
    async def get_all_service_roles(self) -> Dict[str, List[IntegratedRole]]:
        """
        全サービスのロール情報取得
        
        Returns:
            Dict[str, List[IntegratedRole]]: サービスIDをキーとした統合ロール情報
        
        Note:
            一部サービスのロール取得失敗時も、他のサービスのロール情報は返却
        """
        # サービスカタログ取得
        services = await self.service_repository.list_services(is_active=True)
        
        # 並列ロール取得（エラーハンドリング付き）
        async def fetch_service_roles_safe(
            service_id: str
        ) -> tuple[str, Optional[List[ServiceRoleInfo]]]:
            try:
                roles = await asyncio.wait_for(
                    self.fetch_service_roles(service_id),
                    timeout=0.5
                )
                return service_id, roles
            except asyncio.TimeoutError:
                self.logger.warning(
                    f"Timeout fetching roles from {service_id}",
                    extra={"service_id": service_id}
                )
                return service_id, None
            except Exception as e:
                self.logger.error(
                    f"Failed to fetch roles from {service_id}: {e}",
                    extra={"service_id": service_id, "error": str(e)}
                )
                return service_id, None
        
        # 並列実行
        results = await asyncio.gather(
            *[fetch_service_roles_safe(s.id) for s in services],
            return_exceptions=False
        )
        
        # 統合ロール情報を構築
        integrated_roles = {}
        failed_services = []
        
        for service_id, roles in results:
            if roles is not None:
                integrated_roles[service_id] = [
                    IntegratedRole(
                        service_id=service_id,
                        role_name=r.role_name,
                        description=r.description
                    )
                    for r in roles
                ]
            else:
                failed_services.append(service_id)
        
        # 全サービス失敗時はエラー
        if len(failed_services) == len(services):
            self.logger.error("All services failed to provide role information")
            raise HTTPException(
                status_code=503,
                detail={
                    "error": "ROLE_AGGREGATION_001_ALL_SERVICES_UNAVAILABLE",
                    "message": "All services failed to provide role information",
                    "failedServices": failed_services
                }
            )
        
        self.logger.info(
            f"Aggregated roles: {len(integrated_roles)} services, "
            f"{sum(len(r) for r in integrated_roles.values())} total roles, "
            f"{len(failed_services)} failed services",
            extra={
                "service_count": len(integrated_roles),
                "role_count": sum(len(r) for r in integrated_roles.values()),
                "failed_services": failed_services
            }
        )
        
        return integrated_roles
```

#### 3.5.2 テナントロールフィルタリング処理

**処理フロー**:
```mermaid
sequenceDiagram
    participant C as Client
    participant API as サービス設定サービス
    participant RA as RoleAggregator
    participant AR as AssignmentRepository
    participant SR as ServiceRepository
    
    C->>API: GET /api/v1/tenants/{tenant_id}/available-roles
    API->>RA: get_tenant_available_roles(tenant_id)
    RA->>AR: list_by_tenant(tenant_id, status="active")
    AR-->>RA: [ServiceAssignments]
    
    RA->>RA: コアサービスを自動追加
    RA->>RA: get_all_service_roles()
    
    Note over RA: 並列ロール取得（各サービス）
    
    RA->>RA: テナント利用サービスでフィルタリング
    RA-->>API: FilteredIntegratedRoles
    API-->>C: 200 OK
```

**実装詳細**:
```python
async def get_tenant_available_roles(
    self,
    tenant_id: str
) -> Dict[str, List[IntegratedRole]]:
    """
    テナント利用可能ロール取得
    
    Args:
        tenant_id: テナントID
    
    Returns:
        Dict[str, List[IntegratedRole]]: フィルタリングされた統合ロール情報
    
    Business Logic:
        1. テナントのServiceAssignment取得（status=active）
        2. コアサービス（auth-service、tenant-management、service-setting）を自動追加
        3. 全サービスのロール情報取得
        4. テナントが利用しているサービスのロールのみをフィルタ
    """
    # 1. テナントのServiceAssignment取得
    assignments = await self.assignment_repository.list_by_tenant(
        tenant_id, status="active"
    )
    
    # 2. コアサービスを自動追加
    available_service_ids = {
        "auth-service",
        "tenant-management",
        "service-setting"
    }
    
    # 3. 管理対象サービスを追加
    for assignment in assignments:
        available_service_ids.add(assignment.service_id)
    
    # 4. 全サービスのロール情報取得
    all_roles = await self.get_all_service_roles()
    
    # 5. フィルタリング
    filtered_roles = {
        service_id: roles
        for service_id, roles in all_roles.items()
        if service_id in available_service_ids
    }
    
    self.logger.info(
        f"Tenant available roles: {len(filtered_roles)} services, "
        f"{sum(len(r) for r in filtered_roles.values())} roles",
        extra={
            "tenant_id": tenant_id,
            "service_count": len(filtered_roles),
            "role_count": sum(len(r) for r in filtered_roles.values()),
            "assigned_services": list(available_service_ids - {"auth-service", "tenant-management", "service-setting"})
        }
    )
    
    return filtered_roles
```

### 3.6 エラーハンドリング

#### 3.6.1 エラーケース一覧

| エラーコード | 条件 | メッセージ | HTTPステータス | 対応 |
|--------------|------|------------|----------------|------|
| ROLE_AGGREGATION_001_ALL_SERVICES_UNAVAILABLE | 全サービスのロール取得に失敗 | All services failed to provide role information | 503 | 運用チームにアラート、一時的なエラーの可能性を示唆 |
| ROLE_AGGREGATION_002_SERVICE_TIMEOUT | 特定サービスのロール取得がタイムアウト | Timeout fetching roles from {service_id} | 200 (部分成功) | ログに警告記録、他のサービスのロールは返却 |
| ROLE_AGGREGATION_003_INVALID_RESPONSE | サービスのレスポンス形式が不正 | Invalid role response from {service_id} | 200 (部分成功) | ログにエラー記録、該当サービスのロールは除外 |
| TENANT_002_NOT_FOUND | テナントが存在しない | Tenant not found | 404 | テナントIDの確認を促す |
| TENANT_ISOLATION_VIOLATION | テナント分離違反 | Cannot access roles for different tenant | 403 | 権限エラー、自テナントのみアクセス可能と説明 |
| SERVICE_001_NOT_FOUND | サービスが存在しない | Service not found | 404 | サービスIDの確認を促す |
| CONFIG_001_SERVICE_URL_MISSING | サービスURLが設定されていない | Service URL not configured for {service_id} | 500 | 環境変数の設定を確認 |

#### 3.6.2 部分的失敗のハンドリング

**方針**:
- ロール情報取得は「ベストエフォート」で実行
- 一部サービスのロール取得失敗時も、他のサービスのロール情報は返却
- エラーログを記録し、運用チームに通知
- メタデータに失敗したサービスIDを含める

**実装例**:
```python
# 一部サービス失敗時のレスポンス例
{
  "roles": {
    "auth-service": [...],
    "tenant-management": [...]
    # file-service はタイムアウトで除外
  },
  "metadata": {
    "totalServices": 2,
    "totalRoles": 5,
    "failedServices": ["file-service"],  # 失敗したサービス
    "cachedAt": null
  }
}
```

### 3.7 セキュリティ考慮事項

#### 3.7.1 認証・認可
- **ロール統合API**: service-setting: 閲覧者 以上
- **テナント利用可能ロールAPI**: service-setting: 閲覧者 以上 + テナント分離チェック
- **サービス間通信**: 共有秘密鍵（`X-Service-Key`ヘッダー）で認証

#### 3.7.2 テナント分離
- 特権テナント以外は、自テナントの情報のみ取得可能
- 他テナントへのアクセス試行は403エラー
- リクエストパラメータのテナントIDとJWT内のテナントIDを照合

#### 3.7.3 情報漏洩防止
- ロール情報は公開情報（ロール名、説明のみ）
- 機密情報（権限の詳細、内部実装）は含まない
- エラーメッセージにサービスの内部構造を含めない

## 4. 非機能要件

### 4.1 性能要件

| 指標 | 目標値 (P95) | 最大値 (P99) | 測定方法 |
|------|--------------|--------------|----------|
| GET /api/v1/integrated-roles | < 500ms | < 800ms | Application Insights |
| GET /api/v1/tenants/{tenant_id}/available-roles | < 400ms | < 600ms | Application Insights |
| GET /api/v1/services/{service_id}/roles | < 200ms | < 300ms | Application Insights |
| 各サービスのロール情報取得 | < 50ms | < 100ms | ログとメトリクス |

**パフォーマンス最適化戦略**:
1. **並列処理**: `asyncio.gather`で最大7サービスを同時にロール情報取得
2. **タイムアウト設定**: 各サービス500ms、全体1秒のタイムアウト
3. **部分的失敗の許容**: 一部サービス失敗時も他のサービスのロールを返却
4. **キャッシング** (Phase 2): ロール情報を5分間キャッシュ、RU消費を削減

### 4.2 スケーラビリティ

#### 4.2.1 水平スケーリング
- サービス設定サービスのインスタンス数を増やすことで対応
- サービス間通信はステートレスなHTTP/REST

#### 4.2.2 サービス数の拡張性
- 新規サービス追加時、サービスカタログへの登録のみで自動統合
- ロール情報提供API（`/api/v1/roles`）の実装が必要
- サービス数が増えてもO(n)の並列処理で対応可能（最大20サービス想定）

### 4.3 可用性

#### 4.3.1 フォールト トレランス
- **一部サービス障害時**: 他のサービスのロール情報は正常に返却
- **全サービス障害時**: 503エラーを返し、運用チームにアラート
- **キャッシング** (Phase 2): Redis障害時もデータベースから取得可能

#### 4.3.2 監視とアラート
- **メトリクス**:
  - ロール情報取得の成功率（サービスごと）
  - レスポンスタイム（P50、P95、P99）
  - タイムアウト発生回数
- **アラート条件**:
  - ロール情報取得の成功率が80%未満（3分間継続）
  - P95レスポンスタイムが目標値の150%を超える（5分間継続）
  - 特定サービスのタイムアウトが10回/分以上

### 4.4 保守性

#### 4.4.1 ログ設計
- **構造化ログ**: JSON形式、Application Insights統合
- **ログレベル**:
  - INFO: ロール情報取得成功、統合結果のサマリー
  - WARNING: 一部サービスのロール取得失敗、タイムアウト
  - ERROR: 全サービスのロール取得失敗、設定エラー

**ログ例**:
```json
{
  "timestamp": "2026-02-02T10:00:00.123Z",
  "level": "INFO",
  "message": "Aggregated roles: 6 services, 18 total roles, 1 failed services",
  "service_count": 6,
  "role_count": 18,
  "failed_services": ["backup-service"],
  "request_id": "req_abc123"
}
```

#### 4.4.2 テストカバレッジ
- **目標**: 80%以上
- **重点テスト項目**:
  - 全サービスのロール取得成功
  - 一部サービスのロール取得失敗
  - 全サービスのロール取得失敗
  - タイムアウト処理
  - テナントフィルタリング

## 5. 制約条件

### 5.1 技術的制約
- **プログラミング言語**: Python 3.11+、FastAPI 0.100+
- **HTTPクライアント**: httpx（非同期対応）
- **タイムアウト**: 各サービス500ms、全体1秒
- **並列度**: 最大7サービス同時（`asyncio.gather`）
- **キャッシュ**: Phase 2でRedis導入予定

### 5.2 ビジネス的制約
- **Phase 1スコープ**: ロール情報の収集・統合のみ（Phase 2でキャッシング追加）
- **ロール項目**: ロール名と説明のみ（Phase 2で権限一覧、デフォルトロールを追加）
- **サービス数**: 最大20サービス想定（Phase 1は7サービス）

### 5.3 運用制約
- **デプロイ**: 各サービスは独立してデプロイ可能（マイクロサービス）
- **バージョン管理**: ロール情報提供APIはバージョニング不要（後方互換性を維持）
- **監視**: Application Insightsで一元管理

## 6. 依存関係

### 6.1 前提条件
- タスク07（サービス設定サービス-コアAPI）完了
- 認証認可サービスのロール管理機能（タスク04）完了
- テナント管理サービス（タスク05-06）完了

### 6.2 サービス間依存
- **認証認可サービス**: `/api/v1/roles` エンドポイント提供
- **テナント管理サービス**: `/api/v1/roles` エンドポイント提供
- **管理対象サービス4種**: `/api/v1/roles` エンドポイント実装（タスク09-13で実装）

### 6.3 後続タスクへの影響
- **タスク09-13（モックサービス）**: `/api/v1/roles` エンドポイントの実装が必要
- **タスク14-18（フロントエンド）**: ロール選択UI表示時に本APIを使用
- **タスク20（サービス間連携テスト）**: ロール統合機能のE2Eテスト

## 7. エラー処理

### 7.1 エラーコード一覧

| エラーコード | HTTPステータス | メッセージ | 原因 | 対応 |
|--------------|----------------|------------|------|------|
| ROLE_AGGREGATION_001_ALL_SERVICES_UNAVAILABLE | 503 | All services failed to provide role information | 全サービスのロール取得失敗 | 運用チームにアラート、サービスのヘルスチェック |
| ROLE_AGGREGATION_002_SERVICE_TIMEOUT | 200 (部分成功) | Timeout fetching roles from {service_id} | 特定サービスのタイムアウト | ログに警告、該当サービスを除外 |
| ROLE_AGGREGATION_003_INVALID_RESPONSE | 200 (部分成功) | Invalid role response from {service_id} | レスポンス形式が不正 | ログにエラー、該当サービスを除外 |
| TENANT_002_NOT_FOUND | 404 | Tenant not found | テナントが存在しない | テナントIDの確認 |
| TENANT_ISOLATION_VIOLATION | 403 | Cannot access roles for different tenant | テナント分離違反 | 自テナントのみアクセス可能と説明 |
| SERVICE_001_NOT_FOUND | 404 | Service not found | サービスが存在しない | サービスIDの確認 |
| CONFIG_001_SERVICE_URL_MISSING | 500 | Service URL not configured for {service_id} | 環境変数未設定 | 環境変数の設定確認 |

### 7.2 エラーハンドリングフロー

```mermaid
flowchart TD
    Start[ロール情報取得開始] --> ParallelFetch[並列ロール取得]
    ParallelFetch --> CheckResults{全サービス<br/>取得成功?}
    
    CheckResults -->|Yes| AllSuccess[全サービスのロールを返却]
    CheckResults -->|Partial| PartialSuccess[成功したサービスのロールを返却<br/>失敗サービスをログに記録]
    CheckResults -->|No| AllFailed[503エラー<br/>全サービス失敗をログに記録]
    
    AllSuccess --> End[200 OK]
    PartialSuccess --> End
    AllFailed --> AlertOps[運用チームにアラート]
    AlertOps --> End[503 Service Unavailable]
```

## 8. テスト観点

### 8.1 単体テスト

#### 8.1.1 RoleAggregatorクラス
- `fetch_service_roles`が正しくロール情報を取得できるか
- タイムアウト時に適切な例外が発生するか
- HTTPエラー時に適切な例外が発生するか
- `get_all_service_roles`が並列処理を正しく実行できるか
- 一部サービス失敗時も他のサービスのロールを返却できるか
- 全サービス失敗時に503エラーが発生するか

#### 8.1.2 テナントフィルタリング
- コアサービスが常に含まれるか
- ServiceAssignmentに基づいて管理対象サービスがフィルタリングされるか
- 利用していないサービスのロールが除外されるか

### 8.2 統合テスト

#### 8.2.1 エンドツーエンドテスト
- `GET /api/v1/integrated-roles`が全サービスのロール情報を返却できるか
- `GET /api/v1/tenants/{tenant_id}/available-roles`がテナントフィルタリングを正しく実行できるか
- 一部サービスがダウンしている場合、他のサービスのロール情報が返却されるか

#### 8.2.2 性能テスト
- P95レスポンスタイムが目標値以内か
- 並列処理が正しく実行され、7サービスの取得が順次実行よりも高速か
- タイムアウトが正しく機能し、500ms以内に失敗するか

### 8.3 受入テスト

#### 8.3.1 機能受入
- [ ] US-08-001: 管理者が全サービスのロール一覧を確認できる
- [ ] US-08-002: テナントが利用可能なロールのみを表示できる
- [ ] US-08-003: 各サービスのロール定義を動的に取得できる

#### 8.3.2 非機能受入
- [ ] P95レスポンスタイムが目標値以内
- [ ] 一部サービス障害時も他のサービス情報が取得できる
- [ ] ログとメトリクスが正しく記録される

## 9. 実装計画

### 9.1 Phase 1（タスク08）

#### 9.1.1 実装スコープ
- ロール情報収集インターフェース（`RoleAggregator`クラス）
- 統合ロールAPI 3種の実装
- テナントフィルタリング機能
- 単体テスト、統合テスト

#### 9.1.2 実装順序
1. **データモデル定義** (0.5日)
   - `IntegratedRole`、`ServiceRoleInfo`、`IntegratedRolesResponse`
2. **RoleAggregatorクラス実装** (1.5日)
   - `fetch_service_roles`、`get_all_service_roles`
   - エラーハンドリング、並列処理
3. **APIエンドポイント実装** (1.5日)
   - `GET /api/v1/integrated-roles`
   - `GET /api/v1/tenants/{tenant_id}/available-roles`
   - `GET /api/v1/services/{service_id}/roles`
4. **単体テスト作成** (1日)
   - RoleAggregatorのテスト（モック使用）
   - テナントフィルタリングのテスト
5. **統合テスト作成** (1日)
   - E2Eテスト（実サービス通信）
   - タイムアウト、エラーハンドリングテスト
6. **ドキュメント作成** (0.5日)
   - API仕様書更新
   - 実装ガイドライン（各サービスの `/api/v1/roles` 実装方法）

**合計**: 6日

### 9.2 Phase 2（将来拡張）

#### 9.2.1 キャッシング機能
- Redisによるロール情報キャッシュ（TTL: 5分）
- キャッシュ無効化API
- キャッシュヒット率のメトリクス

#### 9.2.2 拡張データモデル
- `permissions`フィールド追加（権限一覧）
- `is_default`フィールド追加（デフォルトロール）
- `display_order`フィールド追加（表示順序）

#### 9.2.3 ロール依存関係
- ロール階層構造のサポート
- ロール間の依存関係管理

## 10. 付録

### 10.1 サンプルレスポンス

#### 10.1.1 全サービスのロール情報
```json
{
  "roles": {
    "auth-service": [
      {
        "serviceId": "auth-service",
        "roleName": "全体管理者",
        "description": "ユーザー登録・削除、ロール割り当て"
      },
      {
        "serviceId": "auth-service",
        "roleName": "閲覧者",
        "description": "ユーザー情報の参照のみ"
      }
    ],
    "tenant-management": [
      {
        "serviceId": "tenant-management",
        "roleName": "全体管理者",
        "description": "特権テナント操作、全テナント管理"
      },
      {
        "serviceId": "tenant-management",
        "roleName": "管理者",
        "description": "通常テナントの追加・削除・編集"
      },
      {
        "serviceId": "tenant-management",
        "roleName": "閲覧者",
        "description": "テナント情報の参照のみ"
      }
    ],
    "service-setting": [
      {
        "serviceId": "service-setting",
        "roleName": "全体管理者",
        "description": "サービス割り当て・削除"
      },
      {
        "serviceId": "service-setting",
        "roleName": "閲覧者",
        "description": "サービス利用状況の参照"
      }
    ],
    "file-service": [
      {
        "serviceId": "file-service",
        "roleName": "管理者",
        "description": "全機能へのアクセス"
      },
      {
        "serviceId": "file-service",
        "roleName": "編集者",
        "description": "ファイルのアップロード、削除"
      },
      {
        "serviceId": "file-service",
        "roleName": "閲覧者",
        "description": "ファイルのダウンロード、一覧表示のみ"
      }
    ],
    "messaging-service": [
      {
        "serviceId": "messaging-service",
        "roleName": "管理者",
        "description": "チャネル管理、メンバー管理"
      },
      {
        "serviceId": "messaging-service",
        "roleName": "メンバー",
        "description": "メッセージ送受信"
      },
      {
        "serviceId": "messaging-service",
        "roleName": "閲覧者",
        "description": "メッセージ閲覧のみ"
      }
    ],
    "api-service": [
      {
        "serviceId": "api-service",
        "roleName": "管理者",
        "description": "APIキー管理、制限設定"
      },
      {
        "serviceId": "api-service",
        "roleName": "開発者",
        "description": "APIキー閲覧、利用統計確認"
      },
      {
        "serviceId": "api-service",
        "roleName": "閲覧者",
        "description": "利用統計閲覧のみ"
      }
    ],
    "backup-service": [
      {
        "serviceId": "backup-service",
        "roleName": "管理者",
        "description": "全操作可能"
      },
      {
        "serviceId": "backup-service",
        "roleName": "オペレーター",
        "description": "バックアップ実行、リストア実行"
      },
      {
        "serviceId": "backup-service",
        "roleName": "閲覧者",
        "description": "履歴閲覧のみ"
      }
    ]
  },
  "metadata": {
    "totalServices": 7,
    "totalRoles": 21,
    "failedServices": [],
    "cachedAt": null
  }
}
```

### 10.2 各サービスのロール定義実装ガイドライン

#### 10.2.1 標準実装テンプレート
```python
# app/api/roles.py
from fastapi import APIRouter
from typing import List
from pydantic import BaseModel, Field

router = APIRouter()

class RoleInfo(BaseModel):
    """ロール情報"""
    role_name: str = Field(..., alias="roleName")
    description: str

@router.get("/roles", response_model=dict)
async def get_service_roles():
    """
    サービスロール一覧取得（認証不要）
    
    Returns:
        dict: ロール一覧（data配列形式）
    
    Note:
        サービス設定サービスから呼び出されるため、認証は不要
    """
    roles = [
        RoleInfo(
            role_name="管理者",
            description="全機能へのアクセス"
        ),
        RoleInfo(
            role_name="編集者",
            description="データの作成・編集"
        ),
        RoleInfo(
            role_name="閲覧者",
            description="データの参照のみ"
        ),
    ]
    
    return {
        "data": [role.model_dump(by_alias=True) for role in roles]
    }

# app/main.py
from app.api import roles

app.include_router(roles.router, prefix="/api/v1")
```

#### 10.2.2 ロール設計のベストプラクティス
1. **ロール名は日本語で簡潔に**: "管理者"、"編集者"、"閲覧者"など
2. **説明は50-200文字**: 権限の概要を明確に記述
3. **ロール階層を意識**: 上位ロールは下位ロールの権限を包含
4. **一般的なロール名を使用**: システム間で統一された命名規則

### 10.3 環境変数設定

#### 10.3.1 サービスURL設定
```bash
# .env
AUTH_SERVICE_URL=http://auth-service:8001
TENANT_SERVICE_URL=http://tenant-management-service:8002
FILE_SERVICE_URL=http://file-service:8003
MESSAGING_SERVICE_URL=http://messaging-service:8004
API_SERVICE_URL=http://api-service:8005
BACKUP_SERVICE_URL=http://backup-service:8006

# サービス間認証用共有秘密鍵
SERVICE_SHARED_SECRET=your-secure-secret-key-here
```

---

**文書管理情報**:
- **作成日**: 2026-02-02
- **作成者**: Architecture Team
- **承認者**: (未定)
- **バージョン**: 1.0.0
- **次回レビュー予定**: Phase 1実装完了後
