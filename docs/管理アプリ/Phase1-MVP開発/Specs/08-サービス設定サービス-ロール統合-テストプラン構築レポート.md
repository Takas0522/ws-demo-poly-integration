# テストプラン構築レポート: タスク08 サービス設定サービス - ロール統合

## 対象機能
**タスク08**: サービス設定サービス - ロール統合

**実装対象ファイル**:
- **Models**: `app/models/role.py`
- **Schemas**: `app/schemas/role.py`
- **Services**: `app/services/role_aggregator.py`
- **APIs**: `app/api/roles.py`, `app/api/service_roles.py` (service-setting-service)
- **APIs**: `app/api/roles.py` (tenant-management-service)

## テストケース数
| カテゴリ | 件数 | 説明 |
|----------|------|------|
| **正常系** | 42件 | 基本的な機能が正常に動作することを検証 |
| **異常系** | 28件 | エラーケースでの適切なエラーハンドリングを検証 |
| **境界値** | 18件 | 境界条件での動作を検証 |
| **セキュリティ** | 16件 | サービス間認証、テナント分離、認可を検証 |
| **ログ検証** | 12件 | ログの記録とフォーマットを検証 |
| **エッジケース** | 14件 | 特殊な条件での動作を検証 |
| **パフォーマンス** | 3件 | 並列処理とタイムアウトの動作を検証 |
| **合計** | **133件** | - |

### 各レイヤー別のテストケース数
| レイヤー | 正常系 | 異常系 | 境界値 | その他 | 合計 |
|----------|--------|--------|--------|--------|------|
| **Models** | 6 | 7 | 4 | 6 | 23 |
| **Schemas** | 10 | 8 | 6 | 2 | 26 |
| **Services** | 10 | 8 | 4 | 9 | 31 |
| **APIs** | 12 | 5 | 2 | 14 | 33 |
| **認証** | 4 | 0 | 0 | 16 | 20 |
| **合計** | 42 | 28 | 16 | 47 | **133** |

## 作成したテストファイル

### service-setting-service
1. **Models層テスト**: [tests/test_models/test_role.py](../../src/service-setting-service/tests/test_models/test_role.py)
   - `TestIntegratedRole`: 13テストメソッド
   - `TestServiceRoleInfo`: 8テストメソッド
   - `TestIntegratedRoleとServiceRoleInfoの相互変換`: 2テストメソッド

2. **Schemas層テスト**: [tests/test_schemas/test_role.py](../../src/service-setting-service/tests/test_schemas/test_role.py)
   - `TestIntegratedRolesResponse`: 7テストメソッド
   - `TestIntegratedRolesMetadata`: 7テストメソッド
   - `TestTenantAvailableRolesResponse`: 4テストメソッド
   - `TestTenantRolesMetadata`: 3テストメソッド
   - `TestServiceRoleResponse`: 5テストメソッド
   - `TestServiceRoleMetadata`: 4テストメソッド

3. **Services層テスト**: [tests/test_services/test_role_aggregator.py](../../src/service-setting-service/tests/test_services/test_role_aggregator.py)
   - `TestFetchServiceRoles`: 13テストメソッド
   - `TestGetAllServiceRoles`: 8テストメソッド
   - `TestGetTenantAvailableRoles`: 6テストメソッド
   - `TestGetServiceRoles`: 4テストメソッド

4. **APIs層テスト**: [tests/test_api/test_roles_integration.py](../../src/service-setting-service/tests/test_api/test_roles_integration.py)
   - `TestGetIntegratedRoles`: 13テストメソッド
   - `TestGetTenantAvailableRoles`: 10テストメソッド
   - `TestGetServiceRoles`: 7テストメソッド
   - `TestGetIntegratedRolesパフォーマンス`: 1テストメソッド
   - `Testエラーハンドリング`: 2テストメソッド

5. **サービス間認証テスト**: [tests/test_api/test_service_roles_authentication.py](../../src/service-setting-service/tests/test_api/test_service_roles_authentication.py)
   - `TestServiceRolesEndpointAuthentication`: 14テストメソッド
   - `TestServiceSharedSecretConfiguration`: 3テストメソッド
   - `TestServiceRolesEndpoint認証なしアクセス`: 2テストメソッド

### tenant-management-service
6. **サービス間認証テスト**: [tests/test_api_roles_authentication.py](../../src/tenant-management-service/tests/test_api_roles_authentication.py)
   - `TestTenantManagementRolesEndpointAuthentication`: 14テストメソッド
   - `TestTenantManagementServiceSharedSecretConfiguration`: 3テストメソッド
   - `TestTenantManagementRolesEndpoint認証なしアクセス`: 2テストメソッド
   - `TestTenantManagementRoleDefinitions`: 4テストメソッド

### 既存のテストファイル（拡張済み）
7. **既存 APIs層テスト**: [tests/test_api/test_roles_api.py](../../src/service-setting-service/tests/test_api/test_roles_api.py)
   - 既存の8テストメソッドが実装済み（基本的な統合テスト）

## カバレッジ目標

| 種類 | 目標 | 達成見込み |
|------|------|------------|
| **行カバレッジ** | 80%以上 | ✅ 85%以上（見込み） |
| **分岐カバレッジ** | 70%以上 | ✅ 75%以上（見込み） |
| **重要ロジック** | 100% | ✅ 100%（設計済み） |

### 重要ロジックのカバレッジ（100%）
- ✅ サービス間認証チェック（X-Service-Key検証）
- ✅ テナント分離チェック（特権テナント判定）
- ✅ 並列ロール取得（asyncio.gather）
- ✅ 部分的失敗のハンドリング（一部サービス障害時）
- ✅ タイムアウト処理（500ms制限）
- ✅ エラーログの機密情報保護（レスポンス200文字制限）

## テスト設計の特徴

### 1. ISTQB準拠のテスト設計
- **同値分割法**: 正常系と異常系で明確に分類
- **境界値分析**: タイムアウト、文字数制限、サービス数
- **デシジョンテーブル**: テナント分離の条件分岐
- **状態遷移テスト**: ロール取得の成功・部分失敗・全失敗

### 2. OWASPセキュリティ準拠
| OWASP項目 | テストケース | 検証内容 |
|-----------|--------------|----------|
| A01: アクセス制御の不備 | TA-010, TA-011 | テナント分離違反の防止 |
| A05: セキュリティ設定のミス | TSA-004 ~ TSA-006 | 環境変数とサービス間認証 |
| A07: 認証の失敗 | TSA-001 ~ TSA-010 | サービス間認証の正確性 |
| A09: ログとモニタリング | TSV-017 ~ TSV-019 | ログの機密情報保護 |

### 3. 階層的なテスト構成
```
Models層 (単体テスト)
    ↓
Schemas層 (単体テスト)
    ↓
Services層 (統合テスト: Services + Repositories + HTTPクライアント)
    ↓
APIs層 (E2Eテスト: APIs + Services + Dependencies)
```

### 4. モック設計
- **HTTPクライアント**: `httpx.AsyncClient`のモックで外部サービス通信をシミュレート
- **Cosmos DB**: `mock_cosmos_container`で永続化層をモック
- **Repository**: `AsyncMock`でビジネスロジック層をモック
- **Logger**: `caplog`でログ記録を検証

### 5. エラーケースの網羅性
| エラー種別 | テストケース数 | 検証内容 |
|------------|----------------|----------|
| バリデーションエラー | 15件 | 必須フィールド、型、境界値 |
| HTTPエラー | 8件 | 404, 503, タイムアウト |
| 認証・認可エラー | 11件 | 401, 403, テナント分離 |
| ビジネスロジックエラー | 4件 | 全サービス障害、部分失敗 |

## テスト実行方法

### 全テスト実行
```bash
# service-setting-service
cd /workspaces/ws-demo-poly-integration/src/service-setting-service

# 全テスト実行
pytest tests/test_models/test_role.py \
       tests/test_schemas/test_role.py \
       tests/test_services/test_role_aggregator.py \
       tests/test_api/test_roles_integration.py \
       tests/test_api/test_service_roles_authentication.py \
       tests/test_api/test_roles_api.py \
       -v

# tenant-management-service
cd /workspaces/ws-demo-poly-integration/src/tenant-management-service
pytest tests/test_api_roles_authentication.py -v
```

### カバレッジ測定
```bash
# service-setting-service
pytest tests/test_models/test_role.py \
       tests/test_schemas/test_role.py \
       tests/test_services/test_role_aggregator.py \
       tests/test_api/test_roles_integration.py \
       tests/test_api/test_service_roles_authentication.py \
       --cov=app/models/role \
       --cov=app/schemas/role \
       --cov=app/services/role_aggregator \
       --cov=app/api/roles \
       --cov=app/api/service_roles \
       --cov-report=html \
       --cov-report=term

# tenant-management-service
pytest tests/test_api_roles_authentication.py \
       --cov=app/api/roles \
       --cov-report=html \
       --cov-report=term
```

### カテゴリ別実行
```bash
# 正常系のみ
pytest -k "Test正常系" -v

# 異常系のみ
pytest -k "Test異常系" -v

# セキュリティテストのみ
pytest -k "Testセキュリティ" -v

# ログ検証のみ
pytest -k "Testログ検証" -v
```

## テストコードの構成

### 1. テストメソッドの命名規則
```python
def test_{テストケースID}_{テストの説明}(self):
    """テストケースID: 検証内容の詳細説明"""
    # TODO: テスト実装
    pass
```

### 2. テストクラスの階層構造
```python
class TestTargetClass:
    """ターゲットクラスの説明"""
    
    class Test正常系:
        """正常系テスト"""
        # TODO: テスト実装
    
    class Test異常系:
        """異常系テスト"""
        # TODO: テスト実装
    
    class Test境界値:
        """境界値テスト"""
        # TODO: テスト実装
```

### 3. フィクスチャの定義
既存の`conftest.py`を活用し、以下のフィクスチャを追加:
- `mock_service_repository`
- `mock_assignment_repository`
- `mock_http_client`
- `role_aggregator`

## リスクベース分析

### 高リスク項目（優先度: 高）
| リスク | 影響度 | 発生確率 | テストケース | 対策 |
|--------|--------|----------|--------------|------|
| サービス間認証の不備 | 高 | 中 | TSA-004 ~ TSA-007 | X-Service-Key検証の徹底 |
| テナント分離違反 | 高 | 中 | TA-010, TA-011 | 特権テナント判定の実装 |
| 全サービス障害時の処理 | 高 | 低 | TSV-011, TA-014 | 503エラーの適切な返却 |
| ログの機密情報漏洩 | 高 | 低 | TSV-019 | レスポンス200文字制限 |

### 中リスク項目（優先度: 中）
| リスク | 影響度 | 発生確率 | テストケース | 対策 |
|--------|--------|----------|--------------|------|
| タイムアウト処理の不具合 | 中 | 中 | TSV-007, TSV-012 | 500ms制限の徹底 |
| 並列処理の競合 | 中 | 低 | TSV-006 | asyncio.gatherの正確性検証 |

### 低リスク項目（優先度: 低）
| リスク | 影響度 | 発生確率 | テストケース | 対策 |
|--------|--------|----------|--------------|------|
| レスポンス形式の不一致 | 低 | 低 | TA-004 | スキーマバリデーション |
| Phase 2フィールドの未実装 | 低 | 高 | TM-009, TM-010 | デフォルト値の設定 |

## 品質保証観点（ISTQB準拠）

| 観点 | 評価 | 説明 |
|------|------|------|
| **機能適合性** | ✅ | 仕様書の要件を満たすテストケース設計 |
| **信頼性** | ✅ | エラーハンドリング、部分失敗のテスト網羅 |
| **セキュリティ** | ✅ | 認証・認可、テナント分離のテスト完備 |
| **保守性** | ✅ | 階層的なテスト構成、明確な命名規則 |
| **移植性** | ✅ | 環境依存なし（モックを使用） |

## 次のステップ

### 1. テスト実装（優先度: 高）
- [ ] Models層テスト実装（所要時間: 2時間）
- [ ] Schemas層テスト実装（所要時間: 2時間）
- [ ] Services層テスト実装（所要時間: 4時間）
- [ ] APIs層テスト実装（所要時間: 4時間）
- [ ] サービス間認証テスト実装（所要時間: 2時間）

**合計所要時間**: 14時間（2営業日）

### 2. カバレッジ測定と改善（優先度: 中）
- [ ] カバレッジ測定実施
- [ ] 80%未満の箇所を特定
- [ ] 追加テストケース作成

### 3. テストドキュメント整備（優先度: 低）
- [ ] テスト実行結果のレポート作成
- [ ] カバレッジレポートの保存
- [ ] テスト品質メトリクスの記録

## 備考

### テスト実装時の注意事項
1. **非同期テスト**: 必ず`@pytest.mark.asyncio`デコレータを使用
2. **モックの設定**: HTTPクライアントのモックは各テストで適切に設定
3. **ログ検証**: `caplog`フィクスチャを使用してログレベルとメッセージを確認
4. **エラーメッセージ**: エラーコードの一貫性を検証
5. **テナント分離**: 特権テナントと一般テナントの両方でテスト

### テストデータの管理
- サンプルデータは`conftest.py`に集約
- テストメソッド内で動的に生成するデータは最小限に
- モックレスポンスは定数として定義

### パフォーマンステスト
- 並列処理のパフォーマンステストは`time.time()`で測定
- タイムアウトテストは`asyncio.sleep()`でシミュレート

---

**レポート作成日**: 2026-02-02  
**作成者**: Test Planner Agent  
**バージョン**: 1.0.0  
**関連ドキュメント**:
- [テスト設計書](./08-サービス設定サービス-ロール統合-テスト設計書.md)
- [仕様書](./08-サービス設定サービス-ロール統合.md)
- [実装レビュー](../review/08-サービス設定サービス-ロール統合-impl-review-002.md)
