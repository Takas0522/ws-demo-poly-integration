# 工程5: サンプルデータの構成 - 完了レポート

## 実施日
2024年

## 作業概要
マルチテナントSaaS PoC環境のデモンストレーション用サンプルデータを作成し、投入スクリプトとドキュメントを整備しました。

---

## 成果物

### 1. サンプルデータ定義ファイル
**ファイル**: `scripts/seed_data/sample_data.py`
**サイズ**: 8.7KB
**内容**:
- サンプルテナント: 10件
- サンプルユーザー: 35件
- ロール割り当て: 104件
- サービス割り当て: 27件
- テストアカウント定義: 3件

**特徴**:
- 実際の企業名やドメインを模したリアルなデータ
- ランダム化によるデータの多様性
- 4つのロール割り当てパターン（管理者、ファイル管理者、一般ユーザー、閲覧者）
- 3つのサービスパッケージ（基本、ビジネス、エンタープライズ）

### 2. サンプルデータ投入スクリプト
**ファイル**: `scripts/seed_sample_data.py`
**サイズ**: 7.8KB
**内容**:
- データ投入の自動化
- エラーハンドリング（重複データのスキップ）
- 投入結果の統計表示
- テストアカウント情報の出力

**機能**:
```python
class SampleDataSeeder:
    def seed_tenant_data()          # テナントデータ投入
    def seed_user_data()             # ユーザーデータ投入
    def seed_tenant_service_data()  # サービス割り当て投入
    def print_summary()              # 結果サマリー表示
```

**実行方法**:
```bash
# 環境変数設定
export COSMOS_ENDPOINT="https://your-cosmos.documents.azure.com:443/"
export COSMOS_KEY="your-key"

# スクリプト実行
python scripts/seed_sample_data.py
```

### 3. サンプルデータドキュメント
**ファイル**: `docs/サンプルデータ.md`
**サイズ**: 15KB
**内容**:
1. サンプルデータの構成
2. データ投入方法
3. テストアカウント一覧
4. 利用シナリオ例（4パターン）
5. データのクリーンアップ方法
6. トラブルシューティング

---

## サンプルデータの詳細

### テナント構成（10社）

| # | テナント名 | ドメイン数 | 想定業種 |
|---|----------|----------|---------|
| 1 | 株式会社サンプルコーポレーション | 2 | 総合商社 |
| 2 | テックイノベーション株式会社 | 1 | IT企業 |
| 3 | グローバルソリューションズ | 2 | コンサルティング |
| 4 | デジタルマーケティングパートナーズ | 1 | マーケティング |
| 5 | クラウドシステムズ株式会社 | 2 | クラウドサービス |
| 6 | エンタープライズソリューション | 1 | SI |
| 7 | スマートデータ株式会社 | 1 | データ分析 |
| 8 | ビジネスアクセラレータ | 1 | スタートアップ支援 |
| 9 | フューチャーテクノロジーズ | 2 | 技術開発 |
| 10 | インテグレーションワークス | 1 | システム開発 |

### ユーザー分布

- **合計ユーザー数**: 35名
- **テナントあたり**: 3-5名
- **ロール割り当てパターン**:
  - 管理者系: 20% (約7名)
  - ファイル管理中心: 30% (約11名)
  - 一般ユーザー: 30% (約11名)
  - 閲覧者: 20% (約7名)

### サービス割り当て

- **基本パッケージ**: ファイル管理、メッセージング
- **ビジネスパッケージ**: 基本 + API利用
- **エンタープライズパッケージ**: ビジネス + バックアップ

---

## テストアカウント

### 1. システム管理者（初期データ）
```
メール    : admin@system.local
パスワード: Admin@12345
権限      : 全権限
```

### 2. テナント管理者
```
メール    : taro.yamada1@sample-corp.co.jp
パスワード: Password@123
権限      : テナント管理、ユーザー管理
```

### 3. 一般ユーザー
```
メール    : taro.yamada2@tech-innovation.jp
パスワード: Password@123
権限      : ファイル管理、メッセージング
```

### 4. 閲覧者
```
メール    : hanako.sato3@global-solutions.com
パスワード: Password@123
権限      : 情報参照のみ
```

---

## 動作確認結果

### ✅ 構文チェック
- `sample_data.py`: OK
- `seed_sample_data.py`: OK

### ✅ データ生成確認
```
テナント数              : 10
ユーザー数              : 35
ユーザーロール割り当て数: 104
テナント-サービス割り当て数: 27
テストアカウント数      : 3
```

### ✅ エラーハンドリング確認
- 環境変数未設定時: 適切なエラーメッセージ表示 ✓
- 重複データ投入時: スキップ処理 ✓

---

## 利用シナリオ

### シナリオ1: マルチテナント機能の確認
**目的**: テナント間のデータ分離確認
**使用アカウント**: 異なるテナントの2ユーザー

### シナリオ2: ロールベースアクセス制御の確認
**目的**: ロールに応じた権限制御の確認
**使用アカウント**: 管理者、一般ユーザー、閲覧者

### シナリオ3: サービス割り当ての確認
**目的**: テナントごとのサービス利用制限確認
**使用アカウント**: 異なるパッケージのテナントユーザー

### シナリオ4: システム管理者による全体管理
**目的**: 特権テナントの管理機能確認
**使用アカウント**: admin@system.local

---

## 技術的な特徴

### データ生成の工夫
1. **UUID生成**: 一貫性のあるID生成
2. **タイムスタンプ**: ランダムな作成日時（過去30-180日）
3. **ドメイン**: テナント固有のメールドメイン
4. **パスワードハッシュ**: bcryptによる安全なハッシュ化

### エラーハンドリング
1. **環境変数チェック**: 実行前の必須変数確認
2. **Conflictエラー**: 重複データのスキップ
3. **統計情報**: 作成数とスキップ数の表示

### 保守性
1. **モジュール分割**: データ定義と投入ロジックの分離
2. **定数定義**: SERVICE_IDS, ROLE_IDSの一元管理
3. **コメント**: 各セクションの明確な説明

---

## 既存システムとの統合

### 既存の初期データとの関係
- **保持**: 特権テナント、管理者ユーザー
- **拡張**: サンプルテナント、サンプルユーザーを追加
- **互換性**: 既存のサービス定義、ロール定義を使用

### データベース構造
```
tenant_management/
  └── tenants/
      ├── 特権テナント（初期データ）
      ├── サンプルテナント（10件）
      └── テナント-ユーザー紐付け

auth_management/
  ├── users/
  │   ├── 管理者ユーザー（初期データ）
  │   ├── サンプルユーザー（35件）
  │   └── ユーザーロール紐付け（104件）
  └── roles/
      └── ロール定義（初期データ、15件）

service_management/
  └── services/
      ├── サービス定義（初期データ、7件）
      └── テナント-サービス紐付け（27件）
```

---

## 完了条件チェック

- [x] サンプルデータスクリプトが作成されている
  - `scripts/seed_data/sample_data.py` ✓
  - `scripts/seed_sample_data.py` ✓

- [x] ドキュメントが作成されている
  - `docs/サンプルデータ.md` ✓

- [x] スクリプトが正常に実行可能である
  - 構文チェック: OK ✓
  - データ生成: OK ✓
  - エラーハンドリング: OK ✓

---

## 次のステップ

### 1. 実環境での投入（オプション）
```bash
# 環境変数設定
export COSMOS_ENDPOINT="実際のエンドポイント"
export COSMOS_KEY="実際のキー"

# 初期データ投入（未実施の場合）
python scripts/create_database.py
python scripts/seed_database.py

# サンプルデータ投入
python scripts/seed_sample_data.py
```

### 2. E2Eテスト
- テストアカウントでのログイン確認
- マルチテナント機能の動作確認
- ロールベースアクセス制御の確認

### 3. デモンストレーション準備
- シナリオ1-4の実施手順書作成
- デモ用スライドへの組み込み
- 想定質問への回答準備

---

## 注意事項

1. **セキュリティ**
   - サンプルデータは共通パスワード `Password@123` を使用
   - 本番環境では使用しないこと
   - デモ終了後はデータをクリーンアップすること

2. **データ量**
   - PoCとして適切な規模（テナント10件、ユーザー35件）
   - 必要に応じてsample_data.pyを編集してデータ量を調整可能

3. **互換性**
   - 既存の初期データとの共存を確認済み
   - 初期データは削除・変更されない

---

## 参考情報

### 関連ドキュメント
- [データモデル設計](./arch/data/data-model.md)
- [初期データ定義](../scripts/seed_data/initial_data.py)
- [サンプルデータ詳細](./サンプルデータ.md)

### ファイル構成
```
scripts/
├── seed_data/
│   ├── __init__.py
│   ├── initial_data.py     # 既存: 初期データ定義
│   └── sample_data.py      # 新規: サンプルデータ定義
├── seed_database.py        # 既存: 初期データ投入
└── seed_sample_data.py     # 新規: サンプルデータ投入

docs/
└── サンプルデータ.md        # 新規: サンプルデータドキュメント
```

---

## まとめ

✅ **工程5「サンプルデータの構成」を完了しました**

- デモンストレーション用の充実したサンプルデータを作成
- 簡単にデータ投入できる自動化スクリプトを整備
- 詳細なドキュメントと利用シナリオを提供
- 既存の初期データとの互換性を維持

これにより、PoC環境でのデモンストレーションやテストが容易になり、マルチテナントSaaSの機能を効果的に示すことができます。
