# デプロイ手順書

## ドキュメント情報

- **バージョン**: 1.0.0
- **最終更新日**: 2024年
- **対象環境**: 開発環境、本番環境

---

## 目次

1. [事前準備](#1-事前準備)
2. [ローカル開発環境デプロイ](#2-ローカル開発環境デプロイ)
3. [Azure インフラストラクチャデプロイ](#3-azure-インフラストラクチャデプロイ)
4. [アプリケーションデプロイ](#4-アプリケーションデプロイ)
5. [デプロイ後の確認](#5-デプロイ後の確認)
6. [ロールバック手順](#6-ロールバック手順)
7. [トラブルシューティング](#7-トラブルシューティング)

---

## 1. 事前準備

### 1.1 必要なツール

以下のツールがインストールされていることを確認：

| ツール | バージョン | 用途 |
|--------|-----------|------|
| **Azure CLI** | 2.50以上 | Azureリソース管理 |
| **Docker** | 20.10以上 | コンテナビルド |
| **Node.js** | 18.x以上 | フロントエンドビルド |
| **Python** | 3.11以上 | バックエンド実行 |
| **Git** | 2.30以上 | ソース管理 |

```bash
# バージョン確認
az --version
docker --version
node --version
python --version
git --version
```

### 1.2 Azure ログイン

```bash
# Azureにログイン
az login

# サブスクリプション確認
az account list --output table

# サブスクリプション設定
az account set --subscription "<subscription-id>"
```

### 1.3 環境変数の準備

環境ごとの設定ファイルを準備：

```bash
# 開発環境
cp .env.example .env.dev

# 本番環境
cp .env.example .env.prod
```

**必須環境変数**:
```bash
# Cosmos DB
COSMOS_ENDPOINT=
COSMOS_KEY=

# JWT
JWT_SECRET=

# Azure
AZURE_SUBSCRIPTION_ID=
AZURE_RESOURCE_GROUP=
```

---

## 2. ローカル開発環境デプロイ

### 2.1 リポジトリのクローン

```bash
git clone <repository-url>
cd ws-demo-poly-integration
```

### 2.2 DevContainer での起動

1. VS Code でプロジェクトを開く
2. コマンドパレット (Ctrl+Shift+P) を開く
3. "Dev Containers: Reopen in Container" を選択
4. コンテナのビルドと起動を待つ（初回は10分程度）

### 2.3 Docker Compose での起動

```bash
# すべてのサービスを起動
docker-compose up -d

# ログ確認
docker-compose logs -f

# サービス状態確認
docker-compose ps
```

### 2.4 各サービスの起動

#### Cosmos DB Emulator

```bash
# Docker Compose で自動起動
# アクセス: https://localhost:8081/_explorer/index.html
```

#### Frontend (Next.js)

```bash
cd src/front
npm install
npm run dev
# アクセス: http://localhost:3000
```

#### 認証認可サービス

```bash
cd src/auth-service
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8001
# API Docs: http://localhost:8001/docs
```

#### テナント管理サービス

```bash
cd src/tenant-management-service
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8002
# API Docs: http://localhost:8002/docs
```

#### 利用サービス設定サービス

```bash
cd src/service-setting-service
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8003
# API Docs: http://localhost:8003/docs
```

---

## 3. Azure インフラストラクチャデプロイ

### 3.1 リソースグループの作成

```bash
# 開発環境
az group create \
  --name rg-poc-dev \
  --location japaneast

# 本番環境
az group create \
  --name rg-poc-prod \
  --location japaneast
```

### 3.2 Bicep テンプレートのバリデーション

```bash
cd infra

# 開発環境
az deployment group validate \
  --resource-group rg-poc-dev \
  --template-file main.bicep \
  --parameters @parameters.dev.json

# 本番環境
az deployment group validate \
  --resource-group rg-poc-prod \
  --template-file main.bicep \
  --parameters @parameters.prod.json
```

### 3.3 What-If デプロイ

変更内容を事前確認：

```bash
az deployment group what-if \
  --resource-group rg-poc-dev \
  --template-file main.bicep \
  --parameters @parameters.dev.json
```

### 3.4 インフラストラクチャデプロイ

#### 開発環境

```bash
az deployment group create \
  --resource-group rg-poc-dev \
  --template-file main.bicep \
  --parameters @parameters.dev.json \
  --name deployment-$(date +%Y%m%d-%H%M%S)
```

#### 本番環境

```bash
az deployment group create \
  --resource-group rg-poc-prod \
  --template-file main.bicep \
  --parameters @parameters.prod.json \
  --name deployment-$(date +%Y%m%d-%H%M%S) \
  --confirm-with-what-if  # 本番環境では確認プロンプトを表示
```

### 3.5 デプロイ結果の確認

```bash
# デプロイ状態確認
az deployment group show \
  --resource-group rg-poc-dev \
  --name <deployment-name>

# リソース一覧確認
az resource list \
  --resource-group rg-poc-dev \
  --output table
```

---

## 4. アプリケーションデプロイ

### 4.1 Dockerイメージのビルド

#### 認証認可サービス

```bash
cd src/auth-service

# イメージビルド
docker build -t auth-service:latest .

# Azure Container Registry にプッシュ
az acr login --name <acr-name>
docker tag auth-service:latest <acr-name>.azurecr.io/auth-service:latest
docker push <acr-name>.azurecr.io/auth-service:latest
```

#### テナント管理サービス

```bash
cd src/tenant-management-service
docker build -t tenant-service:latest .
docker tag tenant-service:latest <acr-name>.azurecr.io/tenant-service:latest
docker push <acr-name>.azurecr.io/tenant-service:latest
```

#### 利用サービス設定サービス

```bash
cd src/service-setting-service
docker build -t service-setting:latest .
docker tag service-setting:latest <acr-name>.azurecr.io/service-setting:latest
docker push <acr-name>.azurecr.io/service-setting:latest
```

### 4.2 Azure Container Apps デプロイ

#### 認証認可サービス

```bash
az containerapp update \
  --name ca-auth-service \
  --resource-group rg-poc-prod \
  --image <acr-name>.azurecr.io/auth-service:latest \
  --set-env-vars \
    COSMOS_ENDPOINT=<cosmos-endpoint> \
    COSMOS_KEY=<cosmos-key> \
    JWT_SECRET=<jwt-secret>
```

#### テナント管理サービス

```bash
az containerapp update \
  --name ca-tenant-service \
  --resource-group rg-poc-prod \
  --image <acr-name>.azurecr.io/tenant-service:latest \
  --set-env-vars \
    COSMOS_ENDPOINT=<cosmos-endpoint> \
    COSMOS_KEY=<cosmos-key>
```

#### 利用サービス設定サービス

```bash
az containerapp update \
  --name ca-service-setting \
  --resource-group rg-poc-prod \
  --image <acr-name>.azurecr.io/service-setting:latest \
  --set-env-vars \
    COSMOS_ENDPOINT=<cosmos-endpoint> \
    COSMOS_KEY=<cosmos-key>
```

### 4.3 Frontend デプロイ（Azure App Service）

```bash
cd src/front

# 本番ビルド
npm run build

# デプロイ（ZIP Deploy）
az webapp deployment source config-zip \
  --resource-group rg-poc-prod \
  --name app-poc-frontend \
  --src dist.zip
```

または、GitHub Actions を使用（推奨）：

```yaml
# .github/workflows/deploy-frontend.yml
name: Deploy Frontend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: npm run build
      - uses: azure/webapps-deploy@v2
        with:
          app-name: 'app-poc-frontend'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
```

---

## 5. デプロイ後の確認

### 5.1 ヘルスチェック

```bash
# Frontend
curl https://app-poc-frontend.azurewebsites.net/api/health

# 認証認可サービス
curl https://ca-auth-service.azurecontainerapps.io/health

# テナント管理サービス
curl https://ca-tenant-service.azurecontainerapps.io/health

# 利用サービス設定サービス
curl https://ca-service-setting.azurecontainerapps.io/health
```

**期待されるレスポンス**:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "1.0.0"
}
```

### 5.2 機能確認

#### 認証機能

```bash
# ログイン
curl -X POST https://ca-auth-service.azurecontainerapps.io/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'
```

#### テナント管理

```bash
# テナント一覧取得
curl https://ca-tenant-service.azurecontainerapps.io/api/v1/tenants \
  -H "Authorization: Bearer <token>"
```

### 5.3 Application Insights の確認

Azure Portal で Application Insights を開き、以下を確認：
- リクエスト数
- 失敗したリクエスト
- レスポンスタイム
- 例外

---

## 6. ロールバック手順

### 6.1 アプリケーションのロールバック

#### Container Apps

```bash
# リビジョン一覧確認
az containerapp revision list \
  --name ca-auth-service \
  --resource-group rg-poc-prod \
  --output table

# 前のリビジョンに戻す
az containerapp revision activate \
  --name ca-auth-service \
  --resource-group rg-poc-prod \
  --revision <previous-revision-name>
```

#### App Service (Frontend)

```bash
# デプロイメント履歴確認
az webapp deployment list \
  --name app-poc-frontend \
  --resource-group rg-poc-prod

# 前のデプロイメントに戻す
az webapp deployment slot swap \
  --name app-poc-frontend \
  --resource-group rg-poc-prod \
  --slot staging \
  --target-slot production
```

### 6.2 インフラストラクチャのロールバック

```bash
# 前回のデプロイメントを確認
az deployment group list \
  --resource-group rg-poc-prod \
  --output table

# 特定のデプロイメントを再実行
az deployment group create \
  --resource-group rg-poc-prod \
  --template-file main.bicep \
  --parameters @parameters.prod.json \
  --mode Incremental
```

---

## 7. トラブルシューティング

### 7.1 デプロイが失敗する

#### 原因: テンプレートのバリデーションエラー

```bash
# 詳細なエラーメッセージを確認
az deployment group show \
  --resource-group rg-poc-dev \
  --name <deployment-name> \
  --query "properties.error"
```

#### 原因: リソース名の重複

```bash
# リソース名の可用性確認
az <resource-type> check-name \
  --name <resource-name>
```

### 7.2 アプリケーションが起動しない

#### 原因: 環境変数が設定されていない

```bash
# 環境変数確認
az containerapp show \
  --name ca-auth-service \
  --resource-group rg-poc-prod \
  --query "properties.template.containers[0].env"

# 環境変数設定
az containerapp update \
  --name ca-auth-service \
  --resource-group rg-poc-prod \
  --set-env-vars COSMOS_ENDPOINT=<value>
```

#### 原因: イメージのプルエラー

```bash
# Container Registry の認証情報確認
az acr credential show --name <acr-name>

# Container App に認証情報を設定
az containerapp registry set \
  --name ca-auth-service \
  --resource-group rg-poc-prod \
  --server <acr-name>.azurecr.io \
  --username <username> \
  --password <password>
```

### 7.3 データベース接続エラー

```bash
# Cosmos DB の接続文字列確認
az cosmosdb keys list \
  --resource-group rg-poc-prod \
  --name cosmos-poc-prod \
  --type connection-strings

# ファイアウォール設定確認
az cosmosdb show \
  --resource-group rg-poc-prod \
  --name cosmos-poc-prod \
  --query "ipRules"
```

---

## 8. CI/CD パイプライン

### 8.1 GitHub Actions

`.github/workflows/deploy.yml` を作成：

```yaml
name: Deploy to Azure

on:
  push:
    branches:
      - main

env:
  AZURE_RESOURCE_GROUP: rg-poc-prod
  ACR_NAME: acrpocprod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Build and Push Docker Images
        run: |
          az acr login --name ${{ env.ACR_NAME }}
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/auth-service:${{ github.sha }} ./src/auth-service
          docker push ${{ env.ACR_NAME }}.azurecr.io/auth-service:${{ github.sha }}
      
      - name: Deploy to Container Apps
        run: |
          az containerapp update \
            --name ca-auth-service \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/auth-service:${{ github.sha }}
```

### 8.2 デプロイ承認フロー

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app-poc-frontend.azurewebsites.net
    steps:
      # デプロイ処理
```

---

## 9. チェックリスト

### デプロイ前

- [ ] コードレビューが完了している
- [ ] すべてのテストがパスしている
- [ ] 環境変数が正しく設定されている
- [ ] バックアップが取得されている
- [ ] ロールバック手順が準備されている

### デプロイ中

- [ ] デプロイログを監視している
- [ ] エラーが発生していないか確認
- [ ] リソースが正しく作成されているか確認

### デプロイ後

- [ ] ヘルスチェックが成功している
- [ ] 主要機能が正常に動作している
- [ ] Application Insights でメトリクスを確認
- [ ] ログにエラーが出ていないか確認
- [ ] ステークホルダーに完了報告

---

## 更新履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|-------|
| 1.0.0 | 2024 | 初版作成 | Document Updater Agent |
