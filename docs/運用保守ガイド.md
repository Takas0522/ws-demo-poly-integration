# 運用・保守ガイド

## ドキュメント情報

- **バージョン**: 1.0.0
- **最終更新日**: 2024年
- **対象環境**: 開発環境、本番環境

---

## 目次

1. [日常運用](#1-日常運用)
2. [監視とアラート](#2-監視とアラート)
3. [バックアップとリストア](#3-バックアップとリストア)
4. [トラブルシューティング](#4-トラブルシューティング)
5. [パフォーマンスチューニング](#5-パフォーマンスチューニング)
6. [セキュリティ管理](#6-セキュリティ管理)
7. [定期メンテナンス](#7-定期メンテナンス)

---

## 1. 日常運用

### 1.1 サービス状態確認

#### ヘルスチェック

すべてのサービスはヘルスチェックエンドポイントを提供しています：

```bash
# Frontend
curl http://localhost:3000/api/health

# 認証認可サービス
curl http://localhost:8001/health

# テナント管理サービス
curl http://localhost:8002/health

# 利用サービス設定サービス
curl http://localhost:8003/health
```

**期待されるレスポンス**:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T10:30:00Z",
  "version": "1.0.0"
}
```

#### コンテナ状態確認

```bash
# すべてのコンテナの状態確認
docker ps

# 特定サービスのログ確認
docker logs -f <container_name>

# リソース使用状況
docker stats
```

### 1.2 ログの確認

#### Application Insights（本番環境）

Azure Portal から Application Insights にアクセス：

```kusto
// エラーログの確認
traces
| where severityLevel >= 3
| order by timestamp desc
| take 100

// API レスポンスタイム
requests
| summarize avg(duration) by name
| order by avg_duration desc

// 失敗したリクエスト
requests
| where success == false
| order by timestamp desc
```

#### ローカルログ（開発環境）

```bash
# FastAPI ログ
cd src/auth-service
tail -f logs/app.log

# Next.js ログ
cd src/front
npm run dev  # コンソールにログ出力
```

### 1.3 データベース状態確認

#### Cosmos DB メトリクス

Azure Portal で以下を確認：
- **RU 消費量**: データベース > メトリクス > Total Request Units
- **ストレージ使用量**: データベース > メトリクス > Data Usage
- **スロットリング**: データベース > メトリクス > Throttled Requests

```bash
# Azure CLI でメトリクス確認
az cosmosdb show \
  --resource-group rg-poc-prod \
  --name cosmos-poc-prod
```

---

## 2. 監視とアラート

### 2.1 監視対象メトリクス

| メトリクス | 閾値 | アクション |
|----------|------|----------|
| **API レスポンスタイム** | > 3秒 | 調査と最適化 |
| **エラーレート** | > 5% | 即座に調査 |
| **Cosmos DB RU 消費** | > 80% | スケールアップ検討 |
| **CPU 使用率** | > 80% | スケールアップ検討 |
| **メモリ使用率** | > 85% | スケールアップ検討 |
| **ディスク使用率** | > 90% | クリーンアップまたは拡張 |

### 2.2 アラート設定

#### Application Insights アラート

Azure Portal で以下のアラートを設定：

1. **高エラーレート**
   - 条件: Failed requests > 5% in 5 minutes
   - アクション: メール通知

2. **レスポンス遅延**
   - 条件: Average response time > 3 seconds
   - アクション: メール通知

3. **可用性**
   - 条件: Availability < 99%
   - アクション: 緊急通知

```bash
# Azure CLI でアラート作成
az monitor metrics alert create \
  --name "High Error Rate" \
  --resource-group rg-poc-prod \
  --scopes /subscriptions/{subscription}/resourceGroups/{rg}/providers/Microsoft.Insights/components/{app-insights} \
  --condition "avg requests/resultCode |where resultCode >= '400' > 5" \
  --window-size 5m \
  --evaluation-frequency 1m
```

### 2.3 定期チェックリスト

#### 日次チェック

- [ ] すべてのサービスが正常に稼働しているか
- [ ] エラーログに異常がないか
- [ ] Cosmos DB の RU 消費が正常範囲内か
- [ ] ディスク使用率が正常範囲内か

#### 週次チェック

- [ ] Application Insights でパフォーマンストレンドを確認
- [ ] データベースのストレージ使用量を確認
- [ ] セキュリティパッチの適用状況を確認
- [ ] バックアップが正常に実行されているか確認

#### 月次チェック

- [ ] 月次レポートの作成（可用性、パフォーマンス、コスト）
- [ ] インフラコストの確認と最適化検討
- [ ] ログの保管期間確認とアーカイブ
- [ ] セキュリティ監査

---

## 3. バックアップとリストア

### 3.1 Cosmos DB バックアップ

#### 自動バックアップ

Cosmos DB は自動的にバックアップを実行：
- **バックアップ間隔**: 4時間ごと
- **保持期間**: 7日間
- **バックアップタイプ**: フルバックアップ

#### Point-in-Time Restore

Azure Portal から復元：

1. Azure Portal > Cosmos DB アカウント
2. "Point-in-Time Restore" を選択
3. 復元する時刻を指定
4. 新しいアカウント名を指定
5. 復元を実行

```bash
# Azure CLI で復元
az cosmosdb restore \
  --target-database-account-name cosmos-poc-restored \
  --account-name cosmos-poc-prod \
  --resource-group rg-poc-prod \
  --restore-timestamp "2024-01-15T10:00:00Z" \
  --location japaneast
```

### 3.2 アプリケーションコードのバックアップ

#### Git リポジトリ

すべてのコードは Git で管理されています：
- **リポジトリ**: GitHub
- **ブランチ戦略**: main（本番）, develop（開発）
- **タグ**: リリースごとにタグを作成

#### 設定ファイルのバックアップ

機密情報を含む設定ファイルは Azure Key Vault に保管：

```bash
# シークレットのバックアップ
az keyvault secret list --vault-name kv-poc-prod --query "[].name" -o tsv | \
  while read secret; do
    az keyvault secret show --vault-name kv-poc-prod --name $secret > backup/$secret.json
  done
```

### 3.3 復旧手順

#### データベース復旧

1. **復旧ポイントの決定**
   - エラー発生時刻を特定
   - 復旧する時刻を決定（エラー発生前の時刻）

2. **Point-in-Time Restore 実行**
   - 上記の手順で新しいアカウントに復元

3. **接続文字列の更新**
   ```bash
   # アプリケーションの接続文字列を更新
   az webapp config appsettings set \
     --resource-group rg-poc-prod \
     --name app-poc-frontend \
     --settings COSMOS_ENDPOINT=<new_endpoint>
   ```

4. **動作確認**
   - ヘルスチェック実行
   - 基本機能の動作確認

#### アプリケーション復旧

```bash
# 前回のリリースにロールバック
git checkout tags/v1.0.0

# デプロイ
./scripts/deploy.sh production
```

---

## 4. トラブルシューティング

### 4.1 よくある問題と解決策

#### サービスが起動しない

**症状**: サービスのヘルスチェックが失敗する

**原因**:
1. 環境変数が正しく設定されていない
2. 依存サービス（Cosmos DB）に接続できない
3. ポートが既に使用されている

**解決策**:
```bash
# 環境変数を確認
env | grep COSMOS

# Cosmos DB 接続確認
curl -k https://localhost:8081/_explorer/index.html

# ポート使用状況確認
lsof -i :8001

# サービス再起動
docker-compose restart auth-service
```

#### データベース接続エラー

**症状**: `CosmosDB connection failed` エラー

**原因**:
1. Cosmos DB Emulator が起動していない
2. 接続文字列が間違っている
3. ネットワークの問題

**解決策**:
```bash
# Cosmos DB Emulator 起動確認
docker ps | grep cosmos

# Emulator 再起動
docker-compose restart cosmosdb

# 接続テスト
curl -k https://localhost:8081/_explorer/index.html
```

#### 認証エラー

**症状**: `401 Unauthorized` エラー

**原因**:
1. JWT トークンが無効または期限切れ
2. JWT_SECRET が一致していない
3. ユーザーが存在しない

**解決策**:
```bash
# JWT_SECRET 確認
echo $JWT_SECRET

# 新しいトークンを取得
curl -X POST http://localhost:8001/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'

# トークン検証
curl http://localhost:8001/api/v1/auth/verify \
  -H "Authorization: Bearer <token>"
```

#### パフォーマンス劣化

**症状**: APIレスポンスが遅い

**調査手順**:
1. Application Insights でスローなリクエストを特定
2. Cosmos DB の RU 消費を確認
3. サービスのリソース使用率を確認

**対策**:
```bash
# Cosmos DB のメトリクス確認
az cosmosdb show-metrics \
  --resource-group rg-poc-prod \
  --name cosmos-poc-prod

# RU の増加
az cosmosdb update \
  --resource-group rg-poc-prod \
  --name cosmos-poc-prod \
  --default-consistency-level Session \
  --max-throughput 1000
```

### 4.2 エスカレーション手順

#### レベル1: 初期対応（運用チーム）

- ヘルスチェック実施
- ログ確認
- サービス再起動
- 基本的なトラブルシューティング

#### レベル2: 技術対応（開発チーム）

- 詳細なログ分析
- データベースクエリの最適化
- コード修正が必要な問題の対応

#### レベル3: 緊急対応（アーキテクト）

- アーキテクチャレベルの問題
- セキュリティインシデント
- データ損失リスクのある問題

---

## 5. パフォーマンスチューニング

### 5.1 データベース最適化

#### インデックスの最適化

```javascript
// よく使用されるクエリにインデックスを追加
// Cosmos DB Data Explorer で実行
{
  "indexingPolicy": {
    "indexingMode": "consistent",
    "automatic": true,
    "includedPaths": [
      {
        "path": "/tenant_id/*"
      },
      {
        "path": "/created_at/*"
      }
    ],
    "excludedPaths": [
      {
        "path": "/*"
      }
    ]
  }
}
```

#### クエリの最適化

```python
# Bad: すべてのドキュメントをスキャン
items = container.query_items(
    query="SELECT * FROM c WHERE c.tenant_id = @tenant_id",
    parameters=[{"name": "@tenant_id", "value": tenant_id}]
)

# Good: パーティションキーを指定
items = container.query_items(
    query="SELECT * FROM c WHERE c.tenant_id = @tenant_id",
    parameters=[{"name": "@tenant_id", "value": tenant_id}],
    partition_key=tenant_id  # パーティションキー指定
)
```

### 5.2 アプリケーション最適化

#### キャッシュの活用

```typescript
// Next.js の revalidate を使用
export const revalidate = 3600; // 1時間キャッシュ

export async function getTenants() {
  const res = await fetch('http://localhost:8002/api/v1/tenants', {
    next: { revalidate: 3600 }
  });
  return res.json();
}
```

#### 非同期処理の活用

```python
# FastAPI で非同期処理
from fastapi import FastAPI
import asyncio

@app.get("/tenants")
async def get_tenants():
    # 複数のクエリを並列実行
    tenants, users, services = await asyncio.gather(
        get_tenants_from_db(),
        get_users_from_db(),
        get_services_from_db()
    )
    return {
        "tenants": tenants,
        "users": users,
        "services": services
    }
```

---

## 6. セキュリティ管理

### 6.1 アクセス制御

#### Azure RBAC

適切なロールを割り当て：
- **Owner**: インフラ管理者のみ
- **Contributor**: 開発チーム
- **Reader**: 運用チーム

```bash
# ロールの割り当て
az role assignment create \
  --assignee user@example.com \
  --role "Contributor" \
  --resource-group rg-poc-prod
```

#### API 認証

- すべてのAPIエンドポイントで JWT 認証を実施
- トークンの有効期限を適切に設定（推奨: 24時間）
- リフレッシュトークンの実装（将来的な拡張）

### 6.2 機密情報管理

#### Azure Key Vault

機密情報は Azure Key Vault に保管：

```bash
# シークレットの登録
az keyvault secret set \
  --vault-name kv-poc-prod \
  --name "CosmosDBKey" \
  --value "your-cosmos-key"

# アプリケーションからの取得
az keyvault secret show \
  --vault-name kv-poc-prod \
  --name "CosmosDBKey" \
  --query "value" -o tsv
```

### 6.3 セキュリティパッチ

#### 定期的な更新

```bash
# Python パッケージの更新
pip list --outdated
pip install --upgrade <package>

# Node.js パッケージの更新
npm outdated
npm update

# セキュリティ脆弱性のチェック
npm audit
pip-audit
```

---

## 7. 定期メンテナンス

### 7.1 月次メンテナンス

#### タスクリスト

- [ ] **パフォーマンスレビュー**: Application Insights でトレンド分析
- [ ] **コストレビュー**: Azure Cost Management でコスト確認
- [ ] **セキュリティパッチ適用**: 依存パッケージの更新
- [ ] **ログアーカイブ**: 古いログのアーカイブまたは削除
- [ ] **バックアップ検証**: 復元テストの実施
- [ ] **ドキュメント更新**: 変更点の反映

### 7.2 四半期メンテナンス

- [ ] **災害復旧訓練**: DR手順の確認とテスト
- [ ] **セキュリティ監査**: 脆弱性スキャンとペネトレーションテスト
- [ ] **キャパシティプランニング**: リソース使用状況の分析と予測
- [ ] **ドキュメントレビュー**: すべてのドキュメントの見直し

---

## 8. 連絡先

### エスカレーション連絡先

| 役割 | 名前 | 連絡先 | 対応範囲 |
|------|------|--------|---------|
| **L1サポート** | 運用チーム | support@example.com | 基本的なトラブルシューティング |
| **L2サポート** | 開発チーム | dev-team@example.com | コード修正が必要な問題 |
| **L3サポート** | アーキテクト | architect@example.com | アーキテクチャレベルの問題 |

### 緊急連絡先

- **セキュリティインシデント**: security@example.com
- **データ損失リスク**: dba@example.com
- **全体障害**: incident-response@example.com

---

## 更新履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|-------|
| 1.0.0 | 2024 | 初版作成 | Document Updater Agent |
