# 02 — システム要件仕様

## ドキュメント情報

| 項目 | 値 |
|---|---|
| **ドキュメントID** | SPEC-SFM-02 |
| **バージョン** | 1.0.0 |
| **作成日** | 2026-02-19 |
| **ISO 29148 分類** | SyRS (System Requirements Specification) |
| **ステータス** | Draft |

---

## 目次

1. [システム機能要件](#1-システム機能要件)
2. [非機能要件](#2-非機能要件)
3. [インターフェース要件](#3-インターフェース要件)
4. [データ要件](#4-データ要件)
5. [セキュリティ要件](#5-セキュリティ要件)
6. [制約条件](#6-制約条件)
7. [要件トレーサビリティ](#7-要件トレーサビリティ)

---

## 1. システム機能要件

### 1.1 サービス機能マスター管理

#### FR-01: サービス機能マスターの提供

| ID | 要件 | 受け入れ基準 |
|---|---|---|
| FR-01-01 | システムは `ServiceFeature` エンティティを管理する | CosmosDB `services` コンテナに `type: "service_feature"` ドキュメントが存在する |
| FR-01-02 | 各 `ServiceFeature` はただ一つの `Service` に帰属する | `service_id` フィールドが必ず存在し、有効な `Service.id` を参照する |
| FR-01-03 | 一つのサービスに複数の機能を定義できる | 同一 `service_id` で複数の `ServiceFeature` ドキュメントを登録できる |
| FR-01-04 | 各機能はデフォルトの有効/無効状態を持つ | `default_enabled` (bool) フィールドが存在する |
| FR-01-05 | サービス機能マスター一覧を取得できる | `GET /api/v1/services/{service_id}/features` が正常に応答する |

#### FR-02: 全サービスの機能定義

| サービスID | サービス名 | 定義機能数 |
|---|---|---|
| service-001 | テナント管理サービス | 2 |
| service-002 | 認証認可サービス | 3 |
| service-003 | 利用サービス設定サービス | 2 |
| service-004 | ファイル管理サービス | 3 |
| service-005 | メッセージングサービス | 3 |
| service-006 | API利用サービス | 3 |
| service-007 | バックアップサービス | 3 |
| **合計** | | **19機能** |

**機能定義詳細**:

| 機能ID | service_id | feature_key | feature_name | default_enabled |
|---|---|---|---|---|
| feature-001-01 | service-001 | `audit_log` | 監査ログ | true |
| feature-001-02 | service-001 | `auto_backup` | 自動バックアップ | false |
| feature-002-01 | service-002 | `mfa` | 多要素認証 (MFA) | false |
| feature-002-02 | service-002 | `password_policy` | 強化パスワードポリシー | true |
| feature-002-03 | service-002 | `session_audit` | セッション監査 | false |
| feature-003-01 | service-003 | `service_report` | サービス利用レポート | true |
| feature-003-02 | service-003 | `auto_provisioning` | 自動プロビジョニング | false |
| feature-004-01 | service-004 | `version_control` | バージョン管理 | true |
| feature-004-02 | service-004 | `file_sharing` | ファイル外部共有 | false |
| feature-004-03 | service-004 | `auto_backup` | 自動バックアップ | true |
| feature-005-01 | service-005 | `email_notification` | メール通知 | true |
| feature-005-02 | service-005 | `sms_notification` | SMS通知 | false |
| feature-005-03 | service-005 | `push_notification` | プッシュ通知 | false |
| feature-006-01 | service-006 | `usage_analytics` | 利用分析エクスポート | true |
| feature-006-02 | service-006 | `rate_limiting` | レートリミット設定 | true |
| feature-006-03 | service-006 | `api_audit_log` | API監査ログ | false |
| feature-007-01 | service-007 | `incremental_backup` | 増分バックアップ | true |
| feature-007-02 | service-007 | `cross_region_backup` | クロスリージョンバックアップ | false |
| feature-007-03 | service-007 | `auto_schedule` | 自動スケジュール | true |

---

### 1.2 テナント別機能設定

#### FR-03: テナント別機能設定の管理

| ID | 要件 | 受け入れ基準 |
|---|---|---|
| FR-03-01 | テナントに割り当てられたサービスに対してのみ機能設定が可能 | サービス未割り当てのテナントへの機能設定要求は `403 Forbidden` を返す |
| FR-03-02 | テナント別機能設定が未登録の機能は `default_enabled` の値を返す | `TenantServiceFeature` レコードが存在しない場合、`ServiceFeature.default_enabled` をマージした結果を返す |
| FR-03-03 | テナント別機能設定一覧を取得できる | `GET /api/v1/tenants/{tenant_id}/services/{service_id}/features` が正常に応答する |
| FR-03-04 | 機能の有効/無効を更新できる | `PUT /api/v1/tenants/{tenant_id}/services/{service_id}/features/{feature_id}` が正常に応答し、CosmosDB の値が更新される |
| FR-03-05 | 存在しない機能への操作は拒否される | 無効な `feature_id` への PUT は `404 Not Found` を返す |
| FR-03-06 | 更新操作は `updated_by` に操作者のユーザーIDを記録する | JWT ペイロードの `user_id` が `TenantServiceFeature.updated_by` として記録される |

---

### 1.3 認可制御

#### FR-04: 権限制御

| 操作 | 必要ロール | 条件 |
|---|---|---|
| `GET /api/v1/services/{service_id}/features` | 認証済みユーザー | JWT有効であること |
| `GET /api/v1/tenants/{tenant_id}/services/{service_id}/features` | 認証済みユーザー | JWT有効であること。かつ JWT の `tenant_id` クレームとパスパラメーター `tenant_id` が一致すること（テナント間データ分離）。一致しない場合は `403 FORBIDDEN` を返す。実装責務: `service_feature_service.py` サービス層 |
| `PUT /api/v1/tenants/{tenant_id}/services/{service_id}/features/{feature_id}` | `global_admin` または `admin` | 当該サービスまたはシステム全体の管理者ロールを保持していること |

---

### 1.4 フロントエンド表示制御

#### FR-05: 無効機能のUI表示制御

> **対応ステークホルダー要件**: STK-03-01

| ID | 要件 | 優先度 | 受け入れ基準 |
|---|---|---|---|
| FR-05-01 | 無効化されている機能（`is_enabled: false`）はフロントエンドUIでトグルを OFF 状態で表示し、操作可能な `admin` ユーザーにのみ切り替えを許可する | Should | 機能一覧ページで `is_enabled: false` の機能はトグルが OFF 表示になる |
| FR-05-02 | `admin` 未満のロール（`viewer` 等）のユーザーは、全てのトグルが非活性（disabled）で表示されて操作できない | Should | viewer ロールのユーザーから見た機能一覧で全トグルが disabled になる |

---

## 2. 非機能要件

### 2.1 パフォーマンス要件

| ID | 要件 | 目標値 |
|---|---|---|
| NFR-01 | 機能一覧取得 API のレスポンスタイム | 500ms 以内（P95、DevContainer + CosmosDB エミュレーター環境）。PoC 検収基準として採用。本番移行時に再評価する |
| NFR-02 | 機能更新 API のレスポンスタイム | 800ms 以内（P95、DevContainer + CosmosDB エミュレーター環境）。PoC 検収基準として採用。本番移行時に再評価する |
| NFR-03 | 同時リクエスト数 | PoC フェーズにおける管理者ユーザー数を想定し、最大 5 並列リクエスト程度を目安とする。厳密な負荷試験はスコープ外 |

### 2.2 可用性要件

PoCフェーズのため、既存サービスと同等の可用性目標に準ずる。

### 2.3 スケーラビリティ要件

| ID | 要件 |
|---|---|
| NFR-04 | サービス数が増加しても機能一覧取得クエリが効率的に動作する設計とする |
| NFR-05 | テナント数の増加に対してパーティション分散が効果的に機能する設計とする（`tenant_id` をパーティションキーとして使用） |

### 2.4 保守性要件

| ID | 要件 |
|---|---|
| NFR-06 | 既存の三層アーキテクチャ（router → service → repository）に準拠した実装とする |
| NFR-07 | 既存のコーディング規則（モデル/スキーマ分離、非同期クライアント）に準拠する |
| NFR-08 | 新規エンドポイントには既存エンドポイントと同様のエラーハンドリングを実装する |

---

## 3. インターフェース要件

### 3.1 APIインターフェース

新規追加される API エンドポイントは以下の3つ:

| メソッド | パス | 説明 |
|---|---|---|
| GET | `/api/v1/services/{service_id}/features` | サービス機能マスター一覧 |
| GET | `/api/v1/tenants/{tenant_id}/services/{service_id}/features` | テナント別機能設定一覧 |
| PUT | `/api/v1/tenants/{tenant_id}/services/{service_id}/features/{feature_id}` | テナント別機能の有効/無効切り替え |

詳細は [04-API仕様.md](./04-API仕様.md) を参照。

### 3.2 ユーザーインターフェース

サービス設定ページ（`/dashboard/services`）に以下の UI 要素を追加:

| UI要素 | 動作 |
|---|---|
| サービス行の展開ボタン | クリックで当該サービスの機能一覧を表示 |
| 機能一覧テーブル | `feature_name`, `description`, `is_enabled`（現在の状態）を表示 |
| 有効/無効トグル | `admin` 以上のロールを保持するユーザーのみ操作可能 |
| 権限なしユーザーへの表示 | トグルを非活性（disabled）で表示し、読み取り専用 |
| 割り当て済みサービスのみ | テナントに割り当て済みのサービスに対してのみ機能設定セクションを表示 |

### 3.3 BFFインターフェース

フロントエンド（Next.js）から service-setting-service へのプロキシルート:

| ルートファイル | エンドポイント |
|---|---|
| `app/api/services/[id]/features/route.ts` | `GET /api/services/{id}/features` |
| `app/api/tenants/[id]/services/[serviceId]/features/route.ts` | `GET /api/tenants/{id}/services/{serviceId}/features` |
| `app/api/tenants/[id]/services/[serviceId]/features/[featureId]/route.ts` | `PUT /api/tenants/{id}/services/{serviceId}/features/{featureId}` |

---

## 4. データ要件

### 4.1 新規データエンティティ

- **`ServiceFeature`**: サービスに紐づく機能マスター（詳細は [03-データモデル設計.md](./03-データモデル設計.md)）
- **`TenantServiceFeature`**: テナント別の機能有効/無効設定

### 4.2 既存データへの影響

| エンティティ | 変更内容 |
|---|---|
| `Service` | 変更なし |
| `TenantService` | 変更なし |
| `User` | 変更なし |

### 4.3 シードデータ要件

| データ | 件数 | 格納先 |
|---|---|---|
| `ServiceFeature` マスターデータ | 19件 | `scripts/seed_data/initial_data.py` |
| `TenantServiceFeature` サンプルデータ | 各サンプルテナントの割り当てサービス × 全機能（ランダム設定） | `scripts/seed_data/sample_data.py` |

---

## 5. セキュリティ要件

| ID | 要件 |
|---|---|
| SEC-01 | 機能設定の変更操作には `global_admin` または `admin` ロールが必要 |
| SEC-02 | テナントAの機能設定をテナントBのユーザーが閲覧・変更できない（JWT の `tenant_id` でフィルタリング） |
| SEC-03 | テナントに割り当てられていないサービスの機能は設定できない（サービス割り当て確認をサービス層で実施） |
| SEC-04 | `updated_by` フィールドへの記録により操作の追跡可能性を担保する |

---

## 6. 制約条件

| 制約 | 詳細 |
|---|---|
| CosmosDB パーティション設計 | `ServiceFeature` は `services` コンテナに `type: "service_feature"` で同居（新規コンテナ不要） |
| `TenantServiceFeature` の格納先 | `tenant_services` コンテナに `type: "tenant_service_feature"` で同居 |
| サービス機能の動的追加 | PoCフェーズではUIからの機能追加は不可。シードデータまたはDB直接操作で管理 |
| サービス割り当て解除時の挙動 | テナントからサービスを解除しても `TenantServiceFeature` レコードは削除しない（再割り当て時に設定が復元） |
| 非同期クライアント | service-setting-service は既存の async Azure Cosmos Client を使用する |

---

## 7. 要件トレーサビリティ

### 7.1 ステークホルダー要件 → システム機能要件

| StRS ID | SyRS ID | 説明 |
|---|---|---|
| STK-01-01 | FR-01-01 〜 FR-01-05 | ServiceFeature マスター管理 |
| STK-01-02 | FR-03-04 | 機能の有効/無効化 API |
| STK-01-03 | FR-01-04 | デフォルト有効/無効の設定 |
| STK-01-04 | FR-03-01 | 割り当て済みサービスのみ設定可能 |
| STK-02-01 | FR-03-03 | 機能一覧取得 API |
| STK-02-02 | FR-03-02, FR-03-03 | 現在の設定状態の返却 |
| STK-02-03 | FR-03-04 | 機能切り替え API |
| STK-02-04 | SEC-02, FR-04 | テナント間のデータ分離（GET エンドポイントの JWT テナント検証含む） |
| STK-03-01 | FR-05-01, FR-05-02 | 無効機能のUI非表示・非活性表示 |

### 7.2 システム機能要件 → 実装コンポーネント

| SyRS ID | 実装コンポーネント |
|---|---|
| FR-01-xx | `service-setting-service/app/models/service_feature.py`, `repositories/service_feature_repository.py` |
| FR-02-xx | `scripts/seed_data/initial_data.py` |
| FR-03-xx | `service-setting-service/app/services/service_feature_service.py`, `api/v1/services.py` |
| FR-04-xx | `service-setting-service/app/utils/auth.py`（既存の `has_role` 利用）、`service_feature_service.py`（JWT tenant_id 検証） |
| FR-05-xx | `src/front/app/dashboard/services/page.tsx`（トグル disabled 制御） |
| SEC-xx | `service-setting-service/app/services/service_feature_service.py` |

---

## 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|---|---|---|---|
| 1.0.0 | 2026-02-19 | 初版作成 | Copilot |
| 1.0.1 | 2026-02-19 | レビュー指摘対応: 表記誤り修正（1.1見出し中国語）、FR-04 テナント間分離条件の明記、FR-05（UI表示制御）追加、NFR目標値改善、トレーサビリティ更新 | Copilot |
