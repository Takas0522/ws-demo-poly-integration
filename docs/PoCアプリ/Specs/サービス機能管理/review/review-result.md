# レビュー結果: サービス機能管理（サービス特有機能の有効/無効化機能）

## レビュー情報

| 項目 | 値 |
|---|---|
| **機能名** | サービス特有機能の有効/無効化機能 |
| **レビュー日** | 2026-02-19 |
| **判定結果** | CONDITIONAL PASS |
| **レビュー対象ドキュメント** | README.md / 01-概要とビジネス要件.md / 02-システム要件仕様.md / 03-データモデル設計.md / 04-API仕様.md / 05-影響範囲分析.md / 06-検証計画.md |

---

## 判定サマリー

**判定: CONDITIONAL PASS**

全7文書にわたる仕様は ISO/IEC/IEEE 29148:2018 の各分類を網羅しており、実装者が迷わない粒度で詳細な記述がなされている。一方で、CosmosDB コンテナのパーティションキー変更に関する技術的誤謬がデータモデル設計書に存在し、そのまま実装した場合に開発環境でも問題が顕在化する恐れがある。また、文書内に中国語が混入している表記ミス、GET エンドポイントの認可設計に潜在的なセキュリティギャップが確認された。これら3点の修正対応を条件として合格とする。

---

## 観点別評価

### 観点1: ISO/IEC/IEEE 29148 準拠

**評価: WARNING**

| 分類 | 状態 | 備考 |
|---|---|---|
| StRS | OK | 背景・目的・ステークホルダー要件・ユースケース・優先度が明記されている |
| SyRS (機能要件) | OK | FR-01〜FR-04 が受け入れ基準付きで網羅されている |
| SyRS (非機能要件) | WARNING | パフォーマンス目標が「開発環境」限定で、本番・PoC検収基準としての数値が不明確 |
| インターフェース仕様 | OK | API仕様・リクエスト/レスポンス・シーケンス図が詳細に記述されている |
| データモデル | WARNING | マイグレーション説明に技術的誤謬あり（後述） |
| V&V | OK | ユニット・統合・E2E・退行テストの各ケース、受け入れ基準 AC-01〜AC-10 が揃っている |

**問題点:**

- `NFR-01`・`NFR-02` のレスポンスタイム目標に「開発環境」と明記されているが、PoC の受け入れ基準や本番移行時の目安が示されていない。`NFR-03` は「PoCのため特に規定しない」と記載するのみで、想定上限の言及もない。
- `STK-03-01`（テナントユーザーは無効機能を操作できない）は要件優先度が `Should` であるが、対応する SyRS 側の機能要件が存在せず、UI要件のコメントのみで閉じられている。テスト計画（TC-E-04）に対応ケースはあるが、システム要件として明示すべき。

**改善提案:**

- `NFR` に PoC 検収基準（例: 「DevContainer 上の CosmosDB エミュレーター環境で P95 500ms 以内」）と、本番移行時に再評価する旨を明記する。
- `STK-03-01` に対応する `FR-05: 無効機能のUI非表示` を `02-システム要件仕様.md` に追加する。

---

### 観点2: 日本語表現の品質

**評価: NG**

**問題点:**

- **[重大] 中国語文字の混入**: `02-システム要件仕様.md` セクション 1.1 の見出しが「**1.1 服务机能マスター管理**」となっており、「服务」は中国語（簡体字）で日本語「サービス」に相当する。単純な誤記と思われるが、文書の正確性と信頼性を損なう。
- **任意性の曖昧表現**: `05-影響範囲分析.md` セクション 6.3「モックサービスへの影響」の末尾に「各サービスが service-setting-service を参照する仕組みの追加が必要」と記述されているが、これは MUST か将来課題（考慮事項）なのかが不明確。
- **用語表記の揺れ**: `feature_key` の説明として「機械可読キー」と「機能キー」が混在している（03-データモデル設計.md と 05-影響範囲分析.md）。どちらかに統一すること。

**改善提案:**

- `02` の見出しを「**1.1 サービス機能マスター管理**」に修正する。
- `05` の将来考慮事項は「**本番化時の考慮事項（対応必須ではない）**」と明記する。
- 用語集セクションを README.md に追加して用語表記を統一する。

---

### 観点3: 影響範囲の明記

**評価: NG**

**問題点:**

- **[重大] CosmosDB パーティションキー変更の技術的誤謬**: `03-データモデル設計.md` セクション 2.2 の表に「パーティションキー: `/id` → `/partitionKey` に変更」と記載されている。**Azure Cosmos DB (NoSQL API) は既存コンテナのパーティションキーを変更する機能を提供していない**。コンテナを削除・再作成するか、データ移行ツール（Cosmos DB Data Migration Tool など）を用いた新規コンテナへの移行が必須となる。文書では「移行コストは最小限」と記述しているが、開発環境でも初期化スクリプト（`setup_database.sh` 等）の修正と再実行が必要であり、正確な移行手順の記載が欠如している。

- **GET エンドポイントの認可設計の不備**: `02-システム要件仕様.md` の FR-04 によれば、`GET /api/v1/tenants/{tenant_id}/services/{service_id}/features` は「認証済みユーザー（JWT有効）」であれば誰でもアクセス可能とされている。しかし `SEC-02` では「テナントAの機能設定をテナントBのユーザーが閲覧できない」ことが要件となっており、FR-04 の記述と矛盾する。テナント間データ分離の実現方法（JWTの `tenant_id` クレームとパスパラメーターの一致確認など）がサービス層またはルーター層での実装として明記されていない。

- **`scripts/seed_database.py` が影響ファイルとして記載されているが、同ファイルは `scripts/` に実在する**にもかかわらず、追加する挿入ロジックの詳細（呼び出す関数名、挿入先コンテナ名）が記述されていない。

- 影響ファイルとして列挙されている新規作成7ファイルと変更7ファイルは、実際の `src/` ディレクトリ構造と整合しており、既存ファイルの確認は問題なし。

**改善提案:**

- `03-データモデル設計.md` のセクション 2.2 を修正し、パーティションキー変更が CosmosDB の制約上不可能な操作であることを明記する。代替案として以下を検討・記述すること:
  - 案A: `services` コンテナのパーティションキーを `/partitionKey` とする形で初期化スクリプト（`setup_database.sh`）を修正し、開発環境の DB を再初期化する手順を追記する。
  - 案B: `ServiceFeature` 取得クエリに `enable_cross_partition_query=True` を用い、コンテナ定義は変更しない。
- セクション 7（マイグレーション考慮事項）に、開発環境での手順（`setup_database.sh` 修正 → DB 再初期化）を具体的に記述する。
- FR-04 の GET エンドポイントに対して、テナント分離の実装責務（「JWT `tenant_id` クレームとパスパラメーターの一致検証をサービス層で実施する」等）を明記する。

---

### 観点4: ビジネス的な到達目標

**評価: WARNING**

**問題点:**

- `01-概要とビジネス要件.md` の「2.2 KPIへの貢献」は定性的な記述にとどまっており、定量目標が一切示されていない。例えば「テナント解約率の低下」や「管理者作業コストの削減」について、PoC での計測可能な指標が定義されていない。
- 「機能が不要な場合のリスクや機会損失」はセクション 1.3 に「機能が必須とされる理由」として記述されているが、機会損失の金額換算や競合比較など数値的根拠が示されていない。
- 本番移行時（PoCから商用展開）の拡張可能性についてはセクション 6.3（モックサービスへの影響）に「各サービスが service-setting-service を参照する仕組みの追加が必要」と言及されているが、この移行コスト・アーキテクチャ変更の規模は未評価のまま。

**改善提案:**

- KPI の各項目に対して、PoC フェーズで計測・評価する具体的な指標と計測方法を追記する。（例: 「サービス設定に関する問い合わせ件数を計測し、機能追加前後で比較」）
- 商用移行時に必要となる各モックサービスへの機能フラグ対応の概算作業量（ファイル数、エンドポイント数）をセクション 6.3 に追記する。

---

### 観点5: 批判的総合評価

**評価: WARNING**

**問題点:**

- **`services` コンテナへの混在設計の整合性**: `ServiceFeature`（パーティションキー = `service_id`）と既存 `Service`（パーティションキー = `id`）を同一コンテナに格納する設計において、`Service.id` == `ServiceFeature.service_id` の参照整合性はアプリケーション層でのみ担保される。CosmosDB には外部キー制約がないため、存在しない `service_id` を持つ `ServiceFeature` が挿入されても検知できない。`service_id` の有効性確認をリポジトリ層またはサービス層で実施する設計方針の明記が望ましい。

- **サービス割り当て解除時の挙動の不整合リスク**: セクション 6 の制約条件で「サービスを解除しても `TenantServiceFeature` は削除しない」とされている。これ自体は設計判断として妥当だが、長期的にはゾンビレコードが蓄積する可能性がある。将来的なデータクリーニング戦略やレコード有効期限（TTL 活用の検討）への言及が不足している。

- **要件優先度の体系**: ステークホルダー要件では `Must`/`Should` が使用されているが、システム機能要件（FR-xx）には優先度の表記がなく、SyRS として実装優先順位が判断できない。

- **冪等性の明示**: `PUT` エンドポイントは Upsert であり、同一リクエストを複数回送信しても結果が同じとなる（冪等）設計であることが実装コード例から読み取れるが、API仕様書（04）にその旨の明記がない。

**改善提案:**

- `service_feature_service.py` の設計説明に、`ServiceFeature` 登録時の `service_id` 存在確認の有無を明記する。
- データ保持ポリシーに関するセクションをデータモデル設計書に追加する（TTL の活用有無、孤立レコードの管理方針）。
- FR-xx テーブルに `優先度` 列を追加し、Must/Should/May の分類を行う。
- `04-API仕様.md` の PUT エンドポイント説明に「冪等性: 同一リクエストの重複送信は安全（Upsert）」の旨を追記する。

---

## 総合所見

本仕様群は ISO/IEC/IEEE 29148:2018 の構造を忠実に踏まえており、StRS から V&V 計画までの一貫した文書セットとして高完成度である。シーケンス図・ERD・Python コードサンプル・テストケースの擬似コードを豊富に含み、実装者がドキュメントのみで開発に着手できる水準の記述密度を達成している。また、影響範囲分析で「変更不要コンポーネント」を明示している点は退行リスクの管理として特に優れている。

一方、CosmosDB のパーティションキー変更という **PaaS 制約上の実現不可能な操作を前提としたマイグレーション記述** が含まれており、この点は実装フェーズで必ず問題になる。中国語文字の混入という表記ミスとともに、早急な修正が必要である。GET エンドポイントのテナント間データ分離の実装責務も明確化が求められる。

---

## 対応必須事項

CONDITIONAL PASS の条件として、以下の修正対応が必須:

1. **[03-データモデル設計.md] CosmosDB パーティションキー変更の記述修正**: 「`services` コンテナのパーティションキーを `/id` から `/partitionKey` に変更」は CosmosDB の制約上不可能。代替設計（開発環境 DB の再初期化 + `setup_database.sh` 修正、またはクロスパーティションクエリの採用）を採用し、セクション 2.2 とセクション 7 の記述を実現可能な手順に差し替えること。

2. **[02-システム要件仕様.md] セクション 1.1 見出しの中国語修正**: 「1.1 服务机能マスター管理」→「1.1 サービス機能マスター管理」に修正すること。

3. **[02-システム要件仕様.md] FR-04 GET エンドポイントのテナント間分離要件の明記**: `GET /api/v1/tenants/{tenant_id}/services/{service_id}/features` でテナント間データ分離（JWT `tenant_id` クレームとパスパラメーターの一致検証）を誰がどの層で実施するかを明記し、`SEC-02` との整合を取ること。
