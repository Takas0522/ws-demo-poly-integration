# タスク02: インフラ構築（Bicep IaC）

## 概要

Azure リソースを Bicep で定義し、Infrastructure as Code (IaC) として管理できる状態にします。PoC環境として最小コストで構築できる構成を作成します。

## 対象コンポーネント

- Azure Resource Group
- Azure App Service (Frontend)
- Azure Container Apps (Backend Services)
- Azure Cosmos DB
- Azure Container Registry
- Application Insights
- Log Analytics Workspace

## 前提条件

- タスク01（プロジェクト基盤構築）が完了していること
- Azure サブスクリプションへのアクセス権があること
- Azure CLI がインストールされていること

## 実装内容

### 1. Bicep ディレクトリ構造作成

```
infra/
├── main.bicep                      # メインテンプレート
├── modules/
│   ├── app-service.bicep           # App Service
│   ├── container-apps.bicep        # Container Apps
│   ├── cosmos-db.bicep             # Cosmos DB
│   ├── container-registry.bicep    # ACR
│   └── monitoring.bicep            # Application Insights
├── parameters/
│   ├── dev.parameters.json         # 開発環境
│   └── prod.parameters.json        # 本番環境
└── README.md                       # デプロイ手順
```

### 2. main.bicep 実装

Deployment設計ドキュメントの6.2節を参考に、メインテンプレートを実装します。

**追加ポイント**:
- パラメータファイルからの値読み込み
- 出力値の定義（後続のデプロイで使用）
- リソース間の依存関係の明示

### 3. 各モジュールの実装

#### 3.1 monitoring.bicep

```bicep
@description('Location for resources')
param location string

@description('Environment name')
param environmentName string

@description('Resource prefix')
param resourcePrefix string

// Log Analytics Workspace
resource logAnalyticsWorkspace 'Microsoft.OperationalInsights/workspaces@2021-06-01' = {
  name: 'log-${resourcePrefix}-${environmentName}'
  location: location
  properties: {
    sku: {
      name: 'PerGB2018'
    }
    retentionInDays: 30
  }
}

// Application Insights
resource applicationInsights 'Microsoft.Insights/components@2020-02-02' = {
  name: 'appi-${resourcePrefix}-${environmentName}'
  location: location
  kind: 'web'
  properties: {
    Application_Type: 'web'
    WorkspaceResourceId: logAnalyticsWorkspace.id
  }
}

output connectionString string = applicationInsights.properties.ConnectionString
output instrumentationKey string = applicationInsights.properties.InstrumentationKey
output workspaceId string = logAnalyticsWorkspace.id
```

#### 3.2 container-registry.bicep

```bicep
@description('Location for resources')
param location string

@description('Environment name')
param environmentName string

@description('Resource prefix')
param resourcePrefix string

var registryName = replace('acr${resourcePrefix}${environmentName}', '-', '')

resource containerRegistry 'Microsoft.ContainerRegistry/registries@2023-01-01-preview' = {
  name: registryName
  location: location
  sku: {
    name: 'Basic'
  }
  properties: {
    adminUserEnabled: true
  }
}

output loginServer string = containerRegistry.properties.loginServer
output name string = containerRegistry.name
```

#### 3.3 cosmos-db.bicep

Deployment設計ドキュメントの6.3節を参考に実装。

**追加実装**:
- 各データベースの作成
- 各コンテナの作成（パーティションキー設定）
- Serverless 構成（PoCのため）

#### 3.4 container-apps.bicep

**注意点**:
- Log Analytics Workspace への参照追加
- 環境変数でのシークレット管理
- 各サービスのスケール設定（1-3レプリカ）

#### 3.5 app-service.bicep

```bicep
@description('Location for resources')
param location string

@description('Environment name')
param environmentName string

@description('Resource prefix')
param resourcePrefix string

@description('App Insights Connection String')
param appInsightsConnectionString string

@description('Auth Service URL')
param authServiceUrl string

@description('Tenant Service URL')
param tenantServiceUrl string

@description('Service Setting URL')
param serviceSettingUrl string

@secure()
@description('JWT Secret')
param jwtSecret string

// App Service Plan
resource appServicePlan 'Microsoft.Web/serverfarms@2022-03-01' = {
  name: 'plan-${resourcePrefix}-${environmentName}'
  location: location
  sku: {
    name: 'B1'
    tier: 'Basic'
  }
  kind: 'linux'
  properties: {
    reserved: true
  }
}

// App Service
resource appService 'Microsoft.Web/sites@2022-03-01' = {
  name: 'app-${resourcePrefix}-frontend-${environmentName}'
  location: location
  properties: {
    serverFarmId: appServicePlan.id
    siteConfig: {
      linuxFxVersion: 'NODE|18-lts'
      appSettings: [
        {
          name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'
          value: appInsightsConnectionString
        }
        {
          name: 'NEXT_PUBLIC_AUTH_SERVICE_URL'
          value: 'https://${authServiceUrl}'
        }
        {
          name: 'NEXT_PUBLIC_TENANT_SERVICE_URL'
          value: 'https://${tenantServiceUrl}'
        }
        {
          name: 'NEXT_PUBLIC_SERVICE_SETTING_URL'
          value: 'https://${serviceSettingUrl}'
        }
        {
          name: 'JWT_SECRET'
          value: jwtSecret
        }
        {
          name: 'NODE_ENV'
          value: 'production'
        }
      ]
      alwaysOn: true
      http20Enabled: true
      minTlsVersion: '1.2'
      ftpsState: 'Disabled'
    }
    httpsOnly: true
  }
}

output defaultHostname string = appService.properties.defaultHostName
output appServiceId string = appService.id
```

### 4. パラメータファイル作成

**`parameters/dev.parameters.json`**:
```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentName": {
      "value": "dev"
    },
    "location": {
      "value": "japaneast"
    },
    "resourcePrefix": {
      "value": "poly-integration"
    }
  }
}
```

**`parameters/prod.parameters.json`**:
```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentName": {
      "value": "prod"
    },
    "location": {
      "value": "japaneast"
    },
    "resourcePrefix": {
      "value": "poly-integration"
    }
  }
}
```

### 5. デプロイスクリプト作成

**`infra/deploy.sh`**:
```bash
#!/bin/bash

# パラメータ
ENVIRONMENT=${1:-dev}
SUBSCRIPTION_ID=${2}

if [ -z "$SUBSCRIPTION_ID" ]; then
  echo "Usage: ./deploy.sh [environment] [subscription-id]"
  echo "Example: ./deploy.sh dev xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  exit 1
fi

echo "=== Azure リソースデプロイ開始 ==="
echo "Environment: $ENVIRONMENT"
echo "Subscription: $SUBSCRIPTION_ID"

# Azure ログイン確認
az account show > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "Azure にログインしてください"
  az login
fi

# サブスクリプション設定
az account set --subscription $SUBSCRIPTION_ID

# デプロイ実行
echo "Bicep テンプレートをデプロイ中..."
az deployment sub create \
  --location japaneast \
  --template-file main.bicep \
  --parameters parameters/${ENVIRONMENT}.parameters.json \
  --name "poly-integration-${ENVIRONMENT}-$(date +%Y%m%d%H%M%S)"

if [ $? -eq 0 ]; then
  echo "=== デプロイ完了 ==="
  
  # 出力値取得
  echo ""
  echo "=== デプロイ結果 ==="
  az deployment sub show \
    --name "poly-integration-${ENVIRONMENT}-$(date +%Y%m%d%H%M%S)" \
    --query properties.outputs
else
  echo "=== デプロイ失敗 ==="
  exit 1
fi
```

### 6. README.md 作成

**`infra/README.md`**:
```markdown
# インフラストラクチャ

## 概要
Bicep を使用した Azure リソースの定義とデプロイ。

## ディレクトリ構造
- `main.bicep`: メインテンプレート
- `modules/`: 各リソースのモジュール
- `parameters/`: 環境別パラメータファイル

## デプロイ手順

### 前提条件
- Azure CLI インストール済み
- Azure サブスクリプションへのアクセス権

### デプロイ実行

1. Azure にログイン
```bash
az login
```

2. デプロイスクリプト実行
```bash
cd infra
./deploy.sh dev <subscription-id>
```

### 検証のみ（What-If）
```bash
az deployment sub what-if \
  --location japaneast \
  --template-file main.bicep \
  --parameters parameters/dev.parameters.json
```

### 特定モジュールのみデプロイ
```bash
az deployment group create \
  --resource-group rg-poly-integration-dev \
  --template-file modules/cosmos-db.bicep \
  --parameters location=japaneast environmentName=dev resourcePrefix=poly-integration
```

## リソース一覧

| リソース | 名前 | SKU |
|---------|------|-----|
| Resource Group | rg-poly-integration-{env} | - |
| App Service Plan | plan-poly-integration-{env} | B1 |
| App Service | app-poly-integration-frontend-{env} | - |
| Container Apps Env | cae-poly-integration-{env} | Consumption |
| Container Apps | ca-auth-service, ca-tenant-service, ca-service-setting | - |
| Cosmos DB | cosmos-poly-integration-{env} | Serverless |
| Container Registry | acrpolyintegration{env} | Basic |
| Application Insights | appi-poly-integration-{env} | - |
| Log Analytics | log-poly-integration-{env} | PerGB2018 |

## コスト見積もり
開発環境: 約 ¥7,900/月

## トラブルシューティング

### デプロイエラー
- リソース名の重複: 既存のリソースと名前が重複していないか確認
- クォータ超過: サブスクリプションの制限を確認

### 削除方法
```bash
az group delete --name rg-poly-integration-dev --yes
```
```

### 7. Bicep のバリデーション

**検証スクリプト `infra/validate.sh`**:
```bash
#!/bin/bash

echo "=== Bicep テンプレート検証 ==="

# 構文チェック
echo "構文チェック中..."
az bicep build --file main.bicep

if [ $? -eq 0 ]; then
  echo "✓ 構文チェック成功"
else
  echo "✗ 構文チェック失敗"
  exit 1
fi

# What-If 実行
echo ""
echo "What-If 実行中..."
az deployment sub what-if \
  --location japaneast \
  --template-file main.bicep \
  --parameters parameters/dev.parameters.json

echo "=== 検証完了 ==="
```

## 完了条件

- [ ] Bicep ファイルがすべて作成されている
  - [ ] main.bicep
  - [ ] modules/app-service.bicep
  - [ ] modules/container-apps.bicep
  - [ ] modules/cosmos-db.bicep
  - [ ] modules/container-registry.bicep
  - [ ] modules/monitoring.bicep
- [ ] パラメータファイルが作成されている（dev, prod）
- [ ] デプロイスクリプトが作成されている
- [ ] Bicep の構文チェックが成功する
- [ ] What-If でデプロイ内容が確認できる
- [ ] infra/README.md にデプロイ手順が記載されている
- [ ] （オプション）実際に Azure にデプロイして動作確認

## 依存タスク

- タスク01: プロジェクト基盤構築

## 後続タスク

- タスク03: データベース設計・初期構築

## 参照ドキュメント

- [デプロイメント設計](../../arch/deployment.md)
- [アーキテクチャ概要](../../arch/overview.md)
- [Azure Bicep ドキュメント](https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/)

## 注意事項

- **コスト管理**: デプロイ後は不要な場合リソースグループを削除してコストを節約してください
- **命名規則**: Azure のリソース名には制限があります（英数字、ハイフンのみ等）
- **シークレット管理**: JWT_SECRET などは本番環境では Azure Key Vault を使用してください
- **リージョン**: Japan East を使用していますが、必要に応じて変更可能です

## トラブルシューティング

### Bicep ビルドエラー
```bash
az bicep build --file main.bicep
```
でエラー内容を確認してください。

### デプロイタイムアウト
大規模なリソースは作成に時間がかかる場合があります。特に Cosmos DB は5-10分かかることがあります。

### リソース名の重複
既存のリソースと名前が重複する場合、`resourcePrefix` パラメータを変更してください。
