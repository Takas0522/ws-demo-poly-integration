# タスク01: プロジェクト基盤構築

## 概要

開発に必要なプロジェクト基盤を構築します。リポジトリの基本構造、DevContainer環境、共通ツール設定を行い、すべての開発者が統一された環境で開発を開始できる状態にします。

## 対象コンポーネント

- リポジトリ全体
- DevContainer設定
- 各サービスのプロジェクト雛形
  - Next.js (Frontend)
  - Python FastAPI (認証認可サービス)
  - Python FastAPI (テナント管理サービス)
  - Python FastAPI (利用サービス設定サービス)

## 前提条件

- GitHub リポジトリが作成されていること
- Docker Desktop がインストールされていること
- VS Code + Dev Containers 拡張機能がインストールされていること

## 実装内容

### 1. ディレクトリ構造の作成

```
/
├── .devcontainer/          # DevContainer設定
│   ├── devcontainer.json
│   └── Dockerfile
├── .github/
│   └── workflows/          # CI/CD（タスク14で実装）
├── docs/                   # ドキュメント（既存）
├── infra/                  # IaC（タスク02で実装）
├── src/
│   ├── front/              # Next.js フロントエンド
│   ├── auth-service/       # 認証認可サービス
│   ├── tenant-management-service/  # テナント管理サービス
│   └── service-setting-service/    # 利用サービス設定サービス
├── .gitignore
├── README.md
└── docker-compose.yml      # ローカル開発用
```

### 2. DevContainer設定

**`.devcontainer/devcontainer.json`**:
```json
{
  "name": "PoC Multi-Service Development",
  "dockerComposeFile": "../docker-compose.yml",
  "service": "workspace",
  "workspaceFolder": "/workspace",
  "customizations": {
    "vscode": {
      "extensions": [
        "ms-python.python",
        "ms-python.vscode-pylance",
        "ms-azuretools.vscode-bicep",
        "dbaeumer.vscode-eslint",
        "esbenp.prettier-vscode",
        "bradlc.vscode-tailwindcss"
      ],
      "settings": {
        "python.defaultInterpreterPath": "/usr/local/bin/python",
        "python.linting.enabled": true,
        "python.linting.pylintEnabled": true,
        "python.formatting.provider": "black",
        "editor.formatOnSave": true,
        "editor.codeActionsOnSave": {
          "source.organizeImports": true
        }
      }
    }
  },
  "forwardPorts": [3000, 8001, 8002, 8003],
  "postCreateCommand": "bash .devcontainer/post-create.sh"
}
```

**`docker-compose.yml`**:
```yaml
version: '3.8'

services:
  workspace:
    build:
      context: .devcontainer
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached
    command: sleep infinity
    environment:
      - NODE_ENV=development
    networks:
      - poc-network

  # Cosmos DB Emulator (ローカル開発用)
  cosmosdb:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
    ports:
      - "8081:8081"
      - "10251:10251"
      - "10252:10252"
      - "10253:10253"
      - "10254:10254"
    environment:
      - AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10
      - AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE=true
    networks:
      - poc-network

networks:
  poc-network:
    driver: bridge
```

**`.devcontainer/Dockerfile`**:
```dockerfile
FROM mcr.microsoft.com/devcontainers/python:3.11

# Node.js インストール
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Azure CLI インストール
RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

# Python ツールインストール
RUN pip install --upgrade pip \
    && pip install black pylint pytest pytest-asyncio httpx

# 作業ディレクトリ
WORKDIR /workspace
```

### 3. Next.js プロジェクト作成

```bash
cd src
npx create-next-app@latest front --typescript --tailwind --app --no-src-dir
cd front
npm install axios @tanstack/react-query
```

**`src/front/.env.local.example`**:
```bash
NEXT_PUBLIC_AUTH_SERVICE_URL=http://localhost:8001
NEXT_PUBLIC_TENANT_SERVICE_URL=http://localhost:8002
NEXT_PUBLIC_SERVICE_SETTING_URL=http://localhost:8003
JWT_SECRET=your-development-secret-key-change-in-production
```

### 4. FastAPI サービス雛形作成

各サービス（auth-service, tenant-management-service, service-setting-service）に対して同様の構造を作成：

**ディレクトリ構造**:
```
src/auth-service/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── config.py
│   ├── models/
│   ├── schemas/
│   ├── repositories/
│   ├── services/
│   ├── api/
│   │   └── v1/
│   └── utils/
├── tests/
├── requirements.txt
├── Dockerfile
└── .env.example
```

**`src/auth-service/requirements.txt`**:
```txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0
pydantic-settings==2.1.0
azure-cosmos==4.5.1
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
pytest==7.4.3
pytest-asyncio==0.21.1
httpx==0.25.2
```

**`src/auth-service/app/main.py`** (初期バージョン):
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI(
    title="認証認可サービス",
    description="ユーザー認証とロール管理を提供",
    version="1.0.0"
)

# CORS設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "auth-service",
        "version": "1.0.0"
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8001)
```

**`src/auth-service/Dockerfile`**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app/ ./app/

EXPOSE 8001

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8001"]
```

**`.env.example`**:
```bash
SERVICE_NAME=auth-service
PORT=8001
COSMOS_DB_ENDPOINT=https://localhost:8081
COSMOS_DB_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==
COSMOS_DB_DATABASE=auth_management
JWT_SECRET=your-development-secret-key
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24
```

### 5. 共通設定ファイル

**`.gitignore`**:
```gitignore
# Dependencies
node_modules/
__pycache__/
*.pyc
.Python
env/
venv/

# Environment variables
.env
.env.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# Build outputs
dist/
build/
.next/
*.egg-info/

# Tests
.pytest_cache/
coverage/
.coverage

# OS
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Azure
.azure/
```

**`README.md`** (プロジェクトルート):
```markdown
# PoCアプリ - マルチサービス管理システム

## 概要
複数サービスを提供する会社の管理アプリケーションのPoC実装。

## アーキテクチャ
- Frontend: Next.js (TypeScript)
- Backend: Python FastAPI × 3サービス
- Database: Azure Cosmos DB
- Infrastructure: Azure (Bicep)

## 開発環境セットアップ

### 前提条件
- Docker Desktop
- VS Code + Dev Containers 拡張機能

### 起動手順
1. リポジトリをクローン
2. VS Code で開く
3. 「Dev Container で再度開く」を選択
4. コンテナビルド完了後、各サービスを起動

### ローカル起動

**フロントエンド**:
```bash
cd src/front
npm install
npm run dev
```

**バックエンドサービス** (各サービスで実行):
```bash
cd src/auth-service
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8001
```

## ドキュメント
- [アーキテクチャ](docs/arch/overview.md)
- [開発タスク](docs/PoCアプリ/初期構築/開発タスク.md)

## ライセンス
Proprietary
```

### 6. スクリプト作成

**`.devcontainer/post-create.sh`**:
```bash
#!/bin/bash

echo "=== DevContainer セットアップ開始 ==="

# Python 依存関係インストール
echo "Python 依存関係をインストール中..."
for service in auth-service tenant-management-service service-setting-service; do
  if [ -f "/workspace/src/$service/requirements.txt" ]; then
    pip install -r "/workspace/src/$service/requirements.txt"
  fi
done

# Node.js 依存関係インストール
echo "Node.js 依存関係をインストール中..."
if [ -f "/workspace/src/front/package.json" ]; then
  cd /workspace/src/front
  npm install
fi

echo "=== セットアップ完了 ==="
```

## 完了条件

- [ ] ディレクトリ構造が作成されている
- [ ] DevContainer設定が完了し、コンテナが起動する
- [ ] Next.js プロジェクトが作成され、`npm run dev` で起動する
- [ ] 各 FastAPI サービスの雛形が作成され、ヘルスチェックが成功する
  - [ ] auth-service: `http://localhost:8001/health`
  - [ ] tenant-management-service: `http://localhost:8002/health`
  - [ ] service-setting-service: `http://localhost:8003/health`
- [ ] Cosmos DB Emulator がローカルで起動する
- [ ] README.md に起動手順が記載されている
- [ ] .gitignore が適切に設定されている
- [ ] すべてのファイルがGitにコミットされている

## 依存タスク

なし（初期タスク）

## 後続タスク

- タスク02: インフラ構築（Bicep IaC）

## 参照ドキュメント

- [アーキテクチャ概要](../../arch/overview.md)
- [コンポーネント設計](../../arch/components/README.md)
- [デプロイメント設計](../../arch/deployment.md)

## 注意事項

- DevContainer のビルドには5-10分程度かかる場合があります
- Cosmos DB Emulator は初回起動に時間がかかります
- 各サービスのポート番号が重複しないように注意してください
- `.env.example` をコピーして `.env` を作成し、必要に応じて値を変更してください

## トラブルシューティング

### Cosmos DB Emulator に接続できない
- Emulator の起動を確認: `docker ps | grep cosmosdb`
- 証明書エラーの場合: 開発環境では証明書検証を無効化（`ssl_verify=False`）

### ポートが使用中
- 既存のプロセスを終了するか、ポート番号を変更してください

### Node.js 依存関係のエラー
- `node_modules` を削除して再インストール: `rm -rf node_modules && npm install`
