# タスク03: データベース設計・初期構築

## 概要

Cosmos DB のデータベース、コンテナを作成し、初期データ（特権テナント、管理者ユーザー、サービス定義、ロール定義）を投入します。これにより、アプリケーションが動作するための最小限のデータ基盤が整います。

## 対象コンポーネント

- Cosmos DB データベース
  - auth_management
  - tenant_management
  - service_management
- 各コンテナ（users, roles, tenants, services 等）
- シードデータスクリプト

## 前提条件

- タスク02（インフラ構築）が完了していること
- Cosmos DB Emulator（ローカル）または Azure Cosmos DB が利用可能であること
- Python 環境が整っていること

## 実装内容

### 1. Cosmos DB 接続ユーティリティ作成

**`src/shared/cosmos_client.py`** （共通ライブラリ）:
```python
from azure.cosmos import CosmosClient, PartitionKey
from azure.cosmos.exceptions import CosmosResourceExistsError
from typing import Optional
import os

class CosmosDBClient:
    """Cosmos DB 接続クライアント"""
    
    def __init__(
        self,
        endpoint: Optional[str] = None,
        key: Optional[str] = None,
        database_name: Optional[str] = None
    ):
        self.endpoint = endpoint or os.getenv("COSMOS_DB_ENDPOINT")
        self.key = key or os.getenv("COSMOS_DB_KEY")
        self.database_name = database_name or os.getenv("COSMOS_DB_DATABASE")
        
        # SSL検証を開発環境では無効化（Emulator用）
        connection_verify = os.getenv("COSMOS_DB_CONNECTION_VERIFY", "true").lower() == "true"
        
        self.client = CosmosClient(
            self.endpoint,
            self.key,
            connection_verify=connection_verify
        )
        self.database = None
        
    def create_database(self):
        """データベース作成"""
        try:
            self.database = self.client.create_database(self.database_name)
            print(f"✓ Database '{self.database_name}' created")
        except CosmosResourceExistsError:
            self.database = self.client.get_database_client(self.database_name)
            print(f"✓ Database '{self.database_name}' already exists")
    
    def create_container(
        self,
        container_name: str,
        partition_key_path: str
    ):
        """コンテナ作成"""
        try:
            container = self.database.create_container(
                id=container_name,
                partition_key=PartitionKey(path=partition_key_path)
            )
            print(f"✓ Container '{container_name}' created")
            return container
        except CosmosResourceExistsError:
            print(f"✓ Container '{container_name}' already exists")
            return self.database.get_container_client(container_name)
    
    def get_container(self, container_name: str):
        """コンテナ取得"""
        return self.database.get_container_client(container_name)
```

### 2. データベース・コンテナ作成スクリプト

**`scripts/create_database.py`**:
```python
#!/usr/bin/env python3
"""
Cosmos DB データベースとコンテナを作成するスクリプト
"""
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'src'))

from shared.cosmos_client import CosmosDBClient

def create_auth_database():
    """認証認可データベース作成"""
    print("\n=== auth_management データベース作成 ===")
    
    client = CosmosDBClient(database_name="auth_management")
    client.create_database()
    
    # users コンテナ
    client.create_container("users", partition_key_path="/id")
    
    # roles コンテナ
    client.create_container("roles", partition_key_path="/serviceId")
    
    print("✓ auth_management セットアップ完了\n")

def create_tenant_database():
    """テナント管理データベース作成"""
    print("=== tenant_management データベース作成 ===")
    
    client = CosmosDBClient(database_name="tenant_management")
    client.create_database()
    
    # tenants コンテナ
    client.create_container("tenants", partition_key_path="/id")
    
    print("✓ tenant_management セットアップ完了\n")

def create_service_database():
    """サービス設定データベース作成"""
    print("=== service_management データベース作成 ===")
    
    client = CosmosDBClient(database_name="service_management")
    client.create_database()
    
    # services コンテナ
    client.create_container("services", partition_key_path="/id")
    
    print("✓ service_management セットアップ完了\n")

if __name__ == "__main__":
    print("=== Cosmos DB セットアップ開始 ===\n")
    
    try:
        create_auth_database()
        create_tenant_database()
        create_service_database()
        
        print("=== すべてのデータベースセットアップ完了 ===")
    except Exception as e:
        print(f"✗ エラー: {e}")
        sys.exit(1)
```

### 3. シードデータ定義

**`scripts/seed_data/initial_data.py`**:
```python
from datetime import datetime
import uuid
from passlib.hash import bcrypt

def generate_id():
    """UUID生成"""
    return str(uuid.uuid4())

# 特権テナント
PRIVILEGED_TENANT = {
    "id": "privileged-tenant-001",
    "type": "tenant",
    "name": "特権テナント",
    "domains": ["system.local"],
    "isPrivileged": True,
    "createdAt": datetime.utcnow().isoformat() + "Z",
    "partitionKey": "privileged-tenant-001"
}

# システム管理者ユーザー
ADMIN_USER = {
    "id": "admin-user-001",
    "type": "user",
    "userId": "admin@system.local",
    "name": "システム管理者",
    "passwordHash": bcrypt.hash("Admin@12345"),  # 初期パスワード
    "tenantId": "privileged-tenant-001",
    "isActive": True,
    "createdAt": datetime.utcnow().isoformat() + "Z",
    "partitionKey": "admin-user-001"
}

# テナント-ユーザー紐付け
TENANT_USER_RELATION = {
    "id": generate_id(),
    "type": "tenant_user",
    "tenantId": "privileged-tenant-001",
    "userId": "admin-user-001",
    "addedAt": datetime.utcnow().isoformat() + "Z",
    "addedBy": "system",
    "partitionKey": "privileged-tenant-001"
}

# サービス定義
SERVICES = [
    {
        "id": "service-001",
        "type": "service",
        "name": "テナント管理サービス",
        "description": "テナントとテナント所属ユーザーの管理",
        "apiUrl": "http://localhost:8002",
        "roleApiEndpoint": "/api/v1/roles",
        "isActive": True,
        "isMock": False,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-001"
    },
    {
        "id": "service-002",
        "type": "service",
        "name": "認証認可サービス",
        "description": "ユーザー認証とロール管理",
        "apiUrl": "http://localhost:8001",
        "roleApiEndpoint": "/api/v1/roles",
        "isActive": True,
        "isMock": False,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-002"
    },
    {
        "id": "service-003",
        "type": "service",
        "name": "利用サービス設定サービス",
        "description": "テナントへのサービス割り当て管理",
        "apiUrl": "http://localhost:8003",
        "roleApiEndpoint": "/api/v1/roles",
        "isActive": True,
        "isMock": False,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-003"
    },
    {
        "id": "service-004",
        "type": "service",
        "name": "ファイル管理サービス",
        "description": "ファイルのアップロード・管理機能",
        "apiUrl": "http://localhost:3000/api/mock/file-management",
        "roleApiEndpoint": "/roles",
        "isActive": True,
        "isMock": True,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-004"
    },
    {
        "id": "service-005",
        "type": "service",
        "name": "メッセージングサービス",
        "description": "メッセージ送信・管理機能",
        "apiUrl": "http://localhost:3000/api/mock/messaging",
        "roleApiEndpoint": "/roles",
        "isActive": True,
        "isMock": True,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-005"
    },
    {
        "id": "service-006",
        "type": "service",
        "name": "API利用サービス",
        "description": "API利用状況の管理",
        "apiUrl": "http://localhost:3000/api/mock/api-usage",
        "roleApiEndpoint": "/roles",
        "isActive": True,
        "isMock": True,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-006"
    },
    {
        "id": "service-007",
        "type": "service",
        "name": "バックアップサービス",
        "description": "バックアップ・リストア機能",
        "apiUrl": "http://localhost:3000/api/mock/backup",
        "roleApiEndpoint": "/roles",
        "isActive": True,
        "isMock": True,
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-007"
    }
]

# ロール定義
ROLES = [
    # テナント管理サービスのロール
    {
        "id": "role-001",
        "type": "role",
        "serviceId": "service-001",
        "serviceName": "テナント管理サービス",
        "roleCode": "global_admin",
        "roleName": "全体管理者",
        "description": "特権テナントに対する操作が可能",
        "permissions": ["tenant:*"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-001"
    },
    {
        "id": "role-002",
        "type": "role",
        "serviceId": "service-001",
        "serviceName": "テナント管理サービス",
        "roleCode": "admin",
        "roleName": "管理者",
        "description": "通常テナントの追加・削除・編集が可能",
        "permissions": ["tenant:create", "tenant:update", "tenant:delete", "tenant:read"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-001"
    },
    {
        "id": "role-003",
        "type": "role",
        "serviceId": "service-001",
        "serviceName": "テナント管理サービス",
        "roleCode": "viewer",
        "roleName": "閲覧者",
        "description": "テナント情報の参照が可能",
        "permissions": ["tenant:read"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-001"
    },
    # 認証認可サービスのロール
    {
        "id": "role-004",
        "type": "role",
        "serviceId": "service-002",
        "serviceName": "認証認可サービス",
        "roleCode": "global_admin",
        "roleName": "全体管理者",
        "description": "ユーザーの登録・削除が可能",
        "permissions": ["user:*"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-002"
    },
    {
        "id": "role-005",
        "type": "role",
        "serviceId": "service-002",
        "serviceName": "認証認可サービス",
        "roleCode": "viewer",
        "roleName": "閲覧者",
        "description": "ユーザー情報の参照が可能",
        "permissions": ["user:read"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-002"
    },
    # 利用サービス設定サービスのロール
    {
        "id": "role-006",
        "type": "role",
        "serviceId": "service-003",
        "serviceName": "利用サービス設定サービス",
        "roleCode": "global_admin",
        "roleName": "全体管理者",
        "description": "サービス割り当てが可能",
        "permissions": ["service:*"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-003"
    },
    {
        "id": "role-007",
        "type": "role",
        "serviceId": "service-003",
        "serviceName": "利用サービス設定サービス",
        "roleCode": "viewer",
        "roleName": "閲覧者",
        "description": "情報の参照が可能",
        "permissions": ["service:read"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-003"
    },
    # モックサービスのロール（ファイル管理）
    {
        "id": "role-008",
        "type": "role",
        "serviceId": "service-004",
        "serviceName": "ファイル管理サービス",
        "roleCode": "admin",
        "roleName": "管理者",
        "description": "ファイルのアップロード・削除が可能",
        "permissions": ["file:upload", "file:delete", "file:read"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-004"
    },
    {
        "id": "role-009",
        "type": "role",
        "serviceId": "service-004",
        "serviceName": "ファイル管理サービス",
        "roleCode": "user",
        "roleName": "ユーザー",
        "description": "ファイルの閲覧・ダウンロードが可能",
        "permissions": ["file:read", "file:download"],
        "createdAt": datetime.utcnow().isoformat() + "Z",
        "partitionKey": "service-004"
    }
    # 他のモックサービスのロールも同様に定義...
]

# 管理者ユーザーのロール割り当て
ADMIN_USER_ROLES = [
    {
        "id": generate_id(),
        "type": "user_role",
        "userId": "admin-user-001",
        "roleId": "role-001",  # テナント管理 - 全体管理者
        "serviceId": "service-001",
        "assignedAt": datetime.utcnow().isoformat() + "Z",
        "assignedBy": "system",
        "partitionKey": "admin-user-001"
    },
    {
        "id": generate_id(),
        "type": "user_role",
        "userId": "admin-user-001",
        "roleId": "role-004",  # 認証認可 - 全体管理者
        "serviceId": "service-002",
        "assignedAt": datetime.utcnow().isoformat() + "Z",
        "assignedBy": "system",
        "partitionKey": "admin-user-001"
    },
    {
        "id": generate_id(),
        "type": "user_role",
        "userId": "admin-user-001",
        "roleId": "role-006",  # サービス設定 - 全体管理者
        "serviceId": "service-003",
        "assignedAt": datetime.utcnow().isoformat() + "Z",
        "assignedBy": "system",
        "partitionKey": "admin-user-001"
    }
]
```

### 4. シードデータ投入スクリプト

**`scripts/seed_database.py`**:
```python
#!/usr/bin/env python3
"""
初期データを投入するスクリプト
"""
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'src'))

from shared.cosmos_client import CosmosDBClient
from seed_data.initial_data import (
    PRIVILEGED_TENANT,
    ADMIN_USER,
    TENANT_USER_RELATION,
    SERVICES,
    ROLES,
    ADMIN_USER_ROLES
)

def seed_tenant_data():
    """テナントデータ投入"""
    print("\n=== テナントデータ投入 ===")
    
    client = CosmosDBClient(database_name="tenant_management")
    client.create_database()
    container = client.get_container("tenants")
    
    # 特権テナント
    try:
        container.create_item(PRIVILEGED_TENANT)
        print(f"✓ 特権テナント作成: {PRIVILEGED_TENANT['name']}")
    except Exception as e:
        print(f"⚠ 特権テナントは既に存在: {e}")
    
    # テナント-ユーザー紐付け
    try:
        container.create_item(TENANT_USER_RELATION)
        print(f"✓ テナント-ユーザー紐付け作成")
    except Exception as e:
        print(f"⚠ 紐付けは既に存在: {e}")

def seed_user_data():
    """ユーザーデータ投入"""
    print("\n=== ユーザーデータ投入 ===")
    
    client = CosmosDBClient(database_name="auth_management")
    client.create_database()
    container = client.get_container("users")
    
    # 管理者ユーザー
    try:
        container.create_item(ADMIN_USER)
        print(f"✓ 管理者ユーザー作成: {ADMIN_USER['userId']}")
    except Exception as e:
        print(f"⚠ ユーザーは既に存在: {e}")
    
    # ユーザーロール
    for user_role in ADMIN_USER_ROLES:
        try:
            container.create_item(user_role)
            print(f"✓ ユーザーロール割り当て: {user_role['roleId']}")
        except Exception as e:
            print(f"⚠ ロール割り当ては既に存在")

def seed_role_data():
    """ロールデータ投入"""
    print("\n=== ロールデータ投入 ===")
    
    client = CosmosDBClient(database_name="auth_management")
    client.create_database()
    container = client.get_container("roles")
    
    for role in ROLES:
        try:
            container.create_item(role)
            print(f"✓ ロール作成: {role['serviceName']} - {role['roleName']}")
        except Exception as e:
            print(f"⚠ ロールは既に存在: {role['roleName']}")

def seed_service_data():
    """サービスデータ投入"""
    print("\n=== サービスデータ投入 ===")
    
    client = CosmosDBClient(database_name="service_management")
    client.create_database()
    container = client.get_container("services")
    
    for service in SERVICES:
        try:
            container.create_item(service)
            print(f"✓ サービス作成: {service['name']}")
        except Exception as e:
            print(f"⚠ サービスは既に存在: {service['name']}")

if __name__ == "__main__":
    print("=== シードデータ投入開始 ===\n")
    
    try:
        seed_tenant_data()
        seed_user_data()
        seed_role_data()
        seed_service_data()
        
        print("\n=== シードデータ投入完了 ===")
        print("\n初期ログイン情報:")
        print(f"  ユーザーID: {ADMIN_USER['userId']}")
        print(f"  パスワード: Admin@12345")
        
    except Exception as e:
        print(f"\n✗ エラー: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
```

### 5. 実行スクリプト作成

**`scripts/setup_database.sh`**:
```bash
#!/bin/bash

echo "=== データベースセットアップ開始 ==="

# 環境変数設定
export COSMOS_DB_ENDPOINT=${COSMOS_DB_ENDPOINT:-"https://localhost:8081"}
export COSMOS_DB_KEY=${COSMOS_DB_KEY:-"C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="}
export COSMOS_DB_CONNECTION_VERIFY="false"

# 1. データベース・コンテナ作成
echo ""
python3 scripts/create_database.py
if [ $? -ne 0 ]; then
  echo "データベース作成に失敗しました"
  exit 1
fi

# 2. シードデータ投入
echo ""
python3 scripts/seed_database.py
if [ $? -ne 0 ]; then
  echo "シードデータ投入に失敗しました"
  exit 1
fi

echo ""
echo "=== データベースセットアップ完了 ==="
```

### 6. requirements.txt 更新

**`scripts/requirements.txt`**:
```txt
azure-cosmos==4.5.1
passlib[bcrypt]==1.7.4
python-dotenv==1.0.0
```

## 完了条件

- [ ] `src/shared/cosmos_client.py` が作成されている
- [ ] `scripts/create_database.py` が実装されている
- [ ] `scripts/seed_data/initial_data.py` が実装されている
- [ ] `scripts/seed_database.py` が実装されている
- [ ] `scripts/setup_database.sh` が実行可能である
- [ ] ローカルまたはAzure環境でスクリプトを実行し、以下を確認
  - [ ] 3つのデータベースが作成されている
  - [ ] 各コンテナが作成されている
  - [ ] 特権テナントが作成されている
  - [ ] 管理者ユーザーが作成されている
  - [ ] 7つのサービスが登録されている
  - [ ] ロールが正しく登録されている
- [ ] 管理者ユーザーでログイン可能な状態になっている

## 依存タスク

- タスク02: インフラ構築（Bicep IaC）

## 後続タスク

- タスク04: 認証認可サービス実装
- タスク05: テナント管理サービス実装

## 参照ドキュメント

- [データモデル](../../arch/data/data-model.md)
- [アーキテクチャ概要](../../arch/overview.md)

## 注意事項

- **ローカル開発**: Cosmos DB Emulator を使用する場合、SSL検証を無効化してください
- **パスワード**: 初期パスワードは `Admin@12345` です。本番環境では変更してください
- **シークレット管理**: Cosmos DB の接続文字列は環境変数で管理してください

## トラブルシューティング

### Cosmos DB Emulator に接続できない
```bash
docker ps | grep cosmosdb
```
でEmulatorが起動しているか確認してください。

### シードデータが重複エラー
既存のデータがある場合、スクリプトは警告を出して続行します。完全にリセットする場合はコンテナを削除してください。

### パスワードハッシュエラー
`passlib[bcrypt]` がインストールされているか確認してください：
```bash
pip install passlib[bcrypt]
```
