# タスク04: 認証認可サービス実装

## 概要

ユーザー認証、JWT発行・検証、ユーザー管理、ロール管理機能を実装します。本サービスはシステムの認証基盤として機能し、すべてのサービスで利用されます。

## 対象コンポーネント

- 認証認可サービス（Python FastAPI）
  - 認証エンドポイント（ログイン、トークン検証）
  - ユーザー管理エンドポイント（CRUD）
  - ロール管理エンドポイント（取得、割り当て）

## 前提条件

- タスク03（データベース設計・初期構築）が完了していること
- Cosmos DB に初期データが投入されていること
- Python 3.11+ がインストールされていること

## 実装内容

### 1. 設定管理

**`src/auth-service/app/config.py`**:
```python
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # サービス設定
    service_name: str = "auth-service"
    port: int = 8001
    
    # Cosmos DB設定
    cosmos_db_endpoint: str
    cosmos_db_key: str
    cosmos_db_database: str = "auth_management"
    cosmos_db_connection_verify: bool = True
    
    # JWT設定
    jwt_secret: str
    jwt_algorithm: str = "HS256"
    jwt_expiration_hours: int = 24
    
    # CORS設定
    cors_origins: list[str] = ["http://localhost:3000"]
    
    class Config:
        env_file = ".env"
        case_sensitive = False

settings = Settings()
```

### 2. データモデル

**`src/auth-service/app/models/user.py`**:
```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional

class User(BaseModel):
    id: str
    type: str = "user"
    user_id: str = Field(..., alias="userId")
    name: str
    password_hash: str = Field(..., alias="passwordHash")
    tenant_id: str = Field(..., alias="tenantId")
    is_active: bool = Field(True, alias="isActive")
    created_at: datetime = Field(..., alias="createdAt")
    updated_at: Optional[datetime] = Field(None, alias="updatedAt")
    last_login_at: Optional[datetime] = Field(None, alias="lastLoginAt")
    partition_key: str = Field(..., alias="partitionKey")
    
    class Config:
        populate_by_name = True
        json_schema_extra = {
            "example": {
                "id": "user-uuid",
                "userId": "user@example.com",
                "name": "山田太郎",
                "tenantId": "tenant-uuid"
            }
        }

class UserRole(BaseModel):
    id: str
    type: str = "user_role"
    user_id: str = Field(..., alias="userId")
    role_id: str = Field(..., alias="roleId")
    service_id: str = Field(..., alias="serviceId")
    assigned_at: datetime = Field(..., alias="assignedAt")
    assigned_by: str = Field(..., alias="assignedBy")
    partition_key: str = Field(..., alias="partitionKey")
    
    class Config:
        populate_by_name = True
```

**`src/auth-service/app/models/role.py`**:
```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import List

class Role(BaseModel):
    id: str
    type: str = "role"
    service_id: str = Field(..., alias="serviceId")
    service_name: str = Field(..., alias="serviceName")
    role_code: str = Field(..., alias="roleCode")
    role_name: str = Field(..., alias="roleName")
    description: str
    permissions: List[str]
    created_at: datetime = Field(..., alias="createdAt")
    partition_key: str = Field(..., alias="partitionKey")
    
    class Config:
        populate_by_name = True
```

### 3. スキーマ定義

**`src/auth-service/app/schemas/auth.py`**:
```python
from pydantic import BaseModel, Field
from typing import List, Optional

class LoginRequest(BaseModel):
    user_id: str = Field(..., description="ユーザーID")
    password: str = Field(..., description="パスワード")

class TokenResponse(BaseModel):
    access_token: str
    token_type: str = "Bearer"
    expires_in: int
    user: dict

class TokenVerifyRequest(BaseModel):
    token: str

class TokenVerifyResponse(BaseModel):
    valid: bool
    payload: Optional[dict] = None
```

**`src/auth-service/app/schemas/user.py`**:
```python
from pydantic import BaseModel, Field, EmailStr
from typing import Optional
from datetime import datetime

class UserCreate(BaseModel):
    user_id: EmailStr = Field(..., description="ユーザーID（メールアドレス形式）")
    name: str = Field(..., min_length=1, max_length=100)
    password: str = Field(..., min_length=8)
    tenant_id: str = Field(..., description="所属テナントID")

class UserUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=100)
    is_active: Optional[bool] = None

class UserResponse(BaseModel):
    id: str
    user_id: str
    name: str
    tenant_id: str
    is_active: bool
    created_at: datetime
    updated_at: Optional[datetime] = None
    last_login_at: Optional[datetime] = None
```

### 4. ユーティリティ

**`src/auth-service/app/utils/jwt.py`**:
```python
from jose import jwt, JWTError
from datetime import datetime, timedelta
from typing import Dict, Optional
from ..config import settings

def create_jwt_token(payload: Dict) -> str:
    """JWT生成"""
    to_encode = payload.copy()
    expire = datetime.utcnow() + timedelta(hours=settings.jwt_expiration_hours)
    to_encode.update({
        "exp": expire,
        "iat": datetime.utcnow()
    })
    
    encoded_jwt = jwt.encode(
        to_encode,
        settings.jwt_secret,
        algorithm=settings.jwt_algorithm
    )
    return encoded_jwt

def verify_jwt_token(token: str) -> Optional[Dict]:
    """JWT検証"""
    try:
        payload = jwt.decode(
            token,
            settings.jwt_secret,
            algorithms=[settings.jwt_algorithm]
        )
        return payload
    except JWTError:
        return None
```

**`src/auth-service/app/utils/password.py`**:
```python
from passlib.hash import bcrypt

def hash_password(password: str) -> str:
    """パスワードハッシュ化"""
    return bcrypt.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """パスワード検証"""
    return bcrypt.verify(plain_password, hashed_password)
```

**`src/auth-service/app/utils/dependencies.py`**:
```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from typing import Dict
from .jwt import verify_jwt_token

security = HTTPBearer()

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> Dict:
    """現在のユーザー取得"""
    token = credentials.credentials
    payload = verify_jwt_token(token)
    
    if payload is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid or expired token"
        )
    
    return payload

def require_role(required_roles: list[str]):
    """ロール検証デコレータ"""
    async def role_checker(current_user: Dict = Depends(get_current_user)):
        user_roles = [role["role_code"] for role in current_user.get("roles", [])]
        
        if not any(role in user_roles for role in required_roles):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Insufficient permissions"
            )
        
        return current_user
    
    return role_checker
```

### 5. リポジトリ層

**`src/auth-service/app/repositories/user_repository.py`**:
```python
from azure.cosmos import CosmosClient
from typing import Optional, List
from ..models.user import User, UserRole
from ..config import settings

class UserRepository:
    def __init__(self):
        self.client = CosmosClient(
            settings.cosmos_db_endpoint,
            settings.cosmos_db_key,
            connection_verify=settings.cosmos_db_connection_verify
        )
        self.database = self.client.get_database_client(settings.cosmos_db_database)
        self.container = self.database.get_container_client("users")
    
    async def get_by_user_id(self, user_id: str) -> Optional[User]:
        """ユーザーIDでユーザー取得"""
        query = "SELECT * FROM c WHERE c.type = 'user' AND c.userId = @userId"
        parameters = [{"name": "@userId", "value": user_id}]
        
        items = list(self.container.query_items(
            query=query,
            parameters=parameters,
            enable_cross_partition_query=True
        ))
        
        if items:
            return User(**items[0])
        return None
    
    async def get_by_id(self, user_id: str) -> Optional[User]:
        """IDでユーザー取得"""
        try:
            item = self.container.read_item(item=user_id, partition_key=user_id)
            return User(**item)
        except:
            return None
    
    async def create(self, user: User) -> User:
        """ユーザー作成"""
        item = user.model_dump(by_alias=True)
        created_item = self.container.create_item(body=item)
        return User(**created_item)
    
    async def update(self, user: User) -> User:
        """ユーザー更新"""
        item = user.model_dump(by_alias=True)
        updated_item = self.container.upsert_item(body=item)
        return User(**updated_item)
    
    async def delete(self, user_id: str) -> None:
        """ユーザー削除"""
        self.container.delete_item(item=user_id, partition_key=user_id)
    
    async def get_user_roles(self, user_id: str) -> List[UserRole]:
        """ユーザーのロール取得"""
        query = "SELECT * FROM c WHERE c.type = 'user_role' AND c.userId = @userId"
        parameters = [{"name": "@userId", "value": user_id}]
        
        items = list(self.container.query_items(
            query=query,
            parameters=parameters,
            partition_key=user_id
        ))
        
        return [UserRole(**item) for item in items]
    
    async def assign_role(self, user_role: UserRole) -> UserRole:
        """ロール割り当て"""
        item = user_role.model_dump(by_alias=True)
        created_item = self.container.create_item(body=item)
        return UserRole(**created_item)
```

**`src/auth-service/app/repositories/role_repository.py`**:
```python
from azure.cosmos import CosmosClient
from typing import List, Optional
from ..models.role import Role
from ..config import settings

class RoleRepository:
    def __init__(self):
        self.client = CosmosClient(
            settings.cosmos_db_endpoint,
            settings.cosmos_db_key,
            connection_verify=settings.cosmos_db_connection_verify
        )
        self.database = self.client.get_database_client(settings.cosmos_db_database)
        self.container = self.database.get_container_client("roles")
    
    async def get_all(self) -> List[Role]:
        """全ロール取得"""
        query = "SELECT * FROM c WHERE c.type = 'role'"
        items = list(self.container.query_items(
            query=query,
            enable_cross_partition_query=True
        ))
        return [Role(**item) for item in items]
    
    async def get_by_service_id(self, service_id: str) -> List[Role]:
        """サービスIDでロール取得"""
        query = "SELECT * FROM c WHERE c.type = 'role' AND c.serviceId = @serviceId"
        parameters = [{"name": "@serviceId", "value": service_id}]
        
        items = list(self.container.query_items(
            query=query,
            parameters=parameters,
            partition_key=service_id
        ))
        
        return [Role(**item) for item in items]
    
    async def get_by_id(self, role_id: str, service_id: str) -> Optional[Role]:
        """IDでロール取得"""
        try:
            item = self.container.read_item(item=role_id, partition_key=service_id)
            return Role(**item)
        except:
            return None
```

### 6. サービス層

**`src/auth-service/app/services/auth_service.py`**:
```python
from datetime import datetime
from fastapi import HTTPException, status
from ..repositories.user_repository import UserRepository
from ..repositories.role_repository import RoleRepository
from ..utils.password import verify_password
from ..utils.jwt import create_jwt_token
from ..schemas.auth import TokenResponse
from ..config import settings

class AuthService:
    def __init__(self):
        self.user_repo = UserRepository()
        self.role_repo = RoleRepository()
    
    async def login(self, user_id: str, password: str) -> TokenResponse:
        """ログイン処理"""
        # ユーザー検証
        user = await self.user_repo.get_by_user_id(user_id)
        if not user or not verify_password(password, user.password_hash):
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Invalid user_id or password"
            )
        
        # 特権テナント所属チェック
        # TODO: テナント情報を取得して検証
        
        # ロール情報取得
        user_roles = await self.user_repo.get_user_roles(user.id)
        
        # 各ロールの詳細を取得
        roles_detail = []
        for user_role in user_roles:
            role = await self.role_repo.get_by_id(user_role.role_id, user_role.service_id)
            if role:
                roles_detail.append({
                    "service_id": role.service_id,
                    "service_name": role.service_name,
                    "role_code": role.role_code,
                    "role_name": role.role_name
                })
        
        # JWT生成
        token = create_jwt_token({
            "user_id": user.id,
            "tenant_id": user.tenant_id,
            "roles": roles_detail
        })
        
        # 最終ログイン日時更新
        user.last_login_at = datetime.utcnow()
        await self.user_repo.update(user)
        
        return TokenResponse(
            access_token=token,
            expires_in=settings.jwt_expiration_hours * 3600,
            user={
                "id": user.id,
                "user_id": user.user_id,
                "name": user.name,
                "tenant_id": user.tenant_id,
                "roles": roles_detail
            }
        )
```

### 7. APIエンドポイント

**`src/auth-service/app/api/v1/auth.py`**:
```python
from fastapi import APIRouter, HTTPException, Depends
from ...schemas.auth import LoginRequest, TokenResponse, TokenVerifyRequest, TokenVerifyResponse
from ...services.auth_service import AuthService
from ...utils.jwt import verify_jwt_token
from ...utils.dependencies import get_current_user

router = APIRouter(prefix="/auth", tags=["認証"])

@router.post("/login", response_model=TokenResponse)
async def login(request: LoginRequest):
    """ログイン"""
    auth_service = AuthService()
    return await auth_service.login(request.user_id, request.password)

@router.post("/verify", response_model=TokenVerifyResponse)
async def verify_token(request: TokenVerifyRequest):
    """トークン検証"""
    payload = verify_jwt_token(request.token)
    
    if payload is None:
        return TokenVerifyResponse(valid=False)
    
    return TokenVerifyResponse(valid=True, payload=payload)

@router.get("/me")
async def get_current_user_info(current_user: dict = Depends(get_current_user)):
    """現在のユーザー情報取得"""
    return current_user
```

### 8. メインアプリケーション更新

**`src/auth-service/app/main.py`**:
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from .api.v1 import auth, users, roles
from .config import settings

app = FastAPI(
    title="認証認可サービス",
    description="ユーザー認証とロール管理を提供",
    version="1.0.0"
)

# CORS設定
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ルーター登録
app.include_router(auth.router, prefix="/api/v1")
# TODO: users, roles ルーター実装後に追加

@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": settings.service_name,
        "version": "1.0.0"
    }

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=settings.port)
```

### 9. テスト実装

**`src/auth-service/tests/test_auth.py`**:
```python
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.mark.asyncio
async def test_login_success():
    """ログイン成功テスト"""
    async with AsyncClient(app=app, base_url="http://test") as ac:
        response = await ac.post("/api/v1/auth/login", json={
            "user_id": "admin@system.local",
            "password": "Admin@12345"
        })
    
    assert response.status_code == 200
    data = response.json()
    assert "access_token" in data
    assert data["token_type"] == "Bearer"

@pytest.mark.asyncio
async def test_login_failure():
    """ログイン失敗テスト"""
    async with AsyncClient(app=app, base_url="http://test") as ac:
        response = await ac.post("/api/v1/auth/login", json={
            "user_id": "admin@system.local",
            "password": "WrongPassword"
        })
    
    assert response.status_code == 401
```

## 完了条件

- [ ] 設定管理が実装されている
- [ ] データモデル、スキーマが定義されている
- [ ] JWT 生成・検証ユーティリティが実装されている
- [ ] パスワードハッシュ化・検証ユーティリティが実装されている
- [ ] ユーザーリポジトリが実装されている
- [ ] ロールリポジトリが実装されている
- [ ] 認証サービスが実装されている
- [ ] APIエンドポイントが実装されている
  - [ ] POST /api/v1/auth/login
  - [ ] POST /api/v1/auth/verify
  - [ ] GET /api/v1/auth/me
- [ ] 単体テストが実装され、成功する
- [ ] ローカルで起動し、ヘルスチェックが成功する
- [ ] 管理者ユーザーでログインが成功する

## 依存タスク

- タスク03: データベース設計・初期構築

## 後続タスク

- タスク05: テナント管理サービス実装
- タスク07: BFF・認証基盤実装

## 参照ドキュメント

- [API仕様](../../arch/api/api-specification.md)
- [コンポーネント設計](../../arch/components/README.md)
- [データモデル](../../arch/data/data-model.md)

## 注意事項

- JWT秘密鍵は環境変数で管理してください
- パスワードは必ずハッシュ化して保存してください
- 本番環境ではHTTPSを使用してください
