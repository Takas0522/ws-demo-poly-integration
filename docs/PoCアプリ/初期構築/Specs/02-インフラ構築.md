# 機能仕様書: インフラ構築 (Bicep IaC)

## ドキュメント情報

- **バージョン**: 1.0.0
- **作成日**: 2024年
- **ステータス**: Draft
- **タスク番号**: 02
- **関連タスク**: タスク01（プロジェクト基盤構築）
- **後続タスク**: タスク03（データベース設計・初期構築）

---

## 目次

1. [はじめに](#1-はじめに)
2. [ビジネス要件](#2-ビジネス要件)
3. [機能要件](#3-機能要件)
4. [非機能要件](#4-非機能要件)
5. [制約条件](#5-制約条件)
6. [依存関係](#6-依存関係)
7. [エラー処理](#7-エラー処理)
8. [テスト観点](#8-テスト観点)
9. [デリバリー](#9-デリバリー)
10. [受入条件](#10-受入条件)

---

## 1. はじめに

### 1.1 目的

本仕様書は、マルチテナント管理アプリケーションPoCのAzureインフラストラクチャをInfrastructure as Code (IaC) として定義・管理する機能の実装仕様を定めます。Bicepテンプレートを用いてAzureリソースを宣言的に定義し、**再現性**、**バージョン管理**、**コスト最適化**を実現します。

### 1.2 スコープ

本仕様が対象とする範囲は以下の通りです：

**対象**:
- Bicepテンプレートファイルの作成（メインテンプレート、モジュール）
- 環境別パラメータファイルの作成（開発環境、本番環境）
- デプロイスクリプトの作成
- バリデーション機能の実装
- ドキュメント作成（README、デプロイ手順）

**対象外**:
- 実際のAzure環境へのデプロイ実行（オプション）
- アプリケーションコードのデプロイ
- CI/CDパイプラインの構築（将来的な拡張として位置づけ）
- データベースのスキーマ定義（タスク03で実施）

### 1.3 用語定義

| 用語 | 定義 |
|------|------|
| **IaC (Infrastructure as Code)** | インフラストラクチャをコードとして管理する手法 |
| **Bicep** | AzureのIaCを記述するためのドメイン特化言語 |
| **モジュール** | 再利用可能なBicepテンプレートの単位 |
| **パラメータファイル** | 環境ごとの設定値を格納するJSONファイル |
| **What-If** | 実際にデプロイせずに変更内容を確認する機能 |
| **RU (Request Unit)** | Cosmos DBのスループット単位 |
| **Serverless** | 使用量に応じて課金されるCosmos DBの構成モード |
| **SKU** | Azure リソースの価格帯・性能レベル |

---

## 2. ビジネス要件

### 2.1 ビジネス目標

#### 2.1.1 コスト最適化

**目標**: PoCフェーズとして月額¥10,000以下でインフラを構築する

**背景**:
- 本プロジェクトは概念実証（PoC）であり、エンタープライズグレードの高可用性構成は不要
- 限られた予算内で必要最小限の機能を実証する必要がある
- 不必要なリソースやオーバースペックな構成を避ける

**ビジネスインパクト**:
- 投資対効果の最大化
- 予算超過リスクの排除
- ステークホルダーへの説明責任を果たす透明性の高いコスト管理

#### 2.1.2 再現性の確保

**目標**: 環境を何度でも同じ状態で再構築できる仕組みを提供する

**背景**:
- 開発環境の破棄と再作成を低コストで実施
- 本番環境への移行時の構成差異を最小化
- チームメンバー間での環境差異によるトラブルを防止

**ビジネスインパクト**:
- 開発スピードの向上（環境構築時間の短縮）
- 本番環境移行時の失敗リスク低減
- チーム全体の生産性向上

#### 2.1.3 保守性の向上

**目標**: インフラ構成をバージョン管理し、変更履歴を追跡可能にする

**背景**:
- 手作業でのインフラ変更は属人化とミスを招く
- 構成変更の理由や影響範囲を記録する必要がある
- 将来的な拡張や改善を容易にする基盤が必要

**ビジネスインパクト**:
- 運用コストの削減
- 障害発生時の原因特定時間の短縮
- 技術的負債の蓄積防止

#### 2.1.4 迅速なデプロイメント

**目標**: インフラの構築・破棄を30分以内で完了できる

**背景**:
- 開発サイクルの高速化
- 環境検証の効率化
- コスト管理（使用しない環境の即座な削除）

**ビジネスインパクト**:
- 市場投入までの時間短縮
- 開発者の待ち時間削減
- クラウドコストの最適化（使用時のみ課金）

### 2.2 ユーザーストーリー

#### US-01: インフラエンジニアとしての環境構築

```
As a インフラエンジニア
I want Bicepテンプレートを使用してAzure環境を構築したい
So that 手作業でのリソース作成ミスを防ぎ、短時間で環境を準備できる
```

**受入条件**:
- コマンド1つで全リソースがデプロイされる
- デプロイ時間が30分以内である
- エラーが発生した場合、ロールバックが可能である

#### US-02: 開発者としての環境理解

```
As a アプリケーション開発者
I want インフラ構成をコードで確認したい
So that 自分が開発するアプリケーションがどのような環境で動作するか理解できる
```

**受入条件**:
- Bicepファイルを読めばリソース構成が理解できる
- リソース間の依存関係が明示されている
- 環境変数や設定値がパラメータファイルで確認できる

#### US-03: プロジェクトマネージャーとしてのコスト把握

```
As a プロジェクトマネージャー
I want デプロイ前にコスト見積もりを確認したい
So that 予算内でプロジェクトを進行できる
```

**受入条件**:
- READMEに月額コスト見積もりが記載されている
- 使用するSKU/構成が明示されている
- コスト削減のための推奨事項が文書化されている

#### US-04: DevOpsエンジニアとしての変更確認

```
As a DevOpsエンジニア
I want デプロイ前に変更内容を確認したい
So that 本番環境への影響を事前に把握し、安全にデプロイできる
```

**受入条件**:
- What-If機能で変更差分が確認できる
- 構文エラーがビルド時に検出される
- バリデーションスクリプトが提供されている

#### US-05: セキュリティ担当者としての機密情報管理

```
As a セキュリティ担当者
I want データベースの接続文字列やシークレットが安全に管理されることを確認したい
So that 機密情報の漏洩リスクを最小化できる
```

**受入条件**:
- シークレットがBicepテンプレート内にハードコードされていない
- 環境変数またはKey Vault参照が使用されている
- セキュリティに関する注意事項が文書化されている

### 2.3 ビジネス価値の定量化

| 指標 | 従来の手作業 | IaC導入後 | 改善率 |
|------|------------|----------|--------|
| **環境構築時間** | 4時間 | 30分 | **87.5%削減** |
| **構成ミス発生率** | 30% | 5%以下 | **83%削減** |
| **環境破棄・再作成時間** | 2時間 | 10分 | **91.7%削減** |
| **月額インフラコスト** | ¥15,000 | ¥7,900 | **47%削減** |
| **ドキュメント更新時間** | 1時間/回 | 0分（コードがドキュメント） | **100%削減** |

---

## 3. 機能要件

### 3.1 機能概要

Bicepを使用してAzureリソースを定義し、以下のリソースを自動的にプロビジョニングする機能を実装します：

- Resource Group
- Azure App Service（フロントエンド用）
- Azure Container Apps Environment（バックエンドサービス用）
- Azure Container Apps × 3（認証認可、テナント管理、サービス設定）
- Azure Cosmos DB（Serverless構成）
- Azure Container Registry
- Application Insights
- Log Analytics Workspace

### 3.2 機能詳細

#### 3.2.1 ディレクトリ構造の作成

**説明**: Bicepテンプレートを整理されたディレクトリ構造で管理

**ディレクトリ構成**:
```
infra/
├── main.bicep                      # メインテンプレート（エントリーポイント）
├── modules/                        # モジュールディレクトリ
│   ├── monitoring.bicep            # Application Insights & Log Analytics
│   ├── container-registry.bicep    # Azure Container Registry
│   ├── cosmos-db.bicep             # Cosmos DB（DB・コンテナ定義含む）
│   ├── container-apps.bicep        # Container Apps Environment & Apps
│   └── app-service.bicep           # App Service Plan & App Service
├── parameters/                     # 環境別パラメータ
│   ├── dev.parameters.json         # 開発環境用
│   └── prod.parameters.json        # 本番環境用
├── scripts/                        # ユーティリティスクリプト
│   ├── deploy.sh                   # デプロイスクリプト
│   └── validate.sh                 # バリデーションスクリプト
└── README.md                       # ドキュメント
```

**理由**:
- モジュール化により再利用性を高める
- 責務の分離（関心の分離）
- メンテナンス性の向上

#### 3.2.2 メインテンプレート（main.bicep）の実装

**説明**: 全リソースをオーケストレーションするメインテンプレート

**入力**:
- `environmentName`: 環境名（dev/prod）
- `location`: Azureリージョン（japaneast）
- `resourcePrefix`: リソース名のプレフィックス（poly-integration）

**処理**:
1. Resource Groupの作成
2. 各モジュールの呼び出し（依存関係順）
3. 出力値の集約

**出力**:
- `frontendUrl`: フロントエンドのURL
- `containerAppsUrls`: 各バックエンドサービスのURL
- `cosmosDbEndpoint`: Cosmos DBのエンドポイント

**依存関係の順序**:
```
1. Resource Group
   ↓
2. Monitoring（他のリソースが参照する）
   ↓
3. Container Registry（コンテナイメージの保管先）
   ↓
4. Cosmos DB（バックエンドサービスが参照する）
   ↓
5. Container Apps（フロントエンドが参照する）
   ↓
6. App Service（最後にデプロイ）
```

**実装要件**:
- `targetScope = 'subscription'`で開始
- モジュールの`dependsOn`を適切に設定
- 出力値を次のモジュールの入力に接続

#### 3.2.3 Monitoringモジュール（monitoring.bicep）

**説明**: Application InsightsとLog Analytics Workspaceを作成

**入力**:
- `location`: リージョン
- `environmentName`: 環境名
- `resourcePrefix`: リソース名プレフィックス

**処理**:
1. Log Analytics Workspaceの作成
   - SKU: PerGB2018
   - 保持期間: 30日（コスト最適化）
2. Application Insightsの作成
   - 種類: web
   - Log Analytics Workspaceにリンク

**出力**:
- `connectionString`: Application Insights接続文字列
- `instrumentationKey`: 計装キー
- `workspaceId`: Log Analytics WorkspaceのリソースID

**ビジネス価値**:
- アプリケーションの動作状況を可視化
- 問題発生時の迅速な原因特定
- パフォーマンス改善のためのデータ収集

#### 3.2.4 Container Registryモジュール（container-registry.bicep）

**説明**: Dockerイメージを保管するためのプライベートレジストリを作成

**入力**:
- `location`: リージョン
- `environmentName`: 環境名
- `resourcePrefix`: リソース名プレフィックス

**処理**:
1. レジストリ名の生成（ハイフンを除去）
2. Container Registryの作成
   - SKU: Basic（PoCのため最小構成）
   - 管理者ユーザー有効化

**出力**:
- `loginServer`: レジストリのログインサーバー名
- `name`: レジストリ名

**コスト最適化**:
- SKUはBasic（¥600/月）
- Premiumの機能（Geo-replication等）は不要

#### 3.2.5 Cosmos DBモジュール（cosmos-db.bicep）

**説明**: NoSQLデータベースとして3つのデータベース・コンテナを作成

**入力**:
- `location`: リージョン
- `environmentName`: 環境名
- `resourcePrefix`: リソース名プレフィックス

**処理**:
1. Cosmos DB Accountの作成
   - Serverless構成（コスト最適化）
   - 一貫性レベル: Session（パフォーマンスとコストのバランス）
   - 単一リージョン（PoCのため）
2. データベースの作成
   - `auth_management`: 認証認可データ
   - `tenant_management`: テナントデータ
   - `service_management`: サービス設定データ
3. コンテナの作成
   - `users`（パーティションキー: `/id`）
   - `roles`（パーティションキー: `/serviceId`）
   - `tenants`（パーティションキー: `/id`）
   - `services`（パーティションキー: `/id`）

**出力**:
- `endpoint`: Cosmos DBエンドポイントURL
- `primaryKey`: プライマリマスターキー（secureパラメータで受け渡し）

**パーティションキー設計**:
| コンテナ | パーティションキー | 理由 |
|---------|------------------|------|
| users | `/id` | ユーザーIDで高速検索 |
| roles | `/serviceId` | サービス単位でのロール管理 |
| tenants | `/id` | テナントID で高速検索 |
| services | `/id` | サービスIDで高速検索 |

**コスト最適化**:
- Serverless構成により使用量ベースの課金
- PoCの低トラフィックでは月額¥2,000程度

#### 3.2.6 Container Appsモジュール（container-apps.bicep）

**説明**: 3つのバックエンドサービスをホストするコンテナ環境を作成

**入力**:
- `location`: リージョン
- `environmentName`: 環境名
- `resourcePrefix`: リソース名プレフィックス
- `cosmosDbEndpoint`: Cosmos DB接続先
- `cosmosDbKey`: Cosmos DBキー（secure）
- `appInsightsConnectionString`: Application Insights接続文字列
- `containerRegistryServer`: コンテナレジストリのサーバー名

**処理**:
1. Container Apps Environmentの作成
   - Log Analyticsにログを送信
   - Consumption Plan（コスト最適化）
2. 認証認可サービスのContainer App作成
   - ポート: 8001
   - CPU: 0.25 vCPU
   - メモリ: 0.5Gi
   - スケール: 1-3レプリカ
3. テナント管理サービスのContainer App作成
   - ポート: 8002
   - CPU: 0.25 vCPU
   - メモリ: 0.5Gi
   - スケール: 1-3レプリカ
4. サービス設定サービスのContainer App作成
   - ポート: 8003
   - CPU: 0.25 vCPU
   - メモリ: 0.5Gi
   - スケール: 1-3レプリカ

**環境変数設定**:
各Container Appに以下を設定：
- `COSMOS_DB_ENDPOINT`: Cosmos DB URL
- `COSMOS_DB_KEY`: Cosmos DBキー（シークレット参照）
- `COSMOS_DB_DATABASE`: データベース名
- `APPLICATIONINSIGHTS_CONNECTION_STRING`: Application Insights接続文字列
- `PORT`: サービスのポート番号

**出力**:
- `authServiceUrl`: 認証認可サービスのFQDN
- `tenantServiceUrl`: テナント管理サービスのFQDN
- `serviceSettingUrl`: サービス設定サービスのFQDN
- `serviceUrls`: 全サービスURLのオブジェクト

**コスト最適化**:
- Consumption Plan（使用時のみ課金）
- 最小リソース（0.25 vCPU）
- 最小レプリカ数: 1（開発環境）

#### 3.2.7 App Serviceモジュール（app-service.bicep）

**説明**: Next.jsフロントエンドをホストするApp Serviceを作成

**入力**:
- `location`: リージョン
- `environmentName`: 環境名
- `resourcePrefix`: リソース名プレフィックス
- `appInsightsConnectionString`: Application Insights接続文字列
- `authServiceUrl`: 認証認可サービスURL
- `tenantServiceUrl`: テナント管理サービスURL
- `serviceSettingUrl`: サービス設定サービスURL
- `jwtSecret`: JWT署名用シークレット（secure）

**処理**:
1. App Service Planの作成
   - SKU: B1（Basic）
   - OS: Linux
   - Node.js対応
2. App Serviceの作成
   - ランタイム: Node.js 18 LTS
   - HTTPS強制
   - Always On有効
   - HTTP/2有効
   - 最小TLS: 1.2
   - FTPS無効（セキュリティ）

**環境変数設定**:
- `NODE_ENV`: production
- `NEXT_PUBLIC_AUTH_SERVICE_URL`: 認証認可サービスURL
- `NEXT_PUBLIC_TENANT_SERVICE_URL`: テナント管理サービスURL
- `NEXT_PUBLIC_SERVICE_SETTING_URL`: サービス設定サービスURL
- `JWT_SECRET`: JWT署名用シークレット
- `APPLICATIONINSIGHTS_CONNECTION_STRING`: Application Insights接続文字列

**出力**:
- `defaultHostname`: App ServiceのデフォルトURL
- `appServiceId`: App ServiceのリソースID

**コスト最適化**:
- SKU: B1（¥1,800/月）
- 1インスタンス固定（PoCのため）

#### 3.2.8 パラメータファイルの作成

**説明**: 環境ごとの設定値を外部化

**開発環境（dev.parameters.json）**:
```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "environmentName": {
      "value": "dev"
    },
    "location": {
      "value": "japaneast"
    },
    "resourcePrefix": {
      "value": "poly-integration"
    }
  }
}
```

**本番環境（prod.parameters.json）**:
- 基本的にdevと同じ
- `environmentName`を`prod`に変更
- 将来的にSKUを上げる場合はここで調整

**ビジネス価値**:
- 環境ごとの差異を明確化
- 誤った環境へのデプロイを防止
- 環境追加時の拡張性

#### 3.2.9 デプロイスクリプト（deploy.sh）

**説明**: デプロイを自動化するBashスクリプト

**入力**:
- 第1引数: 環境名（dev/prod）
- 第2引数: AzureサブスクリプションID

**処理**:
1. 入力パラメータの検証
2. Azureログイン状態の確認
3. サブスクリプションの設定
4. Bicepテンプレートのデプロイ
5. デプロイ結果の出力

**出力**:
- デプロイ成功/失敗のメッセージ
- デプロイされたリソースのURL

**エラーハンドリング**:
- 引数不足時のUsageメッセージ
- ログインエラー時の再ログイン促進
- デプロイ失敗時のエラーメッセージ

**使用例**:
```bash
cd infra
./scripts/deploy.sh dev xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

#### 3.2.10 バリデーションスクリプト（validate.sh）

**説明**: デプロイ前の検証を自動化

**処理**:
1. Bicep構文チェック（`az bicep build`）
2. What-If実行（実際の変更内容のプレビュー）

**出力**:
- 構文エラーの有無
- デプロイ時の変更差分

**ビジネス価値**:
- 本番環境への誤デプロイ防止
- 変更影響範囲の事前確認
- チームレビューの効率化

**使用例**:
```bash
cd infra
./scripts/validate.sh
```

#### 3.2.11 ドキュメント（README.md）

**説明**: インフラストラクチャのドキュメント

**記載内容**:
1. 概要
2. ディレクトリ構造
3. デプロイ手順
   - 前提条件
   - デプロイコマンド
   - 検証コマンド
4. リソース一覧（名前、SKU）
5. コスト見積もり
6. トラブルシューティング
7. リソース削除方法

**ビジネス価値**:
- 新規メンバーのオンボーディング時間短縮
- トラブル発生時の自己解決率向上
- ドキュメント更新コストの削減

### 3.3 リソース命名規則

すべてのリソースは以下の命名規則に従います：

```
{リソースタイプ略称}-{resourcePrefix}-{サービス名}-{environmentName}
```

**例**:
- Resource Group: `rg-poly-integration-dev`
- App Service: `app-poly-integration-frontend-dev`
- Container App: `ca-auth-service`
- Cosmos DB: `cosmos-poly-integration-dev`
- Container Registry: `acrpolyintegrationdev`（ハイフンなし）

**理由**:
- 一目でリソースの種類と用途がわかる
- 環境の識別が容易
- Azure のベストプラクティスに準拠

---

## 4. 非機能要件

### 4.1 コスト要件

#### 4.1.1 月額コスト上限

**要件**: 開発環境の月額コストを¥10,000以下に抑える

**根拠**:
| リソース | SKU | 月額概算 |
|---------|-----|---------|
| App Service | B1 | ¥1,800 |
| Container Apps | 0.25vCPU×3 | ¥3,000 |
| Cosmos DB | Serverless | ¥2,000 |
| Container Registry | Basic | ¥600 |
| Application Insights | 最小使用 | ¥500 |
| **合計** | | **¥7,900** |

**測定方法**:
- Azure Cost Managementで実績確認
- 月次レポートの作成

**対応策**:
- 使用しない時間帯のリソース停止（開発環境）
- 不要なリソースの即座削除

#### 4.1.2 コスト最適化戦略

**Cosmos DB**:
- Serverless構成（使用時のみ課金）
- 開発環境では夜間・休日のスループット削減

**Container Apps**:
- Consumption Plan（アイドル時は課金なし）
- 最小レプリカ数: 1

**App Service**:
- SKU B1（必要最小限）
- 本番環境への移行時にS1へアップグレード可能

### 4.2 パフォーマンス要件

#### 4.2.1 デプロイ時間

**要件**: 全リソースのデプロイを30分以内に完了

**内訳**:
- Resource Group: 1分
- Monitoring: 3分
- Container Registry: 3分
- Cosmos DB: 10分（最も時間がかかる）
- Container Apps: 8分
- App Service: 5分

**測定方法**:
- デプロイ開始から完了までの時間を計測
- Azure Portal のデプロイメント履歴で確認

#### 4.2.2 リソース作成の並列化

**要件**: 依存関係のないリソースは並列でデプロイ

**実装**:
- Bicepの`dependsOn`で明示的な依存のみ定義
- Azure Resource Managerが自動的に並列デプロイ

### 4.3 可用性要件

#### 4.3.1 PoCとしての位置づけ

**要件**: 高可用性構成は不要（99.9%のSLA不要）

**理由**:
- PoCフェーズでは機能検証が主目的
- コスト優先
- 本番環境では別途HA構成を検討

#### 4.3.2 単一リージョン構成

**要件**: Japan Eastのみ

**理由**:
- マルチリージョン構成はコスト増
- 日本国内アクセスを想定
- ディザスタリカバリは将来の拡張

### 4.4 セキュリティ要件

#### 4.4.1 シークレット管理

**要件**: Bicepテンプレート内にシークレットをハードコードしない

**実装**:
- `@secure()`デコレータの使用
- 環境変数での管理
- 将来的にAzure Key Vault統合

#### 4.4.2 通信の暗号化

**要件**: すべての通信をHTTPS/TLSで暗号化

**実装**:
- App Service: `httpsOnly: true`
- Cosmos DB: TLS 1.2以上
- Container Apps: 内部通信はHTTP（Azureネットワーク内）

#### 4.4.3 最小権限の原則

**要件**: 各リソースに必要最小限の権限のみ付与

**実装**:
- Container Apps: システム割り当てマネージドID
- Container Registry: Admin User有効化（PoCのため）
- 本番環境ではマネージドIDに移行

### 4.5 保守性要件

#### 4.5.1 モジュール化

**要件**: 各リソースを独立したモジュールとして管理

**メリット**:
- 部分的な更新が容易
- テストの容易性
- 再利用性

#### 4.5.2 バージョン管理

**要件**: すべてのBicepファイルをGitで管理

**運用**:
- コミットメッセージで変更理由を記載
- タグでバージョン管理（v1.0.0等）
- プルリクエストでレビュー

#### 4.5.3 ドキュメントの同期

**要件**: コードとドキュメントを常に同期

**実装**:
- README.mdをBicepと同じリポジトリで管理
- コード変更時にREADMEも更新
- What-If結果をPRにコメント

### 4.6 スケーラビリティ要件

#### 4.6.1 将来の拡張性

**要件**: 本番環境へのスケールアップが容易

**実装**:
- SKUをパラメータ化（将来の変更に対応）
- リソース数の追加が容易な設計
- マルチリージョン化の余地

#### 4.6.2 環境の追加

**要件**: staging等の環境追加が10分以内で可能

**実装**:
- パラメータファイルの追加のみ
- 既存のBicepテンプレートを再利用

---

## 5. 制約条件

### 5.1 技術的制約

#### 5.1.1 Azure Bicepの制約

| 制約事項 | 詳細 | 回避策 |
|---------|------|--------|
| **リソース名の一意性** | 一部のリソースはグローバルに一意な名前が必要（Container Registry等） | `resourcePrefix`と`environmentName`の組み合わせで一意性を確保 |
| **ハイフンの制限** | Container Registry名にハイフンは使用不可 | `replace()`関数で除去 |
| **デプロイ順序** | 依存関係を明示する必要がある | `dependsOn`を適切に設定 |
| **Bicep バージョン** | Azure CLI のバージョンに依存 | README に必要バージョンを記載 |

#### 5.1.2 Azure サービスの制約

| リソース | 制約 | 影響 |
|---------|------|------|
| **Cosmos DB Serverless** | 50 GB ストレージ上限 | PoCには十分、本番では Provisioned に移行検討 |
| **Container Apps** | リージョン制限あり | Japan East は対応済み |
| **App Service B1** | 1インスタンス固定 | 負荷分散不可、PoCには十分 |

### 5.2 ビジネス制約

#### 5.2.1 予算制約

**制約**: 月額¥10,000以下

**影響**:
- 高可用性構成は採用不可
- Premium SKUは使用不可
- 複数リージョン展開は不可

**対応**:
- 最小SKUの選択
- Serverless/Consumption構成の採用
- 不要時のリソース削除

#### 5.2.2 期間制約

**制約**: インフラ構築に2営業日以内

**影響**:
- 複雑な構成は採用不可
- シンプルなテンプレート設計

**対応**:
- モジュール化による並行作業
- 既存テンプレートの参照

### 5.3 運用制約

#### 5.3.1 スキルセット

**制約**: チームのBicep経験が限定的

**対応**:
- シンプルな構成
- 詳細なコメント
- 充実したドキュメント

#### 5.3.2 デプロイ権限

**制約**: 特定メンバーのみがAzureデプロイ権限を保有

**影響**:
- デプロイタイミングが制限される

**対応**:
- What-If機能で事前検証
- デプロイスクリプトの自動化

---

## 6. 依存関係

### 6.1 前提タスク

| タスク | 依存内容 | 必須/推奨 |
|-------|---------|----------|
| **タスク01: プロジェクト基盤構築** | ディレクトリ構造の存在 | **必須** |
| **Azureサブスクリプション** | デプロイ先の存在 | **必須** |
| **Azure CLI** | デプロイツール | **必須** |
| **Git** | バージョン管理 | **必須** |

### 6.2 後続タスクへの影響

| タスク | 提供する情報 | 形式 |
|-------|------------|------|
| **タスク03: データベース設計** | Cosmos DB接続情報 | 環境変数 |
| **タスク04-06: 各サービス実装** | サービスURLとエンドポイント | 環境変数 |
| **タスク07: フロントエンド実装** | バックエンドURL | 環境変数 |

### 6.3 外部システムとの依存

| システム | 依存内容 | 確認事項 |
|---------|---------|---------|
| **Azure** | リソース作成権限 | サブスクリプション管理者に確認 |
| **Azure AD** | 認証 | ログイン可能か確認 |
| **GitHub** | コード管理 | リポジトリアクセス権 |

---

## 7. エラー処理

### 7.1 エラーケース一覧

| エラーコード | 条件 | メッセージ | 対応 |
|------------|------|-----------|------|
| **E001** | Bicep構文エラー | "Syntax error in {ファイル名}" | 構文を修正し再実行 |
| **E002** | リソース名重複 | "Resource name already exists" | resourcePrefixを変更 |
| **E003** | サブスクリプション権限不足 | "Insufficient permissions" | 管理者に権限付与を依頼 |
| **E004** | クォータ超過 | "Quota exceeded" | 既存リソースを削除または上限引き上げ申請 |
| **E005** | リージョン未対応 | "Region not supported" | locationパラメータを変更 |
| **E006** | デプロイタイムアウト | "Deployment timeout" | リソースサイズを削減またはリトライ |
| **E007** | 依存関係エラー | "Dependency not found" | dependsOnの設定を確認 |
| **E008** | パラメータ不足 | "Missing required parameter" | パラメータファイルを確認 |

### 7.2 リカバリー戦略

#### 7.2.1 デプロイ失敗時の対応

**手順**:
1. エラーメッセージの確認
2. Azure Portalでデプロイメント履歴を確認
3. 失敗したリソースを特定
4. 原因を修正
5. 再デプロイ

**ロールバック**:
- Bicepは冪等性があるため、修正後の再実行で対応
- 完全削除が必要な場合は Resource Group ごと削除

#### 7.2.2 部分的な再デプロイ

**ケース**: 特定モジュールのみ修正したい場合

**方法**:
```bash
# 特定モジュールのみデプロイ
az deployment group create \
  --resource-group rg-poly-integration-dev \
  --template-file modules/cosmos-db.bicep \
  --parameters location=japaneast environmentName=dev resourcePrefix=poly-integration
```

### 7.3 検証フェーズでのエラー検出

#### 7.3.1 構文チェック

**実行**:
```bash
az bicep build --file main.bicep
```

**検出可能なエラー**:
- 構文エラー
- 未定義変数
- 型の不一致

#### 7.3.2 What-If実行

**実行**:
```bash
az deployment sub what-if \
  --location japaneast \
  --template-file main.bicep \
  --parameters parameters/dev.parameters.json
```

**検出可能なエラー**:
- リソース名の重複
- 権限不足
- クォータ超過
- 依存関係の問題

### 7.4 監視とアラート（将来拡張）

**現時点**: PoCのためアラート設定なし

**本番環境への拡張時**:
- デプロイ失敗時の通知
- コスト超過アラート
- リソース異常検知

---

## 8. テスト観点

### 8.1 構文テスト

**目的**: Bicepテンプレートの構文が正しいことを確認

**方法**:
```bash
cd infra
az bicep build --file main.bicep
```

**合格基準**:
- エラーなしでビルド完了

### 8.2 What-Ifテスト

**目的**: デプロイ内容が想定通りであることを確認

**方法**:
```bash
cd infra
./scripts/validate.sh
```

**確認項目**:
- [ ] 作成されるリソースの数が正しい（9リソース）
- [ ] リソース名が命名規則に従っている
- [ ] SKUが想定通り（B1, Basic, Serverless等）
- [ ] 依存関係が正しい
- [ ] 不要な変更が含まれていない

### 8.3 デプロイテスト（開発環境）

**目的**: 実際にデプロイが成功することを確認

**方法**:
```bash
cd infra
./scripts/deploy.sh dev <subscription-id>
```

**確認項目**:
- [ ] デプロイが30分以内に完了
- [ ] すべてのリソースが作成されている
- [ ] 出力値（URL等）が取得できる
- [ ] Azure Portalでリソースが確認できる

### 8.4 接続テスト

**目的**: 作成されたリソース間の接続が正しいことを確認

**方法**:
1. App ServiceのURLにアクセス（ステータスコード200）
2. Application Insightsでテレメトリが受信されている
3. Cosmos DBに接続できる

**確認項目**:
- [ ] フロントエンドがバックエンドに接続できる
- [ ] バックエンドがCosmos DBに接続できる
- [ ] ログがApplication Insightsに送信されている

### 8.5 削除テスト

**目的**: リソースが正しく削除できることを確認

**方法**:
```bash
az group delete --name rg-poly-integration-dev --yes --no-wait
```

**確認項目**:
- [ ] Resource Groupが削除される
- [ ] 残存リソースがない
- [ ] 削除後の再作成が可能

### 8.6 コストテスト

**目的**: 実際のコストが見積もり内であることを確認

**方法**:
1. 1週間デプロイを継続
2. Azure Cost Managementで実績確認

**合格基準**:
- 月額換算で¥10,000以下

### 8.7 ドキュメントテスト

**目的**: ドキュメントに従って操作できることを確認

**方法**:
1. 新規メンバーにREADMEのみ渡す
2. 指示通りにデプロイできるか確認

**確認項目**:
- [ ] 前提条件が明確
- [ ] コマンドが正確
- [ ] トラブルシューティングが役立つ

---

## 9. デリバリー

### 9.1 成果物

#### 9.1.1 Bicepテンプレートファイル

| ファイル | 行数目安 | 説明 |
|---------|---------|------|
| `infra/main.bicep` | 100-150行 | メインテンプレート |
| `infra/modules/monitoring.bicep` | 50-80行 | 監視リソース |
| `infra/modules/container-registry.bicep` | 30-50行 | コンテナレジストリ |
| `infra/modules/cosmos-db.bicep` | 150-200行 | データベース（コンテナ定義含む） |
| `infra/modules/container-apps.bicep` | 200-300行 | バックエンドサービス |
| `infra/modules/app-service.bicep` | 100-150行 | フロントエンド |

#### 9.1.2 パラメータファイル

| ファイル | 行数 | 説明 |
|---------|------|------|
| `infra/parameters/dev.parameters.json` | 15-20行 | 開発環境パラメータ |
| `infra/parameters/prod.parameters.json` | 15-20行 | 本番環境パラメータ |

#### 9.1.3 スクリプト

| ファイル | 行数目安 | 説明 |
|---------|---------|------|
| `infra/scripts/deploy.sh` | 50-70行 | デプロイ自動化 |
| `infra/scripts/validate.sh` | 30-40行 | バリデーション |

#### 9.1.4 ドキュメント

| ファイル | 行数目安 | 説明 |
|---------|---------|------|
| `infra/README.md` | 200-300行 | インフラドキュメント |

### 9.2 デリバリー形式

**方法**: Gitリポジトリへのプッシュ

**ブランチ戦略**:
1. `feature/infra-setup`ブランチで作業
2. プルリクエストを作成
3. レビュー後に`main`ブランチにマージ

**プルリクエストに含める情報**:
- What-If結果のスクリーンショット
- デプロイテスト結果
- コスト見積もりの確認

### 9.3 レビューポイント

**コードレビュー**:
- [ ] Bicep構文が正しい
- [ ] 命名規則に従っている
- [ ] コメントが適切
- [ ] `@secure()`が適切に使用されている
- [ ] 依存関係が正しい

**アーキテクチャレビュー**:
- [ ] リソース構成が設計通り
- [ ] SKUが適切（コスト最適化）
- [ ] セキュリティ要件を満たしている

**ドキュメントレビュー**:
- [ ] 手順が正確
- [ ] コスト見積もりが妥当
- [ ] トラブルシューティングが充実

---

## 10. 受入条件

### 10.1 機能要件の受入条件

- [ ] **FR-01**: Bicepディレクトリ構造が作成されている
- [ ] **FR-02**: main.bicepが実装され、すべてのモジュールを呼び出している
- [ ] **FR-03**: monitoring.bicepが実装されている
- [ ] **FR-04**: container-registry.bicepが実装されている
- [ ] **FR-05**: cosmos-db.bicepが実装されている（データベース・コンテナ定義含む）
- [ ] **FR-06**: container-apps.bicepが実装されている（3サービス）
- [ ] **FR-07**: app-service.bicepが実装されている
- [ ] **FR-08**: dev.parameters.jsonとprod.parameters.jsonが作成されている
- [ ] **FR-09**: deploy.shスクリプトが実装されている
- [ ] **FR-10**: validate.shスクリプトが実装されている
- [ ] **FR-11**: infra/README.mdが作成されている

### 10.2 非機能要件の受入条件

- [ ] **NFR-01**: Bicep構文チェックが成功する（`az bicep build`）
- [ ] **NFR-02**: What-If実行が成功し、想定通りのリソースが表示される
- [ ] **NFR-03**: 開発環境へのデプロイが30分以内に完了する
- [ ] **NFR-04**: デプロイ後、すべてのリソースがAzure Portalで確認できる
- [ ] **NFR-05**: 月額コスト見積もりが¥10,000以下である
- [ ] **NFR-06**: リソース名が命名規則に従っている
- [ ] **NFR-07**: シークレットがテンプレート内にハードコードされていない

### 10.3 ドキュメントの受入条件

- [ ] **DOC-01**: README.mdにデプロイ手順が記載されている
- [ ] **DOC-02**: README.mdにリソース一覧が記載されている
- [ ] **DOC-03**: README.mdにコスト見積もりが記載されている
- [ ] **DOC-04**: README.mdにトラブルシューティングが記載されている
- [ ] **DOC-05**: Bicepファイルに適切なコメントが記載されている

### 10.4 テストの受入条件

- [ ] **TEST-01**: 構文テストが成功する
- [ ] **TEST-02**: What-Ifテストで問題が検出されない
- [ ] **TEST-03**: デプロイテストが成功する
- [ ] **TEST-04**: 接続テストが成功する（リソース間の疎通確認）
- [ ] **TEST-05**: 削除テストが成功する（Resource Group削除）
- [ ] **TEST-06**: ドキュメントテストが成功する（第三者が手順通りに実行可能）

### 10.5 ビジネス要件の受入条件

- [ ] **BIZ-01**: 月額コストが¥10,000以下である（実測値）
- [ ] **BIZ-02**: 環境の再作成が30分以内で完了する
- [ ] **BIZ-03**: すべてのファイルがGitで管理されている
- [ ] **BIZ-04**: 新規メンバーがドキュメントのみでデプロイできる

### 10.6 最終承認基準

**承認者**: プロジェクトマネージャー、インフラエンジニア

**承認条件**:
- すべての受入条件（FR, NFR, DOC, TEST, BIZ）が満たされている
- コードレビューが完了している
- デプロイテストが成功している
- コスト見積もりが承認されている

**承認方法**:
- プルリクエストのApprove
- マイルストーン「タスク02完了」のクローズ

---

## 付録A: 参照ドキュメント

| ドキュメント | パス | 目的 |
|------------|------|------|
| **サービス概要** | `/docs/init.md` | ビジネス要件の理解 |
| **アーキテクチャ概要** | `/docs/arch/overview.md` | システム全体像の把握 |
| **デプロイメント設計** | `/docs/arch/deployment.md` | インフラ構成の詳細 |
| **タスクドキュメント** | `/docs/PoCアプリ/初期構築/02-インフラ構築.md` | 実装詳細 |
| **Azure Bicep公式ドキュメント** | https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/bicep/ | Bicep構文リファレンス |

---

## 付録B: コスト最適化のベストプラクティス

### B.1 開発環境でのコスト削減

1. **不使用時のリソース停止**
   ```bash
   # App Serviceの停止
   az webapp stop --name app-poly-integration-frontend-dev --resource-group rg-poly-integration-dev
   
   # Container Appsのスケールダウン
   az containerapp update --name ca-auth-service --resource-group rg-poly-integration-dev --min-replicas 0
   ```

2. **定期的なリソース削除**
   - 開発終了後はResource Groupごと削除
   - 必要時に再デプロイ（30分）

3. **Cosmos DBのスループット調整**
   - Serverless構成により自動的に最適化
   - 未使用時は課金なし

### B.2 本番環境への移行時の考慮事項

| 項目 | PoC | 本番 |
|------|-----|------|
| **App Service** | B1 | S1以上 |
| **Container Apps** | 0.25vCPU | 0.5vCPU以上 |
| **Cosmos DB** | Serverless | Provisioned（予測可能なコスト） |
| **マルチリージョン** | 単一 | 検討 |
| **バックアップ** | なし | 自動バックアップ有効化 |

---

## 付録C: トラブルシューティングQ&A

### Q1: デプロイが失敗する

**A**: 
1. エラーメッセージを確認
2. What-If実行で事前検証
3. Azure Portalのデプロイメント履歴を確認
4. 本仕様書の「7. エラー処理」セクションを参照

### Q2: コストが見積もりより高い

**A**:
1. Azure Cost Managementで内訳確認
2. 不要なリソースがないか確認
3. Container Appsのレプリカ数を確認
4. 使用していない環境を削除

### Q3: リソース名が重複している

**A**:
- `resourcePrefix`パラメータを変更
- 既存リソースを削除してから再デプロイ

### Q4: Container Appsにイメージがデプロイできない

**A**:
- Container Registryにイメージがpushされているか確認
- マネージドIDの権限を確認
- イメージタグが正しいか確認

---

## 付録D: 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|-------|
| 1.0.0 | 2024 | 初版作成 | Spec Writer Agent |

---

## 付録E: 用語集（再掲）

| 用語 | 説明 |
|------|------|
| **Bicep** | AzureのIaCを記述するためのドメイン特化言語 |
| **What-If** | 実際にデプロイせずに変更内容を確認する機能 |
| **RU (Request Unit)** | Cosmos DBのスループット単位 |
| **Serverless** | 使用量に応じて課金されるCosmos DBの構成モード |
| **SKU** | Azure リソースの価格帯・性能レベル |
| **マネージドID** | Azureリソースに自動的に割り当てられる認証ID |
| **PoC (Proof of Concept)** | 概念実証 |

---

**本仕様書の承認により、タスク02「インフラ構築」の実装を開始できます。**
