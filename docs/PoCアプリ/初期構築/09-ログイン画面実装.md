# タスク09: ログイン画面実装

## 概要

ユーザーがシステムにログインするための画面を実装します。ID/パスワード入力フォーム、バリデーション、エラー表示、ログイン後のリダイレクトを含みます。

## 対象コンポーネント

- ログインページ (`/login`)
- ログインフォームコンポーネント
- 認証フック

## 前提条件

- タスク07（BFF・認証基盤実装）が完了していること
- タスク08（フロントエンド共通コンポーネント）が完了していること

## 実装内容

### 1. ログインページ

**`src/front/app/login/page.tsx`**:
```typescript
import { LoginForm } from '@/components/features/auth/LoginForm';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow-md">
        <div>
          <h2 className="text-center text-3xl font-extrabold text-gray-900">
            PoC管理システム
          </h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            ログインしてください
          </p>
        </div>
        <LoginForm />
      </div>
    </div>
  );
}
```

### 2. ログインフォームコンポーネント

**`src/front/components/features/auth/LoginForm.tsx`**:
```typescript
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Alert } from '@/components/ui/Alert';

interface LoginFormData {
  user_id: string;
  password: string;
}

export function LoginForm() {
  const router = useRouter();
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<LoginFormData>();

  const onSubmit = async (data: LoginFormData) => {
    setLoading(true);
    setError(null);

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ログインに失敗しました');
      }

      // ログイン成功 - ダッシュボードにリダイレクト
      router.push('/dashboard');
      router.refresh();
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="mt-8 space-y-6">
      {error && (
        <Alert variant="error">
          {error}
        </Alert>
      )}
      
      <div className="space-y-4">
        <Input
          label="ユーザーID"
          type="email"
          placeholder="user@example.com"
          error={errors.user_id?.message}
          {...register('user_id', {
            required: 'ユーザーIDを入力してください',
            pattern: {
              value: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,
              message: '有効なメールアドレスを入力してください',
            },
          })}
        />

        <Input
          label="パスワード"
          type="password"
          placeholder="パスワード"
          error={errors.password?.message}
          {...register('password', {
            required: 'パスワードを入力してください',
            minLength: {
              value: 8,
              message: 'パスワードは8文字以上である必要があります',
            },
          })}
        />
      </div>

      <Button
        type="submit"
        variant="primary"
        fullWidth
        loading={loading}
      >
        ログイン
      </Button>

      <div className="text-sm text-gray-600 mt-4">
        <p>デモ用アカウント:</p>
        <p>ID: admin@system.local</p>
        <p>パスワード: Admin@12345</p>
      </div>
    </form>
  );
}
```

### 3. 認証フック

**`src/front/hooks/useAuth.ts`**:
```typescript
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';

interface User {
  user_id: string;
  tenant_id: string;
  roles: Array<{
    service_id: string;
    service_name: string;
    role_code: string;
    role_name: string;
  }>;
}

export function useAuth() {
  const router = useRouter();
  const queryClient = useQueryClient();

  const { data: user, isLoading } = useQuery<User>({
    queryKey: ['currentUser'],
    queryFn: async () => {
      const response = await fetch('/api/auth/me');
      if (!response.ok) {
        throw new Error('Not authenticated');
      }
      return response.json();
    },
    retry: false,
  });

  const loginMutation = useMutation({
    mutationFn: async (credentials: { user_id: string; password: string }) => {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credentials),
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Login failed');
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['currentUser'] });
      router.push('/dashboard');
    },
  });

  const logoutMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch('/api/auth/logout', {
        method: 'POST',
      });

      if (!response.ok) {
        throw new Error('Logout failed');
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.setQueryData(['currentUser'], null);
      router.push('/login');
    },
  });

  const hasRole = (roleCodes: string[]): boolean => {
    if (!user) return false;
    return user.roles.some(role => roleCodes.includes(role.role_code));
  };

  return {
    user,
    isLoading,
    isAuthenticated: !!user,
    login: loginMutation.mutate,
    logout: logoutMutation.mutate,
    hasRole,
  };
}
```

### 4. ダッシュボードページ（リダイレクト先）

**`src/front/app/dashboard/page.tsx`**:
```typescript
'use client';

import { useAuth } from '@/hooks/useAuth';
import { MainLayout } from '@/components/layouts/MainLayout';

export default function DashboardPage() {
  const { user } = useAuth();

  return (
    <MainLayout>
      <div className="p-8">
        <h1 className="text-3xl font-bold mb-4">ダッシュボード</h1>
        <div className="bg-white rounded-lg shadow p-6">
          <h2 className="text-xl font-semibold mb-4">
            ようこそ、{user?.user_id} さん
          </h2>
          <div className="space-y-2">
            <p>テナントID: {user?.tenant_id}</p>
            <p>ロール:</p>
            <ul className="list-disc list-inside ml-4">
              {user?.roles.map((role, index) => (
                <li key={index}>
                  {role.service_name}: {role.role_name}
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>
    </MainLayout>
  );
}
```

### 5. ログインページのルーティング除外

**`src/front/middleware.ts`** (更新):
```typescript
// 認証不要なパス
const publicPaths = ['/login', '/api/auth/login'];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;
  
  // ログインページは認証済みの場合ダッシュボードにリダイレクト
  if (pathname === '/login') {
    const token = request.cookies.get('auth_token')?.value;
    if (token) {
      const payload = await verifyToken(token);
      if (payload) {
        return NextResponse.redirect(new URL('/dashboard', request.url));
      }
    }
  }
  
  // 公開パスは認証不要
  if (publicPaths.some(path => pathname.startsWith(path))) {
    return NextResponse.next();
  }
  
  // ... 既存の認証チェック
}
```

## 完了条件

- [ ] ログインページが実装されている
- [ ] ログインフォームが実装されている
- [ ] バリデーションが動作する
- [ ] エラー表示が実装されている
- [ ] ログイン成功時にダッシュボードにリダイレクトされる
- [ ] ログイン済みの場合、ログインページにアクセスするとダッシュボードにリダイレクトされる
- [ ] 認証フックが実装されている
- [ ] デモアカウントでログインが成功する

## 依存タスク

- タスク07: BFF・認証基盤実装
- タスク08: フロントエンド共通コンポーネント

## 後続タスク

- タスク10: テナント管理画面実装

## 参照ドキュメント

- [コンポーネント設計](../../arch/components/README.md)
- [API仕様](../../arch/api/api-specification.md)

## 注意事項

- パスワードは平文で送信されるため、本番環境ではHTTPSを使用してください
- デモ用のアカウント情報は開発環境でのみ表示してください
