services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: mcr.microsoft.com/devcontainers/python:1-3.11-bookworm
    init: true
    command: sleep infinity
    depends_on:
      - cosmosdb
    volumes:
      # Forwards the local Docker socket to the container.
      - /var/run/docker.sock:/var/run/docker-host.sock
      # Update this to wherever you want VS Code to mount the folder of your project
      - ..:/workspace:cached
    environment:
      # CosmosDB Configuration
      COSMOSDB_ENDPOINT: http://localhost:8081
      COSMOSDB_KEY: C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==
      COSMOSDB_DATABASE: saas-management-dev
      COSMOSDB_MAX_RETRY_ATTEMPTS: 3
      COSMOSDB_RETRY_INTERVAL_MS: 1000

      # Node Environment
      NODE_ENV: development

      # JWT Configuration
      JWT_SECRET: dev-secret-key-not-for-production-use-only
      JWT_ALGORITHM: HS256
      JWT_EXPIRES_IN: 7200
      JWT_REFRESH_EXPIRES_IN: 604800
      JWT_ISSUER: saas-auth-service
      JWT_AUDIENCE: saas-app

      # Service Ports
      FRONTEND_PORT: 3000
      FRONTEND_URL: http://localhost:3000
      AUTH_SERVICE_PORT: 3001
      AUTH_SERVICE_URL: http://localhost:3001
      USER_MANAGEMENT_SERVICE_PORT: 3002
      USER_MANAGEMENT_SERVICE_URL: http://localhost:3002
      SERVICE_SETTINGS_SERVICE_PORT: 3003
      SERVICE_SETTINGS_SERVICE_URL: http://localhost:3003

      # Feature Flags
      FEATURE_USER_CREATE: enabled
      FEATURE_USER_EDIT: enabled
      FEATURE_USER_DELETE: enabled
      FEATURE_USER_ROLE_ASSIGN: enabled
      FEATURE_SERVICE_CREATE: enabled
      FEATURE_SERVICE_EDIT: enabled
      FEATURE_SERVICE_DELETE: enabled
      FEATURE_PASSWORD_RESET: enabled
      FEATURE_EMAIL_VERIFICATION: enabled
      FEATURE_TWO_FACTOR_AUTH: disabled
      FEATURE_ANALYTICS: disabled
      FEATURE_AUDIT_LOGGING: enabled
      FEATURE_RATE_LIMITING: enabled

      # Logging
      LOG_LEVEL: debug
      LOG_FORMAT: json
      LOG_FILE_PATH: ""

      # CORS
      CORS_ORIGINS: http://localhost:3000,http://localhost:5173,http://localhost:5174

      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX_REQUESTS: 1000

      # Tenant
      DEFAULT_TENANT_ID: dev-tenant

      # Security
      PASSWORD_MIN_LENGTH: 6
      PASSWORD_REQUIRE_UPPERCASE: false
      PASSWORD_REQUIRE_LOWERCASE: true
      PASSWORD_REQUIRE_NUMBERS: false
      PASSWORD_REQUIRE_SPECIAL_CHARS: false
      SESSION_TIMEOUT_MINUTES: 60
      MAX_LOGIN_ATTEMPTS: 10
      LOCKOUT_DURATION_MINUTES: 5
    networks:
      - devcontainer-network

  cosmosdb:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
    container_name: cosmosdb-emulator
    mem_limit: 3g
    cpus: 2.0
    tty: true
    environment:
      AZURE_COSMOS_EMULATOR_PARTITION_COUNT: 10
      AZURE_COSMOS_EMULATOR_ENABLE_DATA_PERSISTENCE: "true"
      AZURE_COSMOS_EMULATOR_IP_ADDRESS_OVERRIDE: 0.0.0.0
      AZURE_COSMOS_EMULATOR_ARGS: "/DisableRateLimiting /PartitionCount=10"
    ports:
      - "8081:8081"
      - "10250-10255:10250-10255"
    volumes:
      - cosmosdb-data:/tmp/cosmos/appdata
    networks:
      - devcontainer-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

networks:
  devcontainer-network:
    driver: bridge

volumes:
  cosmosdb-data:
